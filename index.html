<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Form Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --surface: #ffffff;
            --surface-alt: #f3f4f6;
            --border: #e5e7eb;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --sidebar-width: 260px;
            --props-width: 300px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #f9fafb;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }

        /* HEADER */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            z-index: 10;
        }

        .brand {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            border-color: var(--border);
            background: white;
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: var(--surface-alt);
        }

        /* MAIN LAYOUT */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR (TOOLS) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface-alt);
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--surface);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .portal-config-panel {
            padding: 1rem;
        }

        .portal-item-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--surface-alt);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .tool-category {
            padding: 1rem;
        }

        .category-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .tool-item {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }

        .tool-item:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .tool-item svg {
            width: 20px;
            height: 20px;
            color: var(--text-light);
        }

        /* CANVAS */
        .canvas-area {
            flex: 1;
            background: #e5e5f7;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 2rem;
            overflow: auto;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .canvas {
            width: 794px;
            /* A4 width approx */
            height: 1123px;
            /* A4 height approx */
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .canvas.show-grid {
            background-size: 20px 20px;
            background-image:
                linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
        }

        /* RULERS */
        .ruler-h {
            position: absolute;
            top: -25px;
            left: 0;
            height: 25px;
            width: 100%;
            background: #fff;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            display: flex;
        }

        .ruler-v {
            position: absolute;
            left: -25px;
            top: 0;
            width: 25px;
            height: 100%;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tick {
            position: absolute;
            background: #999;
            font-size: 8px;
            color: #555;
            pointer-events: none;
        }

        .tick-h {
            bottom: 0;
            border-left: 1px solid #ccc;
        }

        .tick-h.major {
            height: 100%;
            border-left: 1px solid #777;
            font-weight: bold;
        }

        .tick-h.minor {
            height: 5px;
        }

        .tick-h span {
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .tick-v {
            right: 0;
            border-top: 1px solid #ccc;
        }

        .tick-v.major {
            width: 100%;
            border-top: 1px solid #777;
            font-weight: bold;
        }

        .tick-v.minor {
            width: 5px;
        }

        .tick-v span {
            position: absolute;
            bottom: 2px;
            left: 2px;
            transform: rotate(-90deg);
            transform-origin: 0 100%;
            white-space: nowrap;
        }

        .canvas-element {
            position: absolute;
            border: 1px dashed transparent;
            cursor: pointer;
            padding: 4px;
        }

        .canvas-element:hover {
            border-color: var(--primary);
        }

        .canvas-element.selected {
            border: 2px solid var(--primary);
            z-index: 10;
            cursor: move;
        }

        /* COMPONENT STYLES PREVIEW */
        .preview-field {
            pointer-events: none;
        }

        .preview-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
        }

        .preview-input {
            width: 200px;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #fff;
        }

        .preview-shape {
            background: #e2e8f0;
        }

        /* PROPERTIES PANEL */
        .properties-panel {
            width: var(--props-width);
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .props-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .props-content {
            padding: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--text-main);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-family: inherit;
        }

        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .toggle-switch input {
            width: auto;
        }

        .hidden {
            display: none;
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #loader.hidden {
            display: none !important;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .template-list {
            list-style: none;
            padding: 0;
        }

        .template-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .template-item:hover {
            background: var(--surface-alt);
        }

        .template-info {
            display: flex;
            flex-direction: column;
        }

        .template-name {
            font-weight: 600;
        }

        .template-date {
            font-size: 0.75rem;
            color: var(--text-light);
        }
    </style>
</head>

<body>

    <!-- LOADING OVERLAY -->
    <div id="loader" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- HEADER -->
    <header>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                Dynamic Builder
            </div>
            <button class="btn btn-outline" onclick="createNewForm()"
                style="border-color: var(--primary); color: var(--primary); background: #eff6ff;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Form
            </button>
        </div>

        <div class="form-title-area" style="text-align: center; flex: 1; max-width: 400px; margin: 0 1rem;">
            <input type="text" id="headerFormNameInput" placeholder="Enter Form Name..."
                style="width: 100%; border: none; border-bottom: 2px solid transparent; text-align: center; font-size: 1.1rem; font-weight: 600; color: var(--primary); padding: 4px; transition: border-color 0.2s; background: transparent;"
                onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='transparent'">
            <div id="headerFormId" style="font-size: 0.65rem; color: var(--text-light); margin-top: 2px; opacity: 0.7;">
                Form_ID</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="showLoadModal()"
                style="background: #f8fafc; border-color: #cbd5e1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Load Form
            </button>
            <button class="btn btn-outline" onclick="showEmbedModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                </svg>
                Get Embed Code
            </button>
            <button class="btn btn-outline" onclick="switchSidebarTab('portal')"
                style="background: #fff7ed; border-color: #fed7aa; color: #9a3412;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Portal Designer
            </button>
            <button class="btn btn-outline" onclick="openPreview()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Preview
            </button>
            <button class="btn" onclick="openPortalWithApi()"
                style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                Launch Portal
            </button>
            <button class="btn btn-primary" onclick="saveForm()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <line x1="7" y1="3" x2="7" y2="8"></line>
                    <polyline points="15 3 15 8 7 8"></polyline>
                </svg>
                Save Form
            </button>
        </div>
    </header>

    <!-- LOAD MODAL -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Load Existing Form</h3>
                <span class="close-modal" onclick="closeLoadModal()">&times;</span>
            </div>
            <div id="modalLoading" class="hidden">Loading templates...</div>
            <ul id="templateList" class="template-list">
                <!-- Templates will be listed here -->
            </ul>
        </div>
    </div>

    <!-- EMBED MODAL -->
    <div id="embedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Embed This Form</h3>
                <span class="close-modal" onclick="closeEmbedModal()">&times;</span>
            </div>
            <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">
                Copy the code below and paste it into any website where you want the form to appear.
            </p>
            <textarea id="embedCodeArea" rows="6" readonly
                style="width: 100%; padding: 0.75rem; font-family: monospace; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 4px; background: #f8f9fa; margin-bottom: 1rem;"></textarea>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyEmbedCode()">
                Copy to Clipboard
            </button>
        </div>
    </div>

    <div class="workspace">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchSidebarTab('elements')">Elements</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('portal')">Portal View</div>
            </div>

            <div class="sidebar-content">
                <!-- ELEMENTS TAB -->
                <div id="panelElements" class="tab-panel active">
                    <div class="tool-category">
                        <div class="category-title">Input Fields</div>
                        <div class="tool-grid">
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="text">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
                                    <line x1="12" y1="22" x2="12" y2="2"></line>
                                </svg>
                                <span>Text</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="date">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span>Date</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="number">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                    </path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                                <span>Number</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="file">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <span>File</span>
                            </div>
                        </div>
                    </div>

                    <div class="tool-category">
                        <div class="category-title">Cosmetics</div>
                        <div class="tool-grid">
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="heading">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M4 12h8"></path>
                                    <path d="M4 6h16"></path>
                                    <path d="M4 18h8"></path>
                                </svg>
                                <span>Heading</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                                <span>Label</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="rect">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                </svg>
                                <span>Box</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="line">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>Line</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PORTAL DESIGNER TAB -->
                <div id="panelPortal" class="tab-panel">
                    <div class="portal-config-panel">
                        <div class="category-title">Portal Navigation Designer</div>
                        <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 1rem;">
                            Pick forms for your portal sidebar and set their order.
                        </p>

                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-outline"
                                style="width:100%; justify-content:center; font-size:0.75rem;"
                                onclick="refreshPortalList()">
                                ↻ Refresh Forms List
                            </button>
                        </div>

                        <div id="sidebarPortalList"
                            style="max-height: 450px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; background: var(--surface-alt);">
                            <!-- List of forms with checkboxes and order inputs -->
                            <div style="color:var(--text-light); font-size:0.8rem; text-align:center; padding:2rem;">
                                Click Refresh to load forms...
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-primary" id="btnSavePortal"
                                style="width:100%; justify-content:center;" onclick="savePortalSettings()">
                                Save Portal Collection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CANVAS -->
        <main class="canvas-area" id="canvasArea" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
            <div id="formCanvas" class="canvas show-grid">
                <div class="ruler-h" id="rulerTop"></div>
                <div class="ruler-v" id="rulerLeft"></div>
                <!-- Elements will be dropped here -->
            </div>
        </main>

        <!-- PROPERTIES PANEL -->
        <aside class="properties-panel">
            <div class="props-header">Configuration</div>

            <div id="globalProps" class="props-content">
                <div class="category-title">Form Settings</div>
                <div class="form-group">
                    <label>Form Name (Display)</label>
                    <input type="text" id="propFormName" placeholder="e.g. Donation Form">
                </div>
                <div class="form-group">
                    <label>Form ID (System Key)</label>
                    <input type="text" id="propFormId" readonly
                        style="background: var(--surface-alt); color: var(--text-light); border-style: dashed;">
                </div>
                <div class="form-group">
                    <label>Form Description</label>
                    <textarea id="propDescription" rows="2"
                        placeholder="Describe the purpose of this form..."></textarea>
                </div>
                <div class="form-group">
                    <label>Target Sheet URL</label>
                    <textarea id="propSheetUrl" rows="2"
                        placeholder="https://docs.google.com/spreadsheets/d/..."></textarea>
                </div>
                <div class="form-group">
                    <label>Target Sheet Name</label>
                    <input type="text" id="propSheetName" placeholder="e.g. Data">
                </div>
                <div class="form-group">
                    <label>Primary Language (User Inputs)</label>
                    <select id="propLanguagePrimary" onchange="updateFormLanguage()">
                        <option value="en">English (English)</option>
                        <option value="mr">Marathi (Marathi)</option>
                        <option value="hi">Hindi (Hindi)</option>
                        <option value="gu">Gujarati (Gujarati)</option>
                        <option value="kn">Kannada (Kannada)</option>
                        <option value="ta">Tamil (Tamil)</option>
                        <option value="te">Telugu (Telugu)</option>
                        <option value="bn">Bengali (Bengali)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Secondary Language (Translates To)</label>
                    <select id="propLanguageSecondary" onchange="updateFormLanguage()">
                        <option value="mr">Marathi (Marathi)</option>
                        <option value="en">English (English)</option>
                        <option value="hi">Hindi (Hindi)</option>
                        <option value="gu">Gujarati (Gujarati)</option>
                        <option value="kn">Kannada (Kannada)</option>
                        <option value="ta">Tamil (Tamil)</option>
                        <option value="te">Telugu (Telugu)</option>
                        <option value="bn">Bengali (Bengali)</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-outline"
                        style="width: 100%; border-color: var(--primary); color: var(--primary);"
                        onclick="swapAllLabels()">
                        Swap L1 ⇄ L2 Labels (Move Text)
                    </button>
                    <small style="font-size: 0.7rem; color: #666; margin-top: 4px; display: block;">
                        * This will move all secondary labels to primary and vice-versa.
                    </small>
                </div>
                <div class="form-group">
                    <label>Allowed Domains (Security)</label>
                    <input type="text" id="propAllowedDomains" placeholder="google.com, example.org">
                    <small style="font-size: 0.7rem; color: var(--text-light);">Comma-separated. Leave empty to allow
                        all.</small>
                </div>
                <div class="form-group">
                    <label>GAS API URL (Required for External Hosting)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="propApiUrl" placeholder="https://script.google.com/macros/s/.../exec"
                            style="flex: 1;">
                        <button class="btn btn-outline" onclick="testApiConnection()"
                            style="padding: 0.5rem;">Test</button>
                    </div>
                    <small style="font-size: 0.7rem; color: var(--text-light);">Required if hosted on GitHub Pages or
                        locally.</small>
                </div>
            </div>

            <div id="elementProps" class="props-content hidden">
                <div class="category-title">Element Properties</div>
                <div class="form-group">
                    <label id="lblPropPrimary">Field Label (Primary)</label>
                    <input type="text" id="propLabel" oninput="updateSelectedElement()">
                </div>
                <div class="form-group">
                    <label id="lblPropSecondary">Field Label (Secondary)</label>
                    <input type="text" id="propLabelRegional" oninput="updateSelectedElement()">
                </div>
                <div class="form-group">
                    <label>Field Name (DB Key)</label>
                    <input type="text" id="propName" oninput="updateSelectedElement()">
                </div>

                <!-- Dynamic Options based on type -->
                <div class="form-group toggle-group">
                    <label>Required</label>
                    <input type="checkbox" id="propRequired" onchange="updateSelectedElement()">
                </div>

                <div class="form-group toggle-group">
                    <label id="lblPropTranslatable">Enable Translation (English -> Marathi)</label>
                    <input type="checkbox" id="propTranslatable" onchange="updateSelectedElement()">
                </div>

                <!-- STYLE PROPERTIES -->
                <div class="form-group" id="grpHeadingLevel">
                    <label>Heading Level</label>
                    <select id="propHeadingLevel" onchange="updateSelectedElement()">
                        <option value="h1">H1 (Huge)</option>
                        <option value="h2">H2 (Large)</option>
                        <option value="h3">H3 (Medium)</option>
                        <option value="h4">H4 (Small)</option>
                    </select>
                </div>

                <div class="form-group" id="grpAlign">
                    <label>Alignment</label>
                    <select id="propAlign" onchange="updateSelectedElement()">
                        <option value="left">Left</option>
                        <option value="center">Center</option>
                        <option value="right">Right</option>
                    </select>
                </div>

                <div class="form-group" id="grpFontSize">
                    <label>Font Size (px)</label>
                    <input type="number" id="propFontSize" oninput="updateSelectedElement()">
                </div>

                <div class="form-group toggle-group" id="grpBold">
                    <label>Bold Text</label>
                    <input type="checkbox" id="propBold" onchange="updateSelectedElement()">
                </div>

                <!-- VISUAL STYLE PROPERTIES -->
                <div class="form-group" id="grpStrokeWidth">
                    <label>Thickness (px)</label>
                    <input type="number" id="propStrokeWidth" min="1" max="20" oninput="updateSelectedElement()">
                </div>

                <div class="form-group" id="grpBorderStyle">
                    <label>Style</label>
                    <select id="propBorderStyle" onchange="updateSelectedElement()">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                    </select>
                </div>

                <div class="form-group" id="grpBorderRadius">
                    <label>Corner Radius (px)</label>
                    <input type="number" id="propBorderRadius" min="0" max="100" oninput="updateSelectedElement()">
                </div>

                <hr style="border: 0; border-top: 1px solid var(--border); margin: 1rem 0;">

                <div class="form-group">
                    <label>Position X (px)</label>
                    <input type="number" id="propX" oninput="updatePosFromInputs()">
                </div>
                <div class="form-group">
                    <label>Position Y (px)</label>
                    <input type="number" id="propY" oninput="updatePosFromInputs()">
                </div>
                <div class="form-group">
                    <button class="btn btn-outline" style="width: 100%; justify-content: center; margin-bottom: 0.5rem;"
                        onclick="duplicateSelected()">
                        Duplicate Element
                    </button>
                    <button class="btn btn-outline"
                        style="color: var(--danger); border-color: var(--danger); width: 100%; justify-content: center;"
                        onclick="deleteSelected()">
                        Delete Element
                    </button>
                </div>

                <div class="form-group">
                    <button class="btn btn-outline" style="width: 100%; justify-content: center;"
                        onclick="showGlobalProps()">
                        &larr; Back to Form Settings
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- MAIN BUILDER LOGIC -->
    <script>
        // API Helper Function
        async function callApi(action, payload) {
            // Check if running in Google Apps Script environment
            if (typeof google !== 'undefined' && google.script) {
                return new Promise((resolve, reject) => {
                    const run = google.script.run;
                    run.withSuccessHandler(resolve).withFailureHandler(reject);

                    if (action === 'saveForm') {
                        run.saveForm(payload.formId, payload.schema, payload.config, payload.metadata);
                    } else if (action === 'getForm') {
                        run.getForm(payload.formId);
                    } else if (action === 'listTemplates') {
                        run.listTemplates();
                    } else if (action === 'getPortalConfig') {
                        run.getPortalConfig();
                    } else if (action === 'savePortalConfig') {
                        run.savePortalConfig(payload.config);
                    } else {
                        reject({ status: 'error', message: 'Unknown action: ' + action });
                    }
                });
            }

            // Standalone mode - use fetch with GAS URL
            const gasApiUrl = formConfig.gasApiUrl || localStorage.getItem('gasApiUrl') || '';
            if (!gasApiUrl) {
                return { status: 'error', message: 'GAS API URL not configured. Please set it in Settings.' };
            }

            try {
                const url = gasApiUrl.trim().replace(/\/$/, "");
                const sep = url.includes('?') ? '&' : '?';

                if (action === 'getForm') {
                    const res = await fetch(`${url}${sep}action=getForm&id=${payload.formId}`);
                    return await res.json();
                } else if (action === 'listTemplates') {
                    const res = await fetch(`${url}${sep}action=listTemplates`);
                    return await res.json();
                } else if (action === 'getPortalConfig') {
                    const res = await fetch(`${url}${sep}action=getPortalConfig`);
                    return await res.json();
                } else if (action === 'saveForm' || action === 'savePortalConfig') {
                    // POST actions
                    const res = await fetch(url, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...payload })
                    });
                    // no-cors mode doesn't return response, so assume success
                    return { status: 'success', message: 'Data sent successfully (no-cors mode)' };
                }
            } catch (err) {
                console.error("API Call failed:", err);
                return { status: 'error', message: 'Connection Error: ' + err.toString() };
            }
        }

        // STATE
        let elements = []; // Array of { id, type, x, y, props }
        let selectedIds = []; // Array of strings
        let formConfig = {
            id: 'Form_' + Date.now(),
            formName: 'New Form',
            description: '',
            allowedDomains: '',
            sheetUrl: '',
            sheetName: 'Form Responses',
            language: 'mr', // Legacy field for compat
            languagePrimary: 'en',
            languageSecondary: 'mr',
            gasApiUrl: localStorage.getItem('gasApiUrl') || ''
        };

        // DOM REFERENCES
        const canvas = document.getElementById('formCanvas');
        const elmPropsPanel = document.getElementById('elementProps');
        const globalPropsPanel = document.getElementById('globalProps');

        // INIT
        document.getElementById('propFormId').value = formConfig.id;
        document.getElementById('headerFormId').innerText = formConfig.id;
        document.getElementById('propFormName').value = formConfig.formName;
        document.getElementById('headerFormNameInput').value = formConfig.formName;

        // Sync both name inputs works on either update
        function syncFormName(val, source) {
            formConfig.formName = val;
            if (source !== 'header') document.getElementById('headerFormNameInput').value = val;
            if (source !== 'props') document.getElementById('propFormName').value = val;
        }

        document.getElementById('propFormName').addEventListener('input', (e) => syncFormName(e.target.value, 'props'));
        document.getElementById('headerFormNameInput').addEventListener('input', (e) => syncFormName(e.target.value, 'header'));

        document.getElementById('propDescription').addEventListener('input', (e) => formConfig.description = e.target.value);
        document.getElementById('propAllowedDomains').addEventListener('input', (e) => formConfig.allowedDomains = e.target.value);
        document.getElementById('propSheetUrl').addEventListener('input', (e) => formConfig.sheetUrl = e.target.value);
        document.getElementById('propSheetName').addEventListener('input', (e) => formConfig.sheetName = e.target.value);
        document.getElementById('propLanguagePrimary').value = formConfig.languagePrimary;
        document.getElementById('propLanguageSecondary').value = formConfig.languageSecondary;
        document.getElementById('propApiUrl').value = formConfig.gasApiUrl;
        document.getElementById('propApiUrl').addEventListener('input', (e) => {
            formConfig.gasApiUrl = e.target.value;
            localStorage.setItem('gasApiUrl', e.target.value);
        });

        // --- SIDEBAR TABS ---
        function switchSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            if (tab === 'elements') {
                document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
                document.getElementById('panelElements').classList.add('active');
            } else {
                document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
                document.getElementById('panelPortal').classList.add('active');
                refreshPortalList();
            }
        }

        async function refreshPortalList() {
            const listEl = document.getElementById('sidebarPortalList');
            listEl.innerHTML = '<div style="text-align:center; padding:1rem;">Loading...</div>';

            try {
                const [templates, config] = await Promise.all([
                    callApi('listTemplates', {}),
                    callApi('getPortalConfig', {})
                ]);

                allTemplates = templates;
                portalConfig = config || { forms: [] };
                renderPortalItemsInSidebar();
            } catch (err) {
                listEl.innerHTML = '<div style="color:red; font-size:0.8rem;">Error loading forms.</div>';
            }
        }

        function renderPortalItemsInSidebar() {
            const listEl = document.getElementById('sidebarPortalList');
            if (!allTemplates || allTemplates.length === 0) {
                listEl.innerHTML = '<div style="padding:1rem; color:#999; font-size:0.8rem;">No saved forms found.</div>';
                return;
            }

            listEl.innerHTML = allTemplates.map(t => {
                const portalItem = portalConfig.forms.find(pf => pf.id === t.id);
                const isSelected = !!portalItem;
                const order = portalItem ? portalItem.order : 0;

                return `
                    <div style="display:flex; flex-direction:column; gap:0.25rem; background:white; border:1px solid var(--border); padding:0.5rem; border-radius:4px; margin-bottom:0.5rem;">
                        <label style="display:flex; align-items:center; gap:0.5rem; font-weight:600; cursor:pointer; font-size:0.8rem;">
                            <input type="checkbox" class="portal-check" data-id="${t.id}" data-name="${t.name}" ${isSelected ? 'checked' : ''}>
                            ${t.name}
                        </label>
                        <div style="display:flex; align-items:center; justify-content:space-between; font-size:0.7rem; color:var(--text-light);">
                            <span>ID: ${t.id}</span>
                            <div style="display:flex; align-items:center; gap:4px;">
                                Order: <input type="number" class="portal-order" data-id="${t.id}" value="${order}" style="width:40px; border:1px solid var(--border); text-align:center;">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFormLanguage() {
            formConfig.languagePrimary = document.getElementById('propLanguagePrimary').value;
            formConfig.languageSecondary = document.getElementById('propLanguageSecondary').value;
            formConfig.language = formConfig.languageSecondary; // Sync for compat

            const l1Name = document.getElementById('propLanguagePrimary').selectedOptions[0].text.split(' ')[0];
            const l2Name = document.getElementById('propLanguageSecondary').selectedOptions[0].text.split(' ')[0];

            document.getElementById('lblPropPrimary').innerText = `Field Label (${l1Name})`;
            document.getElementById('lblPropSecondary').innerText = `Field Label (${l2Name})`;
            document.getElementById('lblPropTranslatable').innerText = `Enable Translation (${l1Name} -> ${l2Name})`;

            // Trigger refresh of canvas elements to show new labels if needed
            elements.forEach(elm => {
                const dom = document.getElementById(elm.id);
                if (dom) renderElementVisual(elm, dom);
            });
        }


        // --- DRAG AND DROP (SIDEBAR TO CANVAS) ---
        function handleDragStart(e) {
            e.dataTransfer.setData("type", e.target.dataset.type);
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const type = e.dataTransfer.getData("type");
            if (!type) return; // Might be internal move

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            addElement(type, x, y);
        }

        // --- INTERNAL DRAG (POSITIONING) ---
        // We'll implement a simple mousedown/move/up for the absolute positioned elements
        // Attached in render logic

        // --- CORE LOGIC ---
        function addElement(type, x, y) {
            const id = 'elm_' + Date.now();
            const newElm = {
                id: id,
                type: type,
                x: x,
                y: y,
                props: {
                    label: type === 'rect' || type === 'line' ? '' : 'New ' + type,
                    name: type + '_' + Math.floor(Math.random() * 1000),
                    required: false,
                    translatable: type === 'text',
                    width: 200,
                    height: type === 'rect' ? 100 : 40,
                    // Cosmetics
                    headingLevel: 'h2',
                    align: 'left',
                    fontSize: 14,
                    isBold: false,
                    // Shape Styles
                    strokeWidth: type === 'line' || type === 'rect' ? 2 : 0,
                    borderStyle: 'solid',
                    borderRadius: 0,
                    // Grouping
                    groupId: null
                }
            };
            elements.push(newElm);
            renderElementDOM(newElm);
            selectElement(id);
        }

        function renderElementDOM(elmData) {
            const div = document.createElement('div');
            div.id = elmData.id;
            div.className = 'canvas-element';
            div.style.left = elmData.x + 'px';
            div.style.top = elmData.y + 'px';

            // Content based on type
            let content = '';
            if (['text', 'date', 'number', 'file'].includes(elmData.type)) {
                content = `
                    <label class="preview-label">${elmData.props.label}${elmData.props.required ? '*' : ''}</label>
                    <div class="preview-input" style="height: 30px; background: #eee;"></div>
                `;
            } else if (elmData.type === 'heading') {
                div.style.width = '300px';
                // Dynamic Heading Tag
                const tag = elmData.props.headingLevel || 'h2';
                content = `<${tag} style="margin:0; border-bottom: 2px solid #333;">${elmData.props.label || 'Section Heading'}</${tag}>`;
            } else if (elmData.type === 'rect') {
                div.style.width = elmData.props.width + 'px';
                div.style.height = elmData.props.height + 'px';
                // Apply Styles
                div.style.border = `${elmData.props.strokeWidth || 2}px ${elmData.props.borderStyle || 'solid'} #000`;
                div.style.borderRadius = (elmData.props.borderRadius || 0) + 'px';
                div.style.background = 'transparent';
            } else if (elmData.type === 'line') {
                div.style.width = '200px';
                // Line Implementation: Height = Clickable Area, Visual = Border Top
                div.style.height = (elmData.props.strokeWidth || 2) + 10 + 'px'; // Add padding for easier click
                div.style.borderTop = `${elmData.props.strokeWidth || 2}px ${elmData.props.borderStyle || 'solid'} #000`;
                div.style.background = 'transparent';
            } else if (elmData.type === 'label') {
                content = `<span style="font-weight:${elmData.props.isBold ? 'bold' : 'normal'}; font-size:${elmData.props.fontSize || 14}px">${elmData.props.label || 'Label Text'}</span>`;
            }

            div.innerHTML = content;
            div.style.textAlign = elmData.props.align || 'left';

            // Mouse Interaction handled globally
            // div.onmousedown = (e) => startDragElement(e, elmData.id);

            canvas.appendChild(div);
        }

        // Modified Selection Logic
        function selectElement(id, multiSelect = false) {
            const targetElm = elements.find(e => e.id === id);
            if (!targetElm) return;

            // 1. Group Logic: If target is part of a group, select the WHOLE group
            let idsToSelect = [id];
            if (targetElm.props.groupId) {
                idsToSelect = elements.filter(e => e.props.groupId === targetElm.props.groupId).map(e => e.id);
            }

            // 2. Multi-Select Logic (Shift)
            if (multiSelect) {
                idsToSelect.forEach(newId => {
                    if (!selectedIds.includes(newId)) selectedIds.push(newId);
                });
            } else {
                selectedIds = idsToSelect; // Replace selection
            }

            renderSelectionState();
            updatePropsPanel();
        }

        function renderSelectionState() {
            document.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));
            selectedIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('selected');
            });
        }

        function updatePropsPanel() {
            if (selectedIds.length === 0) {
                showGlobalProps();
                return;
            }

            if (selectedIds.length > 1) {
                // Multi-selection: Show Summary
                elmPropsPanel.classList.remove('hidden');
                globalPropsPanel.classList.add('hidden');
            } else {
                // Single Selection (or First of Multi)
                globalPropsPanel.classList.add('hidden');
                elmPropsPanel.classList.remove('hidden');

                const id = selectedIds[0];
                const elm = elements.find(e => e.id === id);

                document.getElementById('propLabel').value = elm.props.label || '';
                document.getElementById('propLabelRegional').value = elm.props.labelRegional || '';
                document.getElementById('propName').value = elm.props.name || '';
                document.getElementById('propRequired').checked = elm.props.required;
                document.getElementById('propTranslatable').checked = elm.props.translatable;
                document.getElementById('propX').value = elm.x;
                document.getElementById('propY').value = elm.y;

                // Handle Visibility of Style Props
                const t = elm.type;
                const setDisplay = (id, show) => document.getElementById(id).style.display = show ? 'block' : 'none';
                const setDisplayFlex = (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none';

                setDisplay('grpHeadingLevel', t === 'heading');
                setDisplay('grpAlign', t === 'heading' || t === 'label');
                setDisplay('grpFontSize', t === 'label');
                setDisplayFlex('grpBold', t === 'label');

                // Shape Styles Visibility
                const isShape = t === 'rect' || t === 'line';
                setDisplay('grpStrokeWidth', isShape);
                setDisplay('grpBorderStyle', isShape);
                setDisplay('grpBorderRadius', t === 'rect');

                // Set Values
                document.getElementById('propHeadingLevel').value = elm.props.headingLevel || 'h2';
                document.getElementById('propAlign').value = elm.props.align || 'left';
                document.getElementById('propFontSize').value = elm.props.fontSize || 14;
                document.getElementById('propBold').checked = elm.props.isBold || false;

                document.getElementById('propStrokeWidth').value = elm.props.strokeWidth || 2;
                document.getElementById('propBorderStyle').value = elm.props.borderStyle || 'solid';
                document.getElementById('propBorderRadius').value = elm.props.borderRadius || 0;
            }
        }

        function showGlobalProps() {
            selectedIds = [];
            renderSelectionState();
            elmPropsPanel.classList.add('hidden');
            globalPropsPanel.classList.remove('hidden');
        }

        // SINGLE ELEMENT UPDATE (Only when 1 selected)
        function updateSelectedElement() {
            if (selectedIds.length !== 1) return;
            const selectedId = selectedIds[0];
            const elm = elements.find(e => e.id === selectedId);

            elm.props.label = document.getElementById('propLabel').value;
            elm.props.labelRegional = document.getElementById('propLabelRegional').value;
            elm.props.name = document.getElementById('propName').value;
            elm.props.required = document.getElementById('propRequired').checked;
            elm.props.translatable = document.getElementById('propTranslatable').checked;

            // Style Props
            elm.props.headingLevel = document.getElementById('propHeadingLevel').value;
            elm.props.align = document.getElementById('propAlign').value;
            elm.props.fontSize = document.getElementById('propFontSize').value;
            elm.props.isBold = document.getElementById('propBold').checked;

            // Shape Props
            elm.props.strokeWidth = parseInt(document.getElementById('propStrokeWidth').value) || 2;
            elm.props.borderStyle = document.getElementById('propBorderStyle').value;
            elm.props.borderRadius = parseInt(document.getElementById('propBorderRadius').value) || 0;

            // Re-render visual content roughly
            const dom = document.getElementById(selectedId);
            if (dom) renderElementVisual(elm, dom);
        }

        function renderElementVisual(elm, dom) {
            const separator = (elm.props.label && elm.props.labelRegional) ? ' / ' : '';
            const regLabel = elm.props.labelRegional ? separator + elm.props.labelRegional : '';

            // Update Base Styles
            dom.style.textAlign = elm.props.align || 'left';

            if (['text', 'date', 'number', 'file'].includes(elm.type)) {
                dom.querySelector('.preview-label').innerHTML = elm.props.label + regLabel + (elm.props.required ? '*' : '');
            } else if (elm.type === 'heading') {
                const hTag = document.createElement(elm.props.headingLevel || 'h2');
                hTag.style.margin = '0';
                hTag.style.borderBottom = '2px solid #333';
                hTag.innerText = elm.props.label + regLabel;
                dom.innerHTML = '';
                dom.appendChild(hTag);
            } else if (elm.type === 'label') {
                const fSize = elm.props.fontSize || 14;
                dom.innerHTML = `<span style="font-weight:${elm.props.isBold ? 'bold' : 'normal'}; font-size: ${fSize}px">${elm.props.label}${regLabel}</span>`;
            } else if (elm.type === 'rect') {
                dom.style.border = `${elm.props.strokeWidth}px ${elm.props.borderStyle} #000`;
                dom.style.borderRadius = `${elm.props.borderRadius}px`;
            } else if (elm.type === 'line') {
                dom.style.borderTop = `${elm.props.strokeWidth}px ${elm.props.borderStyle} #000`;
                dom.style.height = (elm.props.strokeWidth + 10) + 'px'; // Update click area
            }
        }


        function duplicateSelected() {
            if (selectedIds.length === 0) return;

            const groupMap = {};
            const newIds = [];

            selectedIds.forEach(oldId => {
                const original = elements.find(e => e.id === oldId);
                if (!original) return;

                const newElm = JSON.parse(JSON.stringify(original));
                newElm.id = 'elm_' + Date.now() + '_' + Math.floor(Math.random() * 100);
                newElm.x += 20;
                newElm.y += 20;

                if (newElm.props.name) {
                    newElm.props.name = newElm.props.name.split('_copy')[0] + '_copy_' + Math.floor(Math.random() * 100);
                }

                // Group Remapping
                if (newElm.props.groupId) {
                    if (!groupMap[newElm.props.groupId]) {
                        groupMap[newElm.props.groupId] = 'grp_' + Date.now() + '_' + Math.random();
                    }
                    newElm.props.groupId = groupMap[newElm.props.groupId];
                }

                elements.push(newElm);
                renderElementDOM(newElm);
                newIds.push(newElm.id);
            });

            selectedIds = newIds;
            renderSelectionState();
            updatePropsPanel();
        }

        function deleteSelected() {
            if (selectedIds.length === 0) return;
            selectedIds.forEach(id => {
                const dom = document.getElementById(id);
                if (dom) dom.remove();
                elements = elements.filter(e => e.id !== id);
            });
            showGlobalProps();
        }

        // --- ELEMENT DRAGGING LOGIC ---
        let activeDrag = null;

        // Global Mouse Controllers
        window.addEventListener('mousedown', (e) => {
            // HANDLE CANVAS ELEMENT CLICK (SELECT & PREPARE DRAG)
            const target = e.target.closest('.canvas-element');
            if (target) {
                e.preventDefault(); // Prevent text selection
                const id = target.id;

                // Select Logic (Shift key?)
                selectElement(id, e.shiftKey);

                // Prepare Drag for ALL Selected Items
                // Calculate offsets for ALL items relative to mouse
                const canvasRect = canvas.getBoundingClientRect();

                const dragMap = {};
                selectedIds.forEach(selId => {
                    const el = elements.find(el => el.id === selId);
                    const elDOM = document.getElementById(selId);
                    if (el && elDOM) {
                        const rect = elDOM.getBoundingClientRect();
                        dragMap[selId] = {
                            offsetX: e.clientX - rect.left,
                            offsetY: e.clientY - rect.top
                        };
                        elDOM.style.cursor = 'grabbing';
                    }
                });

                activeDrag = {
                    canvasX: canvasRect.left,
                    canvasY: canvasRect.top,
                    dragMap: dragMap // ID -> {offsetX, offsetY}
                };
                return;
            }

            // HANDLE CLICK OUTSIDE (DESELECT)
            // If we clicked on Sidebar, Properties, or Header, do nothing
            if (e.target.closest('.sidebar') ||
                e.target.closest('.properties-panel') ||
                e.target.closest('header')) {
                return;
            }

            // Otherwise (e.g. empty canvas area), deselect
            showGlobalProps();
        });

        window.addEventListener('mousemove', (e) => {
            if (activeDrag) {
                // Move ALL selected items
                selectedIds.forEach(id => {
                    const offset = activeDrag.dragMap[id];
                    if (!offset) return;

                    const rawX = e.clientX - activeDrag.canvasX - offset.offsetX;
                    const rawY = e.clientY - activeDrag.canvasY - offset.offsetY;

                    // Snap to grid
                    const snappedX = Math.round(rawX / 10) * 10;
                    const snappedY = Math.round(rawY / 10) * 10;

                    // Update DOM
                    const dom = document.getElementById(id);
                    if (dom) {
                        dom.style.left = snappedX + 'px';
                        dom.style.top = snappedY + 'px';
                    }

                    // Update Model
                    const elm = elements.find(el => el.id === id);
                    if (elm) {
                        elm.x = snappedX;
                        elm.y = snappedY;
                    }
                });

                // Update Props Panel Live (only if single selection, else confusing)
                if (selectedIds.length === 1) {
                    const px = document.getElementById('propX');
                    const py = document.getElementById('propY');
                    const elm = elements.find(el => el.id === selectedIds[0]);
                    if (px && elm) px.value = elm.x;
                    if (py && elm) py.value = elm.y;
                }
            }
        });

        window.addEventListener('mouseup', () => {
            if (activeDrag) {
                selectedIds.forEach(selId => {
                    const elDOM = document.getElementById(selId);
                    if (elDOM) elDOM.style.cursor = ''; // Revert
                });
                activeDrag = null;
            }
        });

        // Manual Position Update from Inputs
        function updatePosFromInputs() {
            if (selectedIds.length !== 1) return;
            const id = selectedIds[0];
            const x = parseInt(document.getElementById('propX').value) || 0;
            const y = parseInt(document.getElementById('propY').value) || 0;

            const elm = elements.find(e => e.id === id);
            if (elm) {
                elm.x = x;
                elm.y = y;

                const dom = document.getElementById(id);
                if (dom) {
                    dom.style.left = x + 'px';
                    dom.style.top = y + 'px';
                }
            }
        }


        // --- API HELPER ---
        async function callApi(action, payload) {
            // Priority 1: google.script.run (if hosted on GAS)
            if (typeof google !== 'undefined' && google.script) {
                return new Promise((resolve, reject) => {
                    const run = google.script.run;
                    if (action === 'saveForm') run.withSuccessHandler(resolve).withFailureHandler(reject).saveForm(payload.formId, payload.schema, payload.config);
                    else if (action === 'getForm') run.withSuccessHandler(resolve).withFailureHandler(reject).getForm(payload.formId);
                    else if (action === 'listTemplates') run.withSuccessHandler(resolve).withFailureHandler(reject).listTemplates();
                    else if (action === 'getScriptUrl') run.withSuccessHandler(resolve).withFailureHandler(reject).getScriptUrl();
                    else if (action === 'getPortalConfig') run.withSuccessHandler(resolve).withFailureHandler(reject).getPortalConfig();
                    else if (action === 'savePortalConfig') run.withSuccessHandler(resolve).withFailureHandler(reject).savePortalConfig(payload.config);
                    else if (action === 'deleteForm') run.withSuccessHandler(resolve).withFailureHandler(reject).deleteForm(payload.formId);
                    else if (action === 'ping') run.withSuccessHandler(resolve).withFailureHandler(reject).ping();
                });
            }

            // Priority 2: fetch (if hosted externally, e.g. GitHub Pages)
            // Always pull latest from DOM just in case sync failed
            const apiUrl = document.getElementById('propApiUrl').value || formConfig.gasApiUrl;
            if (!apiUrl) {
                return { status: 'error', message: 'GAS API URL not configured in settings.' };
            }
            // Sync back to config
            formConfig.gasApiUrl = apiUrl;

            try {
                // Determine if we can use 'cors' (usually fails with GAS) or MUST use 'no-cors'
                // GAS ContentService supports CORS for GET, but POST is trickier.

                const postActions = ['saveForm', 'submitForm', 'translateText', 'savePortalConfig', 'deleteForm'];
                if (postActions.includes(action)) {
                    // Try standard POST first (likely to have opaque response)
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...payload })
                    });
                    // With 'no-cors', the response is opaque. We return a hint.
                    return { status: 'success', message: 'Payload sent. Check Drive for file.' };
                } else {
                    // GET actions (listTemplates, getForm, ping, getPortalConfig)
                    let url = `${apiUrl}?action=${action}`;
                    if (payload.formId) url += `&id=${payload.formId}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                    return await response.json();
                }
            } catch (err) {
                console.error("API Call Error:", err);
                return { status: 'error', message: 'Connection Error: ' + err.toString() };
            }
        }

        async function testApiConnection() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = '...';

            // Test 1: Simple GET Ping
            const res = await callApi('ping', {});

            btn.innerText = originalText;
            if (res.status === 'success') {
                alert("Success! " + (res.message || "API Connected"));
            } else {
                alert("Failed: " + (res.message || "Unknown Error") + "\n\n1. Ensure Web App is deployed as 'Anyone'.\n2. Ensure URL is correct.");
            }
        }

        // Modified saveForm to use helper
        async function saveForm() {
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            const schema = elements;
            const config = {
                formName: formConfig.formName || formConfig.id,
                targetSheetUrl: formConfig.sheetUrl,
                targetSheetName: formConfig.sheetName,
                language: formConfig.language
            };
            const metadata = {
                description: formConfig.description,
                allowedDomains: formConfig.allowedDomains
            };

            const res = await callApi('saveForm', { formId: formConfig.id, schema, config, metadata });

            btn.innerHTML = originalText;
            btn.disabled = false;
            if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                alert('Form Saved! (Check Drive/Sheet to confirm if external)');
            } else {
                alert('Error: ' + res.message);
            }
        }

        function openPreview() {
            const apiUrl = formConfig.gasApiUrl;
            if (typeof google !== 'undefined' && google.script) {
                google.script.run.withSuccessHandler(url => {
                    const finalUrl = url + '?view=form&id=' + formConfig.id;
                    window.open(finalUrl, '_blank');
                }).getScriptUrl();
                alert("Redirecting to preview... if window doesn't open, use the link from browser address bar with ?view=form&id=" + formConfig.id);
            } else {
                let previewUrl = `viewer.html?view=form&id=${formConfig.id}`;
                if (apiUrl) {
                    previewUrl += `&api=${encodeURIComponent(apiUrl)}`;
                }
                window.open(previewUrl, '_blank');
            }
        }

        // --- KEYBOARD SHORTCUTS ---
        let clipboard = null;
        window.addEventListener('keydown', handleShortcuts);

        function handleShortcuts(e) {
            const tag = e.target.tagName.toLowerCase();
            const isInput = tag === 'input' || tag === 'textarea' || tag === 'select';
            if (isInput) return;

            // GROUPING (Ctrl + G)
            if ((e.ctrlKey || e.metaKey) && e.key === 'g' && !e.shiftKey) {
                e.preventDefault();
                if (selectedIds.length > 1) {
                    const newGroupId = 'grp_' + Date.now();
                    selectedIds.forEach(id => {
                        const el = elements.find(item => item.id === id);
                        if (el) el.props.groupId = newGroupId;
                    });
                }
                return;
            }

            // UNGROUP (Ctrl + Shift + G)
            if ((e.ctrlKey || e.metaKey) && e.key === 'G') {
                e.preventDefault();
                if (selectedIds.length > 0) {
                    selectedIds.forEach(id => {
                        const el = elements.find(item => item.id === id);
                        if (el && el.props.groupId) {
                            el.props.groupId = null;
                        }
                    });
                }
                return;
            }

            // DELETE
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelected();
                return;
            }

            // COPY (Ctrl + C)
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                if (selectedIds.length > 0) {
                    clipboard = selectedIds.map(id => elements.find(item => item.id === id)).filter(Boolean);
                    clipboard = JSON.parse(JSON.stringify(clipboard));
                }
                return;
            }

            // PASTE (Ctrl + V)
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                if (clipboard && Array.isArray(clipboard)) {
                    const newIds = [];
                    const groupMap = {};
                    clipboard.forEach(original => {
                        const newElm = JSON.parse(JSON.stringify(original));
                        newElm.id = 'elm_' + Date.now() + '_' + Math.floor(Math.random() * 100);
                        newElm.x += 20;
                        newElm.y += 20;
                        if (newElm.props.name) {
                            newElm.props.name = newElm.props.name.split('_copy')[0] + '_copy_' + Math.floor(Math.random() * 100);
                        }
                        if (newElm.props.groupId) {
                            if (!groupMap[newElm.props.groupId]) {
                                groupMap[newElm.props.groupId] = 'grp_' + Date.now() + '_' + Math.random();
                            }
                            newElm.props.groupId = groupMap[newElm.props.groupId];
                        }
                        elements.push(newElm);
                        renderElementDOM(newElm);
                        newIds.push(newElm.id);
                    });
                    selectedIds = newIds;
                    renderSelectionState();
                    updatePropsPanel();
                }
                return;
            }

            // DUPLICATE (Ctrl + D)
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                duplicateSelected();
                return;
            }

            // BOLD (Ctrl + B)
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                selectedIds.forEach(id => {
                    const elm = elements.find(item => item.id === id);
                    if (elm && elm.type === 'label') {
                        elm.props.isBold = !elm.props.isBold;
                        const dom = document.getElementById(id);
                        if (dom) {
                            dom.querySelector('span').style.fontWeight = elm.props.isBold ? 'bold' : 'normal';
                        }
                    }
                });
                if (selectedIds.length === 1) {
                    const chk = document.getElementById('propBold');
                    const elm = elements.find(item => item.id === selectedIds[0]);
                    if (chk && elm) chk.checked = !!elm.props.isBold;
                }
                return;
            }

            // ARROW KEYS (Nudge)
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                if (selectedIds.length > 0) {
                    e.preventDefault();
                    const shift = e.shiftKey ? 10 : 1;
                    selectedIds.forEach(id => {
                        const elm = elements.find(item => item.id === id);
                        if (!elm) return;
                        if (e.key === 'ArrowUp') elm.y -= shift;
                        if (e.key === 'ArrowDown') elm.y += shift;
                        if (e.key === 'ArrowLeft') elm.x -= shift;
                        if (e.key === 'ArrowRight') elm.x += shift;
                        const dom = document.getElementById(id);
                        if (dom) {
                            dom.style.left = elm.x + 'px';
                            dom.style.top = elm.y + 'px';
                        }
                    });
                    if (selectedIds.length === 1) {
                        const px = document.getElementById('propX');
                        const py = document.getElementById('propY');
                        const elm = elements.find(item => item.id === selectedIds[0]);
                        if (px && elm) px.value = elm.x;
                        if (py && elm) py.value = elm.y;
                    }
                }
            }
        }

        // --- LOAD MODAL LOGIC ---
        function showLoadModal() {
            document.getElementById('loadModal').style.display = 'flex';
            fetchTemplates();
        }

        function closeLoadModal() {
            document.getElementById('loadModal').style.display = 'none';
        }

        async function fetchTemplates() {
            const listEl = document.getElementById('templateList');
            const loadingEl = document.getElementById('modalLoading');
            listEl.innerHTML = '';
            loadingEl.classList.remove('hidden');
            try {
                const templates = await callApi('listTemplates', {});
                loadingEl.classList.add('hidden');
                if (Array.isArray(templates)) {
                    renderTemplates(templates);
                } else if (templates.status === 'error') {
                    listEl.innerHTML = `<li>Error: ${templates.message}</li>`;
                } else {
                    renderTemplates([]);
                }
            } catch (err) {
                loadingEl.classList.add('hidden');
                listEl.innerHTML = `<li>Connection error.</li>`;
            }
        }

        function renderTemplates(templates) {
            const listEl = document.getElementById('templateList');
            if (!templates || templates.length === 0) {
                listEl.innerHTML = '<li style="padding: 1rem; color: #999;">No saved forms found.</li>';
                return;
            }
            listEl.innerHTML = templates.map(t => `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: default;">
                    <div onclick="loadForm('${t.id}')" style="flex: 1; cursor: pointer;">
                        <div style="font-weight: bold;">${t.name}</div>
                        ${t.description ? `<div style="font-size: 0.8rem; color: #666; margin: 2px 0;">${t.description}</div>` : ''}
                        <div style="font-size: 0.7rem; color: #999;">ID: ${t.id}</div>
                        <div style="font-size: 0.7rem; color: #999;">Updated: ${new Date(t.lastUpdated).toLocaleString()}</div>
                    </div>
                    <button onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                            style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 10px;"
                            onmouseover="this.style.background='#b91c1c'" 
                            onmouseout="this.style.background='#dc2626'">
                        🗑️ Delete
                    </button>
                </li>
            `).join('');
        }

        async function loadForm(id) {
            closeLoadModal();
            const loader = document.getElementById('loader');
            if (loader) loader.classList.remove('hidden');
            try {
                const res = await callApi('getForm', { formId: id });
                if (res.status === 'success') {
                    applyLoadedForm(id, res.schema, res.config, res.metadata);
                } else {
                    const data = localStorage.getItem('form_' + id);
                    if (data) {
                        const parsed = JSON.parse(data);
                        applyLoadedForm(id, parsed.schema, parsed.config, parsed.metadata);
                    } else {
                        alert('Error: ' + res.message);
                    }
                }
            } catch (err) {
                alert('Could not load form.');
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        function applyLoadedForm(id, schema, config, metadata) {
            metadata = metadata || {};
            formConfig.id = id;
            formConfig.formName = config.formName || id;
            formConfig.description = metadata.description || "";
            formConfig.allowedDomains = metadata.allowedDomains || "";
            formConfig.sheetUrl = config.targetSheetUrl || "";
            formConfig.sheetName = config.targetSheetName || "Form Responses";
            formConfig.language = config.language || "mr";
            formConfig.languagePrimary = config.languagePrimary || "en";
            formConfig.languageSecondary = config.languageSecondary || config.language || 'mr';

            document.getElementById('propFormId').value = formConfig.id;
            document.getElementById('propFormName').value = formConfig.formName;
            document.getElementById('headerFormNameInput').value = formConfig.formName;
            document.getElementById('propDescription').value = formConfig.description;
            document.getElementById('propAllowedDomains').value = formConfig.allowedDomains;
            document.getElementById('propSheetUrl').value = formConfig.sheetUrl;
            document.getElementById('propSheetName').value = formConfig.sheetName;
            document.getElementById('propLanguagePrimary').value = formConfig.languagePrimary;
            document.getElementById('propLanguageSecondary').value = formConfig.languageSecondary;
            document.getElementById('headerFormId').innerText = formConfig.id;

            elements = [];
            canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());
            (schema || []).forEach(elmData => {
                elements.push(elmData);
                renderElementDOM(elmData);
            });
            selectedIds = [];
            renderSelectionState();
            updatePropsPanel();
            updateFormLanguage();
        }

        async function deleteTemplate(formId, formName) {
            if (!confirm(`Are you sure you want to DELETE this form?\n\nForm: ${formName}\nID: ${formId}\n\nThis action cannot be undone!`)) {
                return;
            }

            const loader = document.getElementById('loader');
            if (loader) loader.classList.remove('hidden');

            try {
                const res = await callApi('deleteForm', { formId: formId });

                if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                    alert(`✅ Form "${formName}" deleted successfully!`);
                    // Refresh the template list
                    fetchTemplates();
                } else {
                    alert('❌ Error deleting form: ' + res.message);
                }
            } catch (err) {
                alert('❌ Failed to delete form: ' + err.message);
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        // --- EMBED MODAL LOGIC ---
        // --- PORTAL MODAL LOGIC ---
        let allTemplates = [];
        let portalConfig = { forms: [] };

        async function showPortalModal() {
            document.getElementById('portalModal').style.display = 'flex';
            document.getElementById('portalLoading').classList.remove('hidden');
            const listEl = document.getElementById('portalTemplateList');
            listEl.innerHTML = '';

            try {
                // Fetch both all templates AND current portal config
                const [templates, config] = await Promise.all([
                    callApi('listTemplates', {}),
                    callApi('getPortalConfig', {})
                ]);

                allTemplates = templates;
                portalConfig = config || { forms: [] };

                document.getElementById('portalLoading').classList.add('hidden');
                renderPortalItems();
            } catch (err) {
                alert("Failed to load portal data.");
                closePortalModal();
            }
        }

        function closePortalModal() {
            document.getElementById('portalModal').style.display = 'none';
        }

        function renderPortalItems() {
            const listEl = document.getElementById('portalTemplateList');
            if (!allTemplates || allTemplates.length === 0) {
                listEl.innerHTML = '<li style="padding:1rem; color:#999;">No saved forms found to include.</li>';
                return;
            }

            listEl.innerHTML = allTemplates.map(t => {
                const portalItem = portalConfig.forms.find(pf => pf.id === t.id);
                const isSelected = !!portalItem;
                const order = portalItem ? portalItem.order : 0;

                return `
                    <li style="display:flex; align-items:center; gap:1rem; cursor:default; hover:none;">
                        <input type="checkbox" class="portal-check" data-id="${t.id}" data-name="${t.name}" ${isSelected ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer;">
                        <div style="flex:1;">
                            <div style="font-weight:600;">${t.name}</div>
                            <div style="font-size:0.75rem; color:var(--text-light); text-transform:uppercase;">ID: ${t.id}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:0.8rem; color:var(--text-light);">Sort Order:</span>
                            <input type="number" class="portal-order" data-id="${t.id}" value="${order}" style="width:60px; padding:4px; border:1px solid var(--border); border-radius:4px; text-align:center;">
                        </div>
                    </li>
                `;
            }).join('');
        }

        async function refreshPortalList() {
            const listEl = document.getElementById('sidebarPortalList');
            if (!listEl) return;

            listEl.innerHTML = '<div style="color:var(--text-light); font-size:0.8rem; text-align:center; padding:2rem;">Loading forms...</div>';

            try {
                // Fetch both all templates AND current portal config
                const [templates, config] = await Promise.all([
                    callApi('listTemplates', {}),
                    callApi('getPortalConfig', {})
                ]);

                allTemplates = Array.isArray(templates) ? templates : [];
                portalConfig = config || { forms: [] };

                if (allTemplates.length === 0) {
                    listEl.innerHTML = '<div style="color:var(--text-light); font-size:0.8rem; text-align:center; padding:2rem;">No saved forms found. Create and save forms first.</div>';
                    return;
                }

                // Render the list with checkboxes
                listEl.innerHTML = allTemplates.map(t => {
                    const portalItem = portalConfig.forms.find(pf => pf.id === t.id);
                    const isSelected = !!portalItem;
                    const order = portalItem ? portalItem.order : 0;

                    return `
                    return `
                        < div class="portal-item-row" style = "display:flex; align-items:center; gap:12px; background:var(--surface); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:8px; transition:all 0.2s; box-shadow:0 1px 2px rgba(0,0,0,0.05);" >
                            <input type="checkbox" class="portal-check" data-id="${t.id}" data-name="${t.name}" ${isSelected ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                                <div style="flex:1; min-width:0;">
                                    <div style="font-weight:700; font-size:0.85rem; color:var(--text-main);">${t.name}</div>
                                    <div style="font-size:0.7rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.025em; margin-top:2px;">ID: ${t.id}</div>
                                </div>
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <span style="font-size:0.75rem; color:var(--text-light); font-weight:600;">Order:</span>
                                    <input type="number" class="portal-order" data-id="${t.id}" value="${order}" style="width:48px; height:32px; padding:4px; border:2px solid var(--surface-alt); background:var(--surface-alt); border-radius:8px; text-align:center; font-size:0.9rem; font-weight:700; outline:none; transition:all 0.2s; color:var(--primary);" onfocus="this.style.borderColor='var(--primary)'; this.style.background='white';">
                                </div>
                            </div>
                    `;
                    `;
                }).join('');

            } catch (err) {
                console.error("Failed to load portal data:", err);
                listEl.innerHTML = '<div style="color:#dc2626; font-size:0.8rem; text-align:center; padding:2rem;">❌ Failed to load forms. Check your API connection.</div>';
            }
        }

        async function savePortalSettings() {
            const checks = document.querySelectorAll('.portal-check');
            const selectedForms = [];

            checks.forEach((chk) => {
                if (chk.checked) {
                    const id = chk.dataset.id;
                    const name = chk.dataset.name;
                    const orderInput = document.querySelector(`.portal-order[data-id="${id}"]`);
                    selectedForms.push({
                        id: id,
                        name: name,
                        order: parseInt(orderInput.value) || 0
                    });
                }
            });

            selectedForms.sort((a, b) => a.order - b.order);

            const btn = document.getElementById('btnSavePortal');
            if (btn) {
                btn.disabled = true;
                btn.innerText = 'Saving...';
            }

            const res = await callApi('savePortalConfig', { config: { forms: selectedForms, layout: 'sidebar' } });

            if (btn) {
                btn.disabled = false;
                btn.innerText = 'Save Portal Collection';
            }

            if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                alert("Portal Collection Updated Successfully!");
            } else {
                alert("Error: " + res.message);
            }
        }


        async function showEmbedModal() {
            const modal = document.getElementById('embedModal');
            const area = document.getElementById('embedCodeArea');
            if (!modal || !area) return;

            const currentApiUrl = (document.getElementById('propApiUrl') ? document.getElementById('propApiUrl').value : "") || formConfig.gasApiUrl;
            const myHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '');
            const viewerPath = myHost + (myHost.endsWith('/') ? '' : '/') + 'viewer.html';

            if (currentApiUrl) {
                const embedUrl = `${viewerPath}?id=${formConfig.id}&api=${encodeURIComponent(currentApiUrl)}`;
                // UPDATED: Point to portal.html
                const portalUrl = myHost + (myHost.endsWith('/') ? '' : '/') + 'portal.html?api=' + encodeURIComponent(currentApiUrl);

                const code = `<!-- SINGLE FORM -->\n<iframe src="${embedUrl}" width="100%" height="800px" frameborder="0" style="border:none;"></iframe>\n\n<!-- MULTI-FORM PORTAL -->\n<iframe src="${portalUrl}" width="100%" height="800px" frameborder="0" style="border:none;"></iframe>`;

                area.value = code;
                modal.style.display = 'flex';
            } else {
                alert("Please configure 'GAS API URL' in Settings first.");
            }
        }

        function closeEmbedModal() {
            const modal = document.getElementById('embedModal');
            if (modal) modal.style.display = 'none';
        }

        function copyEmbedCode() {
            const area = document.getElementById('embedCodeArea');
            if (area) {
                area.select();
                document.execCommand('copy');
                alert('Embed code copied!');
            }
        }

        // --- RULER LOGIC ---
        function initRulers() {
            const rulerTop = document.getElementById('rulerTop');
            const rulerLeft = document.getElementById('rulerLeft');
            if (!rulerTop || !rulerLeft) return;

            rulerTop.innerHTML = '';
            rulerLeft.innerHTML = '';

            for (let i = 0; i <= 800; i += 10) {
                const tick = document.createElement('div');
                tick.className = 'tick tick-h ' + (i % 100 === 0 ? 'major' : 'minor');
                tick.style.left = i + 'px';
                if (i % 100 === 0) tick.innerHTML = `<span>${i}</span>`;
                rulerTop.appendChild(tick);
            }
            for (let i = 0; i <= 1123; i += 10) {
                const tick = document.createElement('div');
                tick.className = 'tick tick-v ' + (i % 100 === 0 ? 'major' : 'minor');
                tick.style.top = i + 'px';
                if (i % 100 === 0) tick.innerHTML = `<span>${i}</span>`;
                rulerLeft.appendChild(tick);
            }
        }

        // --- UTILS ---
        function swapAllLabels() {
            if (!confirm("Are you sure you want to swap ALL labels? This will move existing 'Secondary' text into 'Primary' slots for all elements.")) return;

            elements.forEach(elm => {
                const temp = elm.props.label || '';
                elm.props.label = elm.props.labelRegional || '';
                elm.props.labelRegional = temp;

                const dom = document.getElementById(elm.id);
                if (dom) renderElementVisual(elm, dom);
            });

            // Swap dropdown values too
            const L1 = document.getElementById('propLanguagePrimary').value;
            const L2 = document.getElementById('propLanguageSecondary').value;
            document.getElementById('propLanguagePrimary').value = L2;
            document.getElementById('propLanguageSecondary').value = L1;

            updateFormLanguage();
            alert("Labels swapped successfully!");
        }

        function createNewForm() {
            if (elements.length > 0) {
                if (!confirm("Start a new form? Any unsaved changes on the current canvas will be lost.")) return;
            }

            // Reset Config
            formConfig = {
                id: 'Form_' + Date.now(),
                formName: 'New Form',
                description: '',
                allowedDomains: '',
                sheetUrl: '',
                sheetName: 'Form Responses',
                language: 'mr',
                languagePrimary: 'en',
                languageSecondary: 'mr',
                gasApiUrl: document.getElementById('propApiUrl').value || formConfig.gasApiUrl
            };

            // Reset Elements
            elements = [];
            canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());

            // Reset UI
            document.getElementById('propFormId').value = formConfig.id;
            document.getElementById('propFormName').value = formConfig.formName;
            document.getElementById('headerFormNameInput').value = formConfig.formName;
            document.getElementById('propDescription').value = '';
            document.getElementById('propAllowedDomains').value = '';
            document.getElementById('propSheetUrl').value = '';
            document.getElementById('propSheetName').value = 'Form Responses';
            document.getElementById('headerFormId').innerText = formConfig.id;

            renderSelectionState();
            showGlobalProps();
            updateFormLanguage();

            alert("New Form Created! You can start adding elements.");
        }

        function openPreview() {
            const currentApiUrl = (document.getElementById('propApiUrl') ? document.getElementById('propApiUrl').value : "") || formConfig.gasApiUrl;
            if (!currentApiUrl) {
                alert("Please configure 'GAS API URL' in Settings first.");
                return;
            }
            const myHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '');
            const portalUrl = myHost + (myHost.endsWith('/') ? '' : '/') + 'portal.html?api=' + encodeURIComponent(currentApiUrl);
            window.open(portalUrl, '_blank');
        }

        function openPortalWithApi() {
            const currentApiUrl = (document.getElementById('propApiUrl') ? document.getElementById('propApiUrl').value : "") || formConfig.gasApiUrl;
            if (!currentApiUrl) {
                alert("⚠️ Please enter and save your GAS API URL in Settings first!");
                showGlobalProps(); // Open settings
                return;
            }

            // Construct absolute path to portal.html
            // Assuming index.html and portal.html are in the same directory
            const myHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '');
            const portalUrl = myHost + (myHost.endsWith('/') ? '' : '/') + 'portal.html?api=' + encodeURIComponent(currentApiUrl);

            // Open in new tab
            window.open(portalUrl, '_blank');
        }

        initRulers();
    </script>
</body>

</html>