<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Form Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --surface: #ffffff;
            --surface-alt: #f3f4f6;
            --border: #e5e7eb;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --sidebar-width: 260px;
            --props-width: 300px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }

        /* HEADER */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            z-index: 10;
        }

        .brand {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            border-color: var(--border);
            background: white;
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: var(--surface-alt);
        }

        /* PROPERTIES PANEL TABS */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #eff6ff;
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #eff6ff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* MAIN LAYOUT */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR (TOOLS) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface-alt);
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--surface);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .portal-config-panel {
            padding: 1rem;
        }

        .portal-item-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--surface-alt);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .tool-category {
            padding: 1rem;
        }

        .category-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .tool-item {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }

        .tool-item:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .tool-item svg {
            width: 20px;
            height: 20px;
            color: var(--text-light);
        }

        /* CANVAS */
        .canvas-area {
            flex: 1;
            background: #ffffff;
            /* Clean professional background */
            padding: 2rem;
            overflow: auto;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .canvas {
            width: 794px;
            /* A4 width approx */
            height: 1123px;
            /* A4 height approx */
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .canvas.show-grid {
            background-size: 20px 20px;
            background-image:
                linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
        }

        /* CANVAS BRANDING ZONES */
        .canvas-branding-zone {
            width: 100%;
            padding: 30px 20px;
            box-sizing: border-box;
            pointer-events: none;
            /* Don't interfere with drag/drop */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background: #fff;
            border-bottom: 2px solid #f3f4f6;
            z-index: 5;
            min-height: 50px;
            position: relative;
        }

        .canvas-branding-zone.footer {
            margin-top: 50px;
            border-bottom: none;
            border-top: 2px solid #f3f4f6;
            padding: 20px;
            min-height: 40px;
        }

        .canvas-branding-logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .canvas-branding-logo img {
            max-width: 120px;
            max-height: 50px;
            object-fit: contain;
        }

        .canvas-branding-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #111827;
            margin-bottom: 4px;
        }

        .canvas-branding-punchline {
            font-size: 0.9rem;
            color: #616161;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .canvas-branding-desc {
            font-size: 0.85rem;
            color: #6b7280;
            max-width: 80%;
            margin-top: 8px;
            line-height: 1.4;
        }

        .canvas-branding-footer-text {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* CARD MODE SIMULATION IN BUILDER */
        .canvas-area.card-mode {
            background: #f3f4f6;
        }

        .canvas-area.card-mode .canvas {
            width: 700px;
            /* Narrower for card */
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .canvas-area.card-mode .canvas.show-grid {
            background-image: none;
            /* Hide grid in card mode for focus */
        }


        /* RULERS */
        .ruler-h {
            position: absolute;
            top: -25px;
            left: 0;
            height: 25px;
            width: 100%;
            background: #fff;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            display: flex;
        }

        .ruler-v {
            position: absolute;
            left: -25px;
            top: 0;
            width: 25px;
            height: 100%;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tick {
            position: absolute;
            background: #999;
            font-size: 8px;
            color: #555;
            pointer-events: none;
        }

        .tick-h {
            bottom: 0;
            border-left: 1px solid #ccc;
        }

        .tick-h.major {
            height: 100%;
            border-left: 1px solid #777;
            font-weight: bold;
        }

        .tick-h.minor {
            height: 5px;
        }

        .tick-h span {
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .tick-v {
            right: 0;
            border-top: 1px solid #ccc;
        }

        .tick-v.major {
            width: 100%;
            border-top: 1px solid #777;
            font-weight: bold;
        }

        .tick-v.minor {
            width: 5px;
        }

        .tick-v span {
            position: absolute;
            bottom: 2px;
            left: 2px;
            transform: rotate(-90deg);
            transform-origin: 0 100%;
            white-space: nowrap;
        }

        .canvas-element {
            position: absolute;
            border: 1px dashed transparent;
            cursor: pointer;
            padding: 4px;
        }

        .canvas-element:hover {
            border-color: var(--primary);
        }

        .canvas-element.selected {
            border: 2px solid var(--primary);
            z-index: 10;
            cursor: move;
        }

        /* RESIZE HANDLES */
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border: 1px solid white;
            border-radius: 50%;
            z-index: 11;
            pointer-events: auto;
        }

        .handle-nw {
            top: -4px;
            left: -4px;
            cursor: nwse-resize;
        }

        .handle-n {
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            cursor: ns-resize;
        }

        .handle-ne {
            top: -4px;
            right: -4px;
            cursor: nesw-resize;
        }

        .handle-e {
            top: 50%;
            right: -4px;
            transform: translateY(-50%);
            cursor: ew-resize;
        }

        .handle-se {
            bottom: -4px;
            right: -4px;
            cursor: nwse-resize;
        }

        .handle-s {
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            cursor: ns-resize;
        }

        .handle-sw {
            bottom: -4px;
            left: -4px;
            cursor: nesw-resize;
        }

        .handle-w {
            top: 50%;
            left: -4px;
            transform: translateY(-50%);
            cursor: ew-resize;
        }

        /* COMPONENT STYLES PREVIEW */
        .preview-field {
            pointer-events: none;
        }

        .preview-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
        }

        .preview-input {
            width: 200px;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #fff;
        }

        .preview-shape {
            background: #e2e8f0;
        }

        /* PROPERTIES PANEL */
        .properties-panel {
            width: var(--props-width);
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* Ensure vertical scrolling */
            max-height: 100vh;
            /* Prevent overflow of the whole app */
        }

        .props-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .props-content {
            padding: 1rem;
            flex: 1;
            /* Allow content to fill available space */
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--text-main);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-family: inherit;
        }

        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .toggle-switch input {
            width: auto;
        }

        .hidden {
            display: none;
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #loader.hidden {
            display: none !important;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .template-list {
            list-style: none;
            padding: 0;
        }

        .template-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .template-item:hover {
            background: var(--surface-alt);
        }

        .template-info {
            display: flex;
            flex-direction: column;
        }

        .template-name {
            font-weight: 600;
        }

        .template-date {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Color Controls Section */
        .color-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #bae6fd;
        }

        .color-section .category-title {
            color: #0284c7;
            font-size: 0.7rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        /* Style Controls Section */
        .style-section {
            background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #f0abfc;
        }

        .style-section .category-title {
            color: #a21caf;
            font-size: 0.7rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }
    </style>
</head>

<body>

    <!-- LOADING OVERLAY -->
    <div id="loader" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- HEADER -->
    <header>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                Dynamic Builder
            </div>
            <button class="btn btn-outline" onclick="createNewForm()"
                style="border-color: var(--primary); color: var(--primary); background: #eff6ff;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Form
            </button>
        </div>

        <div class="form-title-area" style="text-align: center; flex: 1; max-width: 400px; margin: 0 1rem;">
            <input type="text" id="headerFormNameInput" placeholder="Enter Form Name..."
                style="width: 100%; border: none; border-bottom: 2px solid transparent; text-align: center; font-size: 1.1rem; font-weight: 600; color: var(--primary); padding: 4px; transition: border-color 0.2s; background: transparent;"
                onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='transparent'">
            <div id="headerFormId" style="font-size: 0.65rem; color: var(--text-light); margin-top: 2px; opacity: 0.7;">
                Form_ID</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="goToWorkspace()" style="border-color: transparent;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5" />
                    <path d="M12 19l-7-7 7-7" />
                </svg>
                Back
            </button>
            <button class="btn btn-outline" onclick="showLoadModal()"
                style="background: #f8fafc; border-color: #cbd5e1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Load Form
            </button>
            <button class="btn btn-outline" onclick="showEmbedModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                </svg>
                Get Embed Code
            </button>
            <button class="btn btn-outline" onclick="switchSidebarTab('portal')"
                style="background: #fff7ed; border-color: #fed7aa; color: #9a3412;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Portal Designer
            </button>

            <button class="btn btn-outline" onclick="openPreview()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Preview Form
            </button>
            <button class="btn" onclick="openPortalWithApi()"
                style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                Launch Portal
            </button>
            <button class="btn btn-primary" onclick="saveForm()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <line x1="7" y1="3" x2="7" y2="8"></line>
                    <polyline points="15 3 15 8 7 8"></polyline>
                </svg>
                Save Form
            </button>
        </div>
    </header>

    <!-- LOAD MODAL -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Load Existing Form</h3>
                <span class="close-modal" onclick="closeLoadModal()">&times;</span>
            </div>
            <div id="modalLoading" class="hidden">Loading templates...</div>
            <ul id="templateList" class="template-list">
                <!-- Templates will be listed here -->
            </ul>
        </div>
    </div>

    <!-- EMBED MODAL -->
    <div id="embedModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Get Sharing Code</h3>
                <span class="close-modal" onclick="closeEmbedModal()">&times;</span>
            </div>

            <!-- OPTION 1: DIRECT LINK -->
            <div style="margin-bottom: 2rem;">
                <div
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; color: var(--primary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    <span style="font-weight: 700; font-size: 0.9rem;">Option 1: Direct Share Link</span>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.75rem;">
                    Best for sending via WhatsApp, Email, or Social Media.
                </p>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="directLinkArea" readonly
                        style="flex: 1; padding: 0.6rem; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 6px; background: #f8fafc; outline: none;">
                    <button class="btn btn-primary" onclick="copyDirectLink()" style="padding: 0.6rem 1rem;">
                        Copy Link
                    </button>
                </div>
            </div>

            <!-- OPTION 2: IFRAME EMBED -->
            <div
                style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--border);">
                <h4
                    style="margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-main); display: flex; align-items: center; gap: 6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    Configuration
                </h4>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light);">Google
                        Sheet URL (Optional)</label>
                    <input type="text" id="propSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..."
                        style="width: 100%; padding: 8px; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 6px;">
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light);">Sheet
                        Name</label>
                    <input type="text" id="propSheetName" placeholder="Form Responses"
                        style="width: 100%; padding: 8px; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 6px;">
                </div>

                <div class="form-group">
                    <label
                        style="display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--text-light);">Custom
                        Domain (Optional)</label>
                    <input type="text" id="propCustomDomain" placeholder="https://form.example.com"
                        onchange="localStorage.setItem('customDomain', this.value)"
                        style="width: 100%; padding: 8px; font-size: 0.85rem; border: 1px solid var(--border); border-radius: 6px;">
                </div>
            </div>

            <div style="height: 1px; background: var(--border); margin-bottom: 1.5rem;"></div>

            <!-- EMBED CODE WRAPPER -->
            <div>
                <div
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; color: var(--primary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    <span style="font-weight: 700; font-size: 0.9rem;">Option 2: Website Embed (Iframe)</span>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.75rem;">
                    Copy this code to paste into your website's HTML editor.
                </p>
                <textarea id="embedCodeArea" rows="4" readonly
                    style="width: 100%; padding: 0.75rem; font-family: monospace; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 6px; background: #f8f9fa; margin-bottom: 0.75rem; resize: none;"></textarea>
                <button class="btn btn-outline" style="width: 100%; justify-content: center;" onclick="copyEmbedCode()">
                    Copy Embed Code
                </button>
            </div>
        </div>
    </div>

    <div class="workspace">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchSidebarTab('elements')">Elements</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('portal')">Portal View</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('branding')">ðŸŽ¨ Branding</div>
            </div>

            <div class="sidebar-content">
                <!-- ELEMENTS TAB -->
                <div id="panelElements" class="tab-panel active">
                    <div class="tool-category">
                        <div class="category-title">Input Fields</div>
                        <div class="tool-grid">
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="text">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
                                    <line x1="12" y1="22" x2="12" y2="2"></line>
                                </svg>
                                <span>Text</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="date">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span>Date</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="dropdown">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                <span>Dropdown</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="image">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <span>Image</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="textarea">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span>Text Area</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="paragraph">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="21" y1="10" x2="3" y2="10"></line>
                                    <line x1="21" y1="6" x2="3" y2="6"></line>
                                    <line x1="21" y1="14" x2="3" y2="14"></line>
                                    <line x1="21" y1="18" x2="3" y2="18"></line>
                                </svg>
                                <span>Paragraph</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="number">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                    </path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                                <span>Number</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="email">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z">
                                    </path>
                                    <polyline points="22,6 12,13 2,6"></polyline>
                                </svg>
                                <span>Email</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="counter">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>+/- Counter</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="repeater">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="3" y1="12" x2="21" y2="12"></line>
                                    <line x1="3" y1="6" x2="21" y2="6"></line>
                                    <line x1="3" y1="18" x2="21" y2="18"></line>
                                </svg>
                                <span>Add More List</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="file">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <span>File</span>
                            </div>
                        </div>
                    </div>

                    <div class="tool-category">
                        <div class="category-title">Cosmetics</div>
                        <div class="tool-grid">
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="heading">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M4 12h8"></path>
                                    <path d="M4 6h16"></path>
                                    <path d="M4 18h8"></path>
                                </svg>
                                <span>Heading</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                                <span>Label</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="rect">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                </svg>
                                <span>Box</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="line">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>Line</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="separator">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <line x1="2" y1="9" x2="22" y2="9" stroke-opacity="0.3"></line>
                                    <line x1="2" y1="15" x2="22" y2="15" stroke-opacity="0.3"></line>
                                </svg>
                                <span>Separator</span>
                            </div>
                        </div>
                    </div>

                    <div class="tool-category">
                        <div class="category-title" style="color: #c026d3;">âœ¨ Branding & Title</div>
                        <div class="tool-grid">
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="logo">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c026d3"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                                    <line x1="9" y1="9" x2="9.01" y2="9" />
                                    <line x1="15" y1="9" x2="15.01" y2="9" />
                                </svg>
                                <span>Logo</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="form_title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c026d3"
                                    stroke-width="2">
                                    <path d="M4 7V4h16v3M9 20h6M12 4v16" />
                                </svg>
                                <span>Form Title</span>
                            </div>
                            <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                data-type="punchline">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c026d3"
                                    stroke-width="2">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                </svg>
                                <span>Punchline</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PORTAL DESIGNER TAB -->
                <div id="panelPortal" class="tab-panel">
                    <div class="portal-config-panel">
                        <div class="category-title">Portal Navigation Designer</div>
                        <p style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 1rem;">
                            Pick forms for your portal sidebar and set their order.
                        </p>
                        <!-- BRANDING SETTINGS FOR PORTAL -->
                        <div
                            style="background: #fffbeb; padding: 1rem; border-radius: 8px; border: 1px solid #fcd34d; margin-bottom: 1.5rem;">
                            <label
                                style="color: #92400e; font-weight: 700; font-size: 0.85rem; display: block; margin-bottom: 5px;">Professional
                                Branding (Slug)</label>
                            <input type="text" id="sidebarPortalSlug" placeholder="e.g. my-organization"
                                style="width: 100%; padding: 8px; border: 1px solid #fcd34d; border-radius: 4px; margin-bottom: 5px;"
                                oninput="syncPortalSlug(this.value)">
                            <small style="font-size: 0.65rem; color: #92400e; display: block; margin-bottom: 10px;">
                                This creates: <b>portal.html?p=name</b>
                            </small>

                            <label
                                style="color: #92400e; font-weight: 700; font-size: 0.85rem; display: block; margin-bottom: 5px;">Custom
                                Domain / Alias (Optional)</label>
                            <input type="text" id="sidebarCustomDomain" placeholder="https://yourbrand.com"
                                style="width: 100%; padding: 8px; border: 1px solid #fcd34d; border-radius: 4px;"
                                oninput="syncCustomDomain(this.value)">
                            <small style="font-size: 0.65rem; color: #92400e; display: block; margin-top: 4px;">
                                Use this to hide "github.io" in shared links.
                            </small>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-outline"
                                style="width:100%; justify-content:center; font-size:0.75rem;"
                                onclick="refreshPortalList()">
                                â†» Refresh Forms List
                            </button>
                        </div>

                        <div id="sidebarPortalList"
                            style="max-height: 450px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; background: var(--surface-alt);">
                            <!-- List of forms with checkboxes and order inputs -->
                            <div style="color:var(--text-light); font-size:0.8rem; text-align:center; padding:2rem;">
                                Click Refresh to load forms...
                            </div>
                        </div>

                        <div
                            style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-outline"
                                style="width:100%; justify-content:center; border-color: #3b82f6; color: #3b82f6; background: #eff6ff;"
                                onclick="openPortalPreview()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" style="margin-right: 6px;">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Preview Portal Preview
                            </button>
                            <button class="btn btn-primary" id="btnSavePortal"
                                style="width:100%; justify-content:center;" onclick="savePortalSettings()">
                                Save Portal Collection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- BRANDING TAB PANEL -->
                <div id="panelBranding" class="tab-panel">
                    <div style="padding: 1rem;">
                        <div class="category-title"
                            style="color: #7c3aed; border-bottom: 2px solid #ddd6fe; padding-bottom: 5px; margin-bottom: 1rem;">
                            ðŸŽ¨ Form Visual Branding
                        </div>

                        <!-- Draggable Branding Tools for better discoverability -->
                        <div
                            style="background: #f5f3ff; padding: 1rem; border-radius: 12px; border: 1px solid #ddd6fe; margin-bottom: 1rem;">
                            <label
                                style="color: #7c3aed; font-weight: 700; font-size: 0.75rem; display: block; margin-bottom: 10px; text-transform: uppercase;">Drag
                                & Drop Brand Tools</label>
                            <div class="tool-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                    data-type="logo" style="padding: 0.5rem; background: white;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7c3aed"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                                        <line x1="9" y1="9" x2="9.01" y2="9" />
                                        <line x1="15" y1="9" x2="15.01" y2="9" />
                                    </svg>
                                    <span style="font-size: 0.65rem;">Logo</span>
                                </div>
                                <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                    data-type="form_title" style="padding: 0.5rem; background: white;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7c3aed"
                                        stroke-width="2">
                                        <path d="M4 7V4h16v3M9 20h6M12 4v16" />
                                    </svg>
                                    <span style="font-size: 0.65rem;">Title</span>
                                </div>
                                <div class="tool-item" draggable="true" ondragstart="handleDragStart(event)"
                                    data-type="punchline" style="padding: 0.5rem; background: white;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7c3aed"
                                        stroke-width="2">
                                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                    </svg>
                                    <span style="font-size: 0.65rem;">Slogan</span>
                                </div>
                            </div>
                        </div>

                        <div
                            style="background: #fdf2f8; padding: 1.25rem; border-radius: 12px; border: 1px solid #fbcfe8; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                                    <label style="color: #be185d; font-weight: 700;">Form Header Title</label>
                                    <input type="text" id="propHeaderTitle" placeholder="e.g. Data Entry Form"
                                        style="border-color: #f9a8d4;" oninput="updateCanvasBranding()">
                                </div>
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label style="color: #be185d; font-weight: 700;">Logo/Icon</label>
                                    <input type="text" id="propLogoIcon" placeholder="Emoji or Text"
                                        style="border-color: #f9a8d4;" oninput="updateCanvasBranding()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label style="color: #be185d; font-weight: 700;">Punch Line / Subtitle</label>
                                <input type="text" id="propPunchline" placeholder="e.g. Your tagline here"
                                    style="border-color: #f9a8d4;" oninput="updateCanvasBranding()">
                            </div>

                            <div class="form-group">
                                <label style="color: #be185d; font-weight: 700;">Logo Image URL (Optional)</label>
                                <input type="text" id="propLogoUrl" placeholder="https://example.com/logo.png"
                                    style="border-color: #f9a8d4; margin-bottom: 5px;" oninput="updateCanvasBranding()">
                                <small style="font-size: 0.65rem; color: #db2777;">Paste a direct image link
                                    here.</small>
                            </div>

                            <div class="form-group">
                                <label style="color: #be185d; font-weight: 700;">Form Description/Instructions</label>
                                <textarea id="propBrandingDescription" rows="3"
                                    placeholder="Enter short instructions..."
                                    style="border-color: #f9a8d4; border-radius: 6px; padding: 8px; width: 100%; font-size: 0.85rem;"
                                    oninput="updateCanvasBranding()"></textarea>
                            </div>

                            <div class="form-group">
                                <label style="color: #be185d; font-weight: 700;">Footer Text / Credits</label>
                                <input type="text" id="propFooterText" placeholder="e.g. Â© 2024 Your Brand"
                                    style="border-color: #f9a8d4;" oninput="updateCanvasBranding()">
                            </div>

                            <div class="form-group"
                                style="margin-top: 10px; border-top: 1px dashed #f9a8d4; padding-top: 15px;">
                                <label class="checkbox-container"
                                    style="font-size: 0.85rem; color: #be185d; font-weight: 600;">
                                    <input type="checkbox" id="propDisplayMode" value="card"
                                        onchange="updateCanvasBranding()">
                                    <span class="checkmark"></span>
                                    Display in Card Layout
                                </label>
                                <small
                                    style="font-size: 0.65rem; color: #db2777; display: block; margin-top: 4px;">Recommended
                                    for professional look.</small>
                            </div>
                        </div>

                        <div class="category-title"
                            style="color: #1e40af; border-bottom: 2px solid #bfdbfe; padding-bottom: 5px; margin-bottom: 1rem;">
                            ðŸ”— Custom URLs & Links
                        </div>
                        <div
                            style="background: #eff6ff; padding: 1.25rem; border-radius: 12px; border: 1px solid #bfdbfe; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label style="color: #1e40af; font-weight: 700;">Form Link Name (Slug)</label>
                                <input type="text" id="fieldFormSlug" placeholder="e.g. donation-link"
                                    style="border-color: #93c5fd; margin-bottom: 5px;">
                                <small style="font-size: 0.65rem; color: #3b82f6;">Creates:
                                    <b>viewer.html?v=name</b></small>
                            </div>

                            <div class="form-group"
                                style="margin-top: 15px; border-top: 1px dashed #bfdbfe; padding-top: 15px;">
                                <label style="color: #1e40af; font-weight: 700;">Portal Link Name (Slug)</label>
                                <input type="text" id="portalSlug" placeholder="e.g. organization"
                                    style="border-color: #93c5fd;"
                                    oninput="syncPortalSlug(this.value, 'sidebarPortalSlug')">
                                <small style="font-size: 0.65rem; color: #3b82f6;">Creates:
                                    <b>portal.html?p=name</b></small>
                            </div>

                            <div class="form-group"
                                style="margin-top: 15px; border-top: 1px dashed #bfdbfe; padding-top: 15px;">
                                <label style="color: #1e40af; font-weight: 700;">Branded Domain (Optional)</label>
                                <input type="text" id="propCustomDomain" placeholder="https://yourbrand.com"
                                    style="border-color: #93c5fd; margin-bottom: 5px;"
                                    oninput="syncCustomDomain(this.value, 'sidebarCustomDomain')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </aside>

        <!-- CANVAS -->
        <main class="canvas-area" id="canvasArea" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
            <div id="formCanvas" class="canvas show-grid">
                <div class="ruler-h" id="rulerTop"></div>
                <div class="ruler-v" id="rulerLeft"></div>

                <!-- Elements will be dropped here -->

                <!-- Elements will be dropped here -->
            </div>
        </main>

        <!-- PROPERTIES PANEL -->
        <aside class="properties-panel">




            <!-- TABS -->
            <div class="panel-tabs"
                style="display: flex; border-bottom: 1px solid var(--border); background: #f8fafc; position:sticky; top:0; z-index:10;">
                <button class="tab-btn active" onclick="switchTab('settings')"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; color:#64748b; border-bottom:3px solid transparent;">Settings</button>
                <button class="tab-btn" onclick="switchTab('properties')"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; color:#64748b; border-bottom:3px solid transparent;">Properties</button>
                <button class="tab-btn" onclick="switchTab('design')"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; color:#64748b; border-bottom:3px solid transparent;">Design</button>
            </div>

            <div style="padding: 1rem;">
                <!-- TAB 1: SETTINGS (GLOBAL) -->
                <div id="tab-settings" class="tab-content active">
                    <div id="globalProps">
                        <h3>ðŸ“ Form Settings</h3>
                        <div class="form-group">
                            <label>Form ID</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="propFormId" readonly style="background: #f3f4f6; color: #666;">
                                <button class="btn btn-outline" style="padding: 5px 10px;"
                                    onclick="copyToClipboard(document.getElementById('propFormId').value)">ðŸ“‹</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Form Name</label>
                            <input type="text" id="propFormName">
                        </div>
                        <div class="form-group">
                            <label>Description (Optional)</label>
                            <textarea id="propDescription" class="prop-input" rows="3"></textarea>
                        </div>

                        <div class="prop-group">
                            <h3>ðŸ” Access & Security</h3>
                            <label>Allowed Domains (Comma separated)</label>
                            <small style="color: #666; font-size: 0.75rem;">Leave empty to allow
                                all.</small>
                        </div>

                        <div id="adminUnlockArea" style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-outline" onclick="unlockAdminSettings()">ðŸ”’ Unlock
                                Advanced Settings</button>
                        </div>

                        <div id="adminSettingsArea" class="hidden"
                            style="margin-top: 20px; border: 1px solid #fee2e2; padding: 10px; border-radius: 6px; background: #fff1f2;">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h4 style="margin:0; color:#b91c1c;">Advanced Settings</h4>
                                <button onclick="lockAdminSettings()"
                                    style="background:none; border:none; color:#b91c1c; cursor:pointer;">âœ–
                                    Lock</button>
                            </div>

                            <div class="form-group">
                                <label>Storage Engine</label>
                                <select id="propStorageEngine" onchange="toggleBackendConfig()">
                                    <option value="gas">Google Sheets (GAS)</option>
                                    <option value="firebase">Firebase Firestore</option>
                                </select>
                            </div>

                            <div id="firebaseConfigArea" class="form-group hidden">
                                <label>Firebase Config JSON</label>
                                <textarea id="propFirebaseConfig" rows="5"
                                    style="font-family:monospace; font-size:0.8rem;"
                                    placeholder='{"apiKey": "...", ...}'></textarea>
                            </div>

                            <div class="form-group">
                                <label>GAS Script URL</label>
                                <input type="text" id="propApiUrl">
                            </div>
                            <!-- MOVED TO EMBED MODAL -->
                        </div>

                        <!-- BRANDING -->
                        <div id="brandingSection"
                            style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                            <h3>âœ¨ Branding</h3>
                            <!-- Content populated by updateCanvasBranding inputs if needed, usually globalProps contains enough -->
                        </div>
                    </div>

                    <div
                        style="padding: 20px; text-align: center; color: #64748b; font-style: italic; margin-top:40px;">
                        <p>Select an element on the canvas to edit its properties.</p>
                    </div>
                </div>

                <!-- TAB 2: PROPERTIES (DATA) -->
                <div id="tab-properties" class="tab-content" style="display:none;">
                    <div id="elementProps" style="display: none;">
                        <div class="form-group">
                            <label>Element ID</label>
                            <input type="text" id="propId" readonly style="background: #f3f4f6; color: #666;">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <input type="text" id="propType" readonly
                                style="background: #f3f4f6; color: #666; text-transform: capitalize;">
                        </div>
                        <div class="form-group" id="grpPurpose">
                            <label>Element Purpose</label>
                            <select id="propPurpose" onchange="updateSelectedElement()">
                                <option value="form">Form Field</option>
                                <option value="branding">Branding Element</option>
                            </select>
                        </div>
                        <div class="form-group" id="grpBrandingStyle" style="display: none;">
                            <label>Branding Style</label>
                            <select id="propBrandingStyle" onchange="updateSelectedElement()">
                                <option value="default">Default</option>
                                <option value="title">Title (Large, Bold)</option>
                                <option value="subtitle">Subtitle (Italic)</option>
                                <option value="label">Label</option>
                                <option value="logo">Logo</option>
                            </select>
                        </div>
                        <hr style="border: 0; border-top: 1px solid var(--border); margin: 1rem 0;">
                        <div class="form-group">
                            <label id="lblPropPrimary">Field Label (Primary)</label>
                            <input type="text" id="propLabel" oninput="updateSelectedElement()">
                        </div>
                        <div class="form-group">
                            <label id="lblPropSecondary">Field Label (Secondary)</label>
                            <input type="text" id="propLabelRegional" oninput="updateSelectedElement()">
                        </div>
                        <div class="form-group">
                            <label>Field Name (DB Key)</label>
                            <input type="text" id="propName" oninput="updateSelectedElement()">
                        </div>
                        <div class="form-group" id="grpPlaceholder">
                            <label>Placeholder Text</label>
                            <input type="text" id="propPlaceholder" oninput="updateSelectedElement()">
                        </div>
                        <div class="form-group" id="grpOptions" style="display: none;">
                            <label>Dropdown Options (Comma separated)</label>
                            <textarea id="propOptions" placeholder="Option 1, Option 2, Option 3" rows="3"
                                oninput="updateSelectedElement()"></textarea>
                        </div>
                        <div class="form-group" id="grpImageUrl" style="display: none;">
                            <label>Image / Logo URL</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="propImageUrl" oninput="updateSelectedElement()" style="flex: 1;">
                                <button class="btn btn-outline" onclick="triggerFileUpload()" style="padding: 0 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="17 8 12 3 7 8" />
                                        <line x1="12" y1="3" x2="12" y2="15" />
                                    </svg>
                                </button>
                            </div>
                            <input type="file" id="propFileUpload" style="display: none;" accept="image/*"
                                onchange="handleFileSelection(event)">
                        </div>
                        <div class="form-group toggle-group" id="grpSyncConfig" style="display: none;">
                            <label>Keep Synced with Form Settings</label>
                            <input type="checkbox" id="propSyncConfig" onchange="updateSelectedElement()">
                        </div>
                        <div class="form-group toggle-group">
                            <label>Required</label>
                            <input type="checkbox" id="propRequired" onchange="updateSelectedElement()">
                        </div>
                        <div class="form-group toggle-group">
                            <label id="lblPropTranslatable">Enable Translation (English -> Marathi)</label>
                            <input type="checkbox" id="propTranslatable" onchange="updateSelectedElement()">
                        </div>

                        <div class="form-group">
                            <button class="btn btn-outline"
                                style="width: 100%; justify-content: center; margin-bottom: 0.5rem;"
                                onclick="duplicateSelected()">
                                Duplicate Element
                            </button>
                            <button class="btn btn-outline"
                                style="color: var(--danger); border-color: var(--danger); width: 100%; justify-content: center;"
                                onclick="deleteSelected()">
                                Delete Element
                            </button>
                        </div>
                    </div>
                    <div id="propEmptyState" style="text-align: center; color: #999; padding-top: 50px;">
                        No element selected
                    </div>
                </div>
            </div>

            <!-- TAB 3: DESIGN (VISUALS) -->
            <div id="tab-design" class="tab-content" style="display:none;">
                <div id="designProps" style="display:none;">

                    <!-- DIMENSION CONTROLS -->
                    <div class="form-group" id="grpWidth">
                        <label>Width (px)</label>
                        <input type="number" id="propWidth" min="10" max="2000" oninput="updateDimensionsFromInputs()">
                    </div>
                    <div class="form-group" id="grpHeight">
                        <label>Height (px)</label>
                        <input type="number" id="propHeight" min="10" max="2000" oninput="updateDimensionsFromInputs()">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="form-group" style="flex:1;">
                            <label>X (px)</label>
                            <input type="number" id="propX" oninput="updatePosFromInputs()">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Y (px)</label>
                            <input type="number" id="propY" oninput="updatePosFromInputs()">
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 1rem 0;">

                    <!-- TYPOGRAPHY -->
                    <div class="form-group" id="grpHeadingLevel">
                        <label>Heading Level</label>
                        <select id="propHeadingLevel" onchange="updateSelectedElement()">
                            <option value="h1">H1 (Huge)</option>
                            <option value="h2">H2 (Large)</option>
                            <option value="h3">H3 (Medium)</option>
                            <option value="h4">H4 (Small)</option>
                        </select>
                    </div>
                    <div class="form-group" id="grpAlign">
                        <label>Alignment</label>
                        <select id="propAlign" onchange="updateSelectedElement()">
                            <option value="left">Left</option>
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                    <div class="form-group" id="grpFontSize">
                        <label>Font Size (px)</label>
                        <input type="number" id="propFontSize" oninput="updateSelectedElement()">
                    </div>
                    <div class="form-group toggle-group" id="grpBold">
                        <label>Bold Text</label>
                        <input type="checkbox" id="propBold" onchange="updateSelectedElement()">
                    </div>

                    <!-- VISUAL STYLE PROPERTIES -->
                    <div class="form-group" id="grpStrokeWidth">
                        <label>Thickness (px)</label>
                        <input type="number" id="propStrokeWidth" min="1" max="20" oninput="updateSelectedElement()">
                    </div>
                    <div class="form-group" id="grpBorderStyle">
                        <label>Style</label>
                        <select id="propBorderStyle" onchange="updateSelectedElement()">
                            <option value="solid">Solid</option>
                            <option value="dashed">Dashed</option>
                            <option value="dotted">Dotted</option>
                        </select>
                    </div>
                    <div class="form-group" id="grpBorderRadius">
                        <label>Corner Radius (px)</label>
                        <input type="number" id="propBorderRadius" min="0" max="100" oninput="updateSelectedElement()">
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 1rem 0;">

                    <!-- COLOR CONTROLS -->
                    <div class="color-section">
                        <div class="category-title">ðŸŽ¨ Colors</div>
                        <div class="form-group" id="grpTextColor">
                            <label>Text Color</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="color" id="propTextColor" value="#000000" oninput="updateSelectedElement()"
                                    style="width: 50px; height: 35px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
                                <input type="text" id="propTextColorHex" value="#000000"
                                    oninput="syncColorFromHex('text')"
                                    style="flex: 1; font-family: monospace; font-size: 0.85rem;" placeholder="#000000">
                            </div>
                        </div>
                        <div class="form-group" id="grpBackgroundColor">
                            <label>Background Color</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="color" id="propBackgroundColor" value="#ffffff"
                                    oninput="updateSelectedElement()"
                                    style="width: 50px; height: 35px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
                                <input type="text" id="propBackgroundColorHex" value="#ffffff"
                                    oninput="syncColorFromHex('background')"
                                    style="flex: 1; font-family: monospace; font-size: 0.85rem;" placeholder="#ffffff">
                            </div>
                        </div>
                        <div class="form-group" id="grpBorderColor">
                            <label>Border Color</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="color" id="propBorderColor" value="#cccccc"
                                    oninput="updateSelectedElement()"
                                    style="width: 50px; height: 35px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">
                                <input type="text" id="propBorderColorHex" value="#cccccc"
                                    oninput="syncColorFromHex('border')"
                                    style="flex: 1; font-family: monospace; font-size: 0.85rem;" placeholder="#cccccc">
                            </div>
                        </div>
                    </div>

                    <!-- ADVANCED STYLING -->
                    <div class="style-section">
                        <div class="category-title">âœ¨ Visual Effects</div>
                        <div class="form-group" id="grpOpacity">
                            <label>Opacity <span id="opacityValue"
                                    style="color: var(--text-light); font-size: 0.85rem;">100%</span></label>
                            <input type="range" id="propOpacity" min="0" max="100" value="100"
                                oninput="updateSelectedElement()" style="width: 100%;">
                        </div>
                        <div class="form-group" id="grpPadding">
                            <label>Padding (px)</label>
                            <input type="number" id="propPadding" min="0" max="50" value="8"
                                oninput="updateSelectedElement()">
                        </div>
                        <div class="form-group" id="grpShadow">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="propShadow" onchange="updateSelectedElement()">
                                <span>Add Shadow Effect</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div id="designEmptyState" style="text-align: center; color: #999; padding-top: 50px;">
                    No element selected
                </div>
            </div>
    </div>
    </aside>
    </div>

    <!-- MAIN BUILDER LOGIC -->
    <script>
        // FIREBASE INITIALIZATION
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCVnpnzTntQbfkCe_P09wSswjCKB8XnUcM",
            authDomain: "buildform-e7d3b.firebaseapp.com",
            projectId: "buildform-e7d3b",
            storageBucket: "buildform-e7d3b.firebasestorage.app",
            messagingSenderId: "1010258612784",
            appId: "1:1010258612784:web:4c076c1df63e98e19b93f5",
            measurementId: "G-L217Q3WM0G"
        };

        // Initialize Firebase
        let firebaseApp;
        let db;

        async function initFirebase() {
            try {
                const uiConfigRaw = document.getElementById('propFirebaseConfig').value;
                let config = defaultFirebaseConfig;

                if (uiConfigRaw && uiConfigRaw.trim().startsWith('{')) {
                    try {
                        config = JSON.parse(uiConfigRaw);
                        console.log("ðŸ“ Using Custom Firebase Config from UI");
                    } catch (e) {
                        console.warn("âš ï¸ Invalid JSON in Firebase Config. Using default.");
                    }
                }

                // If already initialized, check if we need to restart
                if (firebase.apps.length > 0) {
                    const currentApp = firebase.app();
                    // Simple check: if projectID is different, delete and restart
                    if (currentApp.options.projectId !== config.projectId) {
                        console.log("â™»ï¸ Restarting Firebase for new Project ID:", config.projectId);
                        await currentApp.delete();
                    } else {
                        db = firebase.firestore();
                        return;
                    }
                }

                firebaseApp = firebase.initializeApp(config);
                db = firebase.firestore();
                console.log("ðŸ”¥ Firebase Initialized Successfully:", config.projectId);
            } catch (err) {
                console.error("âŒ Firebase Init Error:", err);
            }
        }
        initFirebase();
        // API Helper Function
        async function callApi(action, payload) {
            // Priority 1: google.script.run (if hosted on GAS)
            if (typeof google !== 'undefined' && google.script) {
                return new Promise((resolve, reject) => {
                    const run = google.script.run;
                    if (action === 'saveForm') run.withSuccessHandler(resolve).withFailureHandler(reject).saveForm(payload.formId, payload.schema, payload.config);
                    else if (action === 'getForm') run.withSuccessHandler(resolve).withFailureHandler(reject).getForm(payload.formId);
                    else if (action === 'listTemplates') run.withSuccessHandler(resolve).withFailureHandler(reject).listTemplates();
                    else if (action === 'getScriptUrl') run.withSuccessHandler(resolve).withFailureHandler(reject).getScriptUrl();
                    else if (action === 'getPortalConfig') run.withSuccessHandler(resolve).withFailureHandler(reject).getPortalConfig();
                    else if (action === 'savePortalConfig') run.withSuccessHandler(resolve).withFailureHandler(reject).savePortalConfig(payload.config);
                    else if (action === 'deleteForm') run.withSuccessHandler(resolve).withFailureHandler(reject).deleteForm(payload.formId);
                    else if (action === 'ping') run.withSuccessHandler(resolve).withFailureHandler(reject).ping();
                });
            }

            // --- MULTI-BACKEND ROUTING ---
            const engine = document.getElementById('propStorageEngine').value || formConfig.storageEngine || 'gas';

            if (engine === 'firebase') {
                // Firebase is already initialized globally
                if (!db) return { status: 'error', message: 'Firebase not initialized. Check your console for errors.' };

                try {
                    if (action === 'saveForm') {
                        console.log("ðŸ“¤ Firestore: Saving form...", payload.formId);

                        // Create a timeout promise
                        const timeout = new Promise((_, reject) =>
                            setTimeout(() => {
                                console.error("TIMEOUT REACHED");
                                reject(new Error("Request timed out (10s) - Firebase is not responding. Check your internet connection."));
                            }, 10000)
                        );

                        const saveOp = (async () => {
                            console.log("ðŸ”¥ callApi: Starting Firestore Write...");
                            await db.collection('forms').doc(payload.formId).set({
                                id: payload.formId,
                                schema: payload.schema,
                                config: payload.config,
                                metadata: payload.metadata,
                                lastUpdated: Date.now()
                            });
                            console.log("ðŸ”¥ callApi: Firestore Write 1 Done");

                            // Vanity Mapping for Single Forms
                            if (payload.config && payload.config.slug) {
                                console.log("files: Creating form vanity mapping for...", payload.config.slug);
                                await db.collection('form_slugs').doc(payload.config.slug.toLowerCase()).set({
                                    formId: payload.formId,
                                    apiUrl: payload.config.gasApiUrl || localStorage.getItem('gasApiUrl'),
                                    storageEngine: payload.config.storageEngine || 'firebase',
                                    lastUpdated: Date.now()
                                });
                            }
                            return true;
                        })();

                        // Race against timeout
                        await Promise.race([saveOp, timeout]);

                        console.log("âœ… Firestore: Save Successful");
                        return { status: 'success' };
                    } else if (action === 'getForm') {
                        console.log("ðŸ“¥ Firestore: Loading form...", payload.formId);
                        const doc = await db.collection('forms').doc(payload.formId).get();
                        if (!doc.exists) return { status: 'error', message: 'Form not found in Firestore' };
                        return { status: 'success', ...doc.data() };
                    } else if (action === 'listTemplates') {
                        console.log("ðŸ” Firestore: Querying 'forms' collection...");
                        let snapshot;
                        try {
                            // Try without orderBy first to avoid index requirements
                            snapshot = await db.collection('forms').get();
                            console.log(`ðŸ“„ Firestore: Found ${snapshot.size} documents in 'forms'`);
                        } catch (qErr) {
                            console.error("âŒ Firestore Query Fail:", qErr);
                            return { status: 'error', message: 'Query Failed: ' + qErr.message };
                        }

                        const forms = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            console.log("ðŸ“ Processing Doc:", doc.id, data);
                            forms.push({
                                id: doc.id,
                                name: data.formName || (data.config && data.config.formName) || doc.id,
                                description: data.description || (data.metadata && data.metadata.description) || '',
                                lastUpdated: data.lastUpdated || Date.now()
                            });
                        });

                        // Sort manually in JS to avoid Firestore index requirement
                        forms.sort((a, b) => b.lastUpdated - a.lastUpdated);

                        return { status: 'success', templates: forms };
                    } else if (action === 'savePortalConfig') {
                        // Standard global config
                        await db.collection('config').doc('portal').set(payload.config);

                        // Vanity Slug Mapping
                        if (payload.config.slug) {
                            console.log("ðŸ“‚ Firestore: Creating vanity mapping for...", payload.config.slug);
                            await db.collection('portals').doc(payload.config.slug).set({
                                config: payload.config,
                                lastUpdated: Date.now()
                            });
                        }
                        return { status: 'success' };
                    } else if (action === 'getPortalConfig') {
                        const doc = await db.collection('config').doc('portal').get();
                        if (!doc.exists) return { status: 'error', message: 'Portal config not found' };
                        return { status: 'success', config: doc.data() };
                    } else if (action === 'deleteForm') {
                        await db.collection('forms').doc(payload.formId).delete();
                        return { status: 'success' };
                    } else if (action === 'ping') {
                        return { status: 'success', message: 'Firestore connected' };
                    }
                } catch (err) {
                    console.error("ðŸ”¥ Firestore Error:", err);
                    return { status: 'error', message: 'Firestore Error: ' + err.message };
                }
            }

            // Priority 2: GAS fetch (if hosted externally, e.g. GitHub Pages)
            const apiUrl = document.getElementById('propApiUrl').value || formConfig.gasApiUrl;
            if (!apiUrl) {
                return { status: 'error', message: 'GAS API URL not configured in settings.' };
            }
            // Sync back to config and storage
            formConfig.gasApiUrl = apiUrl;
            localStorage.setItem('gasApiUrl', apiUrl);

            try {
                const postActions = ['saveForm', 'submitForm', 'translateText', 'savePortalConfig', 'deleteForm'];
                if (postActions.includes(action)) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...payload })
                    });
                    return { status: 'success', message: 'Payload sent.' };
                } else {
                    let url = `${apiUrl}?action=${action}`;
                    if (payload.formId) url += `&id=${payload.formId}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                    return await response.json();
                }
            } catch (err) {
                console.error("API Call Error:", err);
                return { status: 'error', message: 'Connection Error: ' + err.toString() };
            }
        }

        // STATE
        let elements = []; // Array of { id, type, x, y, props }
        let selectedIds = []; // Array of strings
        let formConfig = {
            id: 'Form_' + Date.now(),
            formName: 'New Form',
            description: '',
            allowedDomains: '',
            sheetUrl: '',
            sheetName: 'Form Responses',
            language: 'mr', // Legacy field for compat
            languagePrimary: 'en',
            languageSecondary: 'mr',
            slug: '',
            customDomain: localStorage.getItem('customDomain') || '',
            gasApiUrl: localStorage.getItem('gasApiUrl') || '',
            storageEngine: localStorage.getItem('storageEngine') || 'firebase',
            firebaseConfig: localStorage.getItem('firebaseConfig') || '',
            // Branding Fields
            headerTitle: '',
            logoIcon: '',
            logoUrl: '',
            punchline: '',
            brandingDescription: '',
            footerText: '',
            displayMode: 'full', // 'full' or 'card'
            workspaceId: new URLSearchParams(window.location.search).get('workspaceId') || null
        };

        // DOM REFERENCES
        const canvas = document.getElementById('formCanvas');
        const elmPropsPanel = document.getElementById('elementProps');
        const globalPropsPanel = document.getElementById('globalProps');

        // INIT
        document.getElementById('propFormId').value = formConfig.id;
        document.getElementById('headerFormId').innerText = formConfig.id;
        document.getElementById('propFormName').value = formConfig.formName;
        document.getElementById('headerFormNameInput').value = formConfig.formName;
        document.getElementById('propStorageEngine').value = formConfig.storageEngine;
        document.getElementById('propFirebaseConfig').value = formConfig.firebaseConfig;

        function toggleBackendConfig() {
            const engine = document.getElementById('propStorageEngine').value;
            const configArea = document.getElementById('firebaseConfigArea');
            if (engine === 'firebase') {
                configArea.classList.remove('hidden');
            } else {
                configArea.classList.add('hidden');
            }
        }
        toggleBackendConfig();

        // --- ADMIN SECURITY ---
        function unlockAdminSettings() {
            const pass = prompt("Enter Admin Password:");
            if (pass === "admin123") {
                sessionStorage.setItem('admin_unlocked', 'true');
                applyAdminVisibility();
            } else {
                alert("âŒ Incorrect password.");
            }
        }

        function lockAdminSettings() {
            sessionStorage.removeItem('admin_unlocked');
            applyAdminVisibility();
        }

        function applyAdminVisibility() {
            const isUnlocked = sessionStorage.getItem('admin_unlocked') === 'true';
            const unlockBtn = document.getElementById('adminUnlockArea');
            const adminArea = document.getElementById('adminSettingsArea');

            if (isUnlocked) {
                unlockBtn.classList.add('hidden');
                adminArea.classList.remove('hidden');
            } else {
                unlockBtn.classList.remove('hidden');
                adminArea.classList.add('hidden');
            }
        }
        applyAdminVisibility();

        // Sync both name inputs works on either update
        function syncFormName(val, source) {
            formConfig.formName = val;
            if (source !== 'header') document.getElementById('headerFormNameInput').value = val;
            if (source !== 'props') document.getElementById('propFormName').value = val;
        }

        const safeAddListener = (id, event, handler) => {
            const el = document.getElementById(id);
            if (el) el.addEventListener(event, handler);
        };

        safeAddListener('propFormName', 'input', (e) => syncFormName(e.target.value, 'props'));
        safeAddListener('headerFormNameInput', 'input', (e) => syncFormName(e.target.value, 'header'));

        safeAddListener('propDescription', 'input', (e) => formConfig.description = e.target.value);
        safeAddListener('propAllowedDomains', 'input', (e) => formConfig.allowedDomains = e.target.value);

        safeAddListener('propSheetUrl', 'input', (e) => formConfig.sheetUrl = e.target.value);
        safeAddListener('propSheetName', 'input', (e) => formConfig.sheetName = e.target.value);

        if (document.getElementById('propLanguagePrimary')) document.getElementById('propLanguagePrimary').value = formConfig.languagePrimary;
        if (document.getElementById('propLanguageSecondary')) document.getElementById('propLanguageSecondary').value = formConfig.languageSecondary;
        if (document.getElementById('propApiUrl')) {
            document.getElementById('propApiUrl').value = formConfig.gasApiUrl;
            document.getElementById('propApiUrl').addEventListener('input', (e) => {
                formConfig.gasApiUrl = e.target.value;
                localStorage.setItem('gasApiUrl', e.target.value);
            });
        }

        // --- SIDEBAR TABS ---
        function switchSidebarTab(tab) {
            currentSidebarTab = tab; // Update tracker
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            if (tab === 'elements') {
                document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
                document.getElementById('panelElements').classList.add('active');
            } else if (tab === 'portal') {
                document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
                document.getElementById('panelPortal').classList.add('active');
                refreshPortalList();
            } else if (tab === 'branding') {
                document.querySelector('.sidebar-tab:nth-child(3)').classList.add('active');
                document.getElementById('panelBranding').classList.add('active');
                updateCanvasBranding(); // Ensure canvas matches sidebar
            }
        }


        function updateFormLanguage() {
            formConfig.languagePrimary = document.getElementById('propLanguagePrimary').value;
            formConfig.languageSecondary = document.getElementById('propLanguageSecondary').value;
            formConfig.language = formConfig.languageSecondary; // Sync for compat

            const l1Name = document.getElementById('propLanguagePrimary').selectedOptions[0].text.split(' ')[0];
            const l2Name = document.getElementById('propLanguageSecondary').selectedOptions[0].text.split(' ')[0];

            document.getElementById('lblPropPrimary').innerText = `Field Label (${l1Name})`;
            document.getElementById('lblPropSecondary').innerText = `Field Label (${l2Name})`;
            document.getElementById('lblPropTranslatable').innerText = `Enable Translation (${l1Name} -> ${l2Name})`;

            // Trigger refresh of canvas elements to show new labels if needed
            elements.forEach(elm => {
                const dom = document.getElementById(elm.id);
                if (dom) renderElementVisual(elm, dom);
            });
        }


        // --- DRAG AND DROP (SIDEBAR TO CANVAS) ---
        function handleDragStart(e) {
            // Use currentTarget to ensure we get the div with data-type, even if icon/text was clicked
            e.dataTransfer.setData("type", e.currentTarget.dataset.type);
            e.dataTransfer.effectAllowed = "copy";
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const type = e.dataTransfer.getData("type");
            if (!type) return; // Might be internal move

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            addElement(type, x, y);
        }

        // --- INTERNAL DRAG (POSITIONING) ---
        // We'll implement a simple mousedown/move/up for the absolute positioned elements
        // Attached in render logic

        // --- CORE LOGIC ---
        function addElement(type, x, y) {
            const id = 'elm_' + Date.now();
            const actualType = (type === 'separator' || type === 'form_title' || type === 'punchline') ? 'cosmetic' : (type === 'logo' ? 'image' : type);

            // Branding defaults
            let defaultLabel = 'New ' + actualType;
            if (type === 'form_title') defaultLabel = formConfig.formName || 'Form Title';
            if (type === 'punchline') defaultLabel = 'Your Tagline Here';
            if (type === 'logo') defaultLabel = '';

            // Determine purpose and branding style based on type
            const isBrandingType = ['form_title', 'punchline', 'logo', 'label'].includes(type);
            const purpose = isBrandingType ? 'branding' : 'form';
            let brandingStyle = 'default';

            if (type === 'form_title') brandingStyle = 'title';
            else if (type === 'punchline') brandingStyle = 'subtitle';
            else if (type === 'logo') brandingStyle = 'logo';
            else if (type === 'label') brandingStyle = 'label';

            const newElm = {
                id: id,
                type: type, // Keep original type for rendering specific logic
                x: x,
                y: y,
                props: {
                    label: defaultLabel,
                    name: type + '_' + Math.floor(Math.random() * 1000),
                    required: false,
                    translatable: type === 'text',
                    width: type === 'logo' ? 100 : (type === 'form_title' ? 400 : (type === 'separator' ? 700 : 200)),
                    height: type === 'logo' ? 100 : 40,
                    // Color properties for all elements
                    textColor: '#000000',
                    backgroundColor: 'transparent',
                    borderColor: '#cccccc',
                    opacity: 100,
                    padding: 8,
                    shadow: false,
                    // Purpose and Branding
                    purpose: purpose,
                    brandingStyle: brandingStyle,
                    // Cosmetics
                    headingLevel: type === 'form_title' ? 'h1' : 'h2',
                    align: (type === 'form_title' || type === 'punchline' || type === 'logo') ? 'center' : 'left',
                    fontSize: type === 'form_title' ? 28 : (type === 'punchline' ? 16 : 14),
                    isBold: type === 'form_title' || type === 'logo' ? true : false,
                    // Image specific
                    imageUrl: type === 'logo' ? 'https://via.placeholder.com/150?text=Logo' : '',
                    // Shape Styles
                    strokeWidth: (type === 'line' || type === 'rect') ? 2 : 0,
                    borderStyle: 'solid',
                    borderRadius: (type === 'logo') ? 8 : 0,
                    // Grouping
                    groupId: null
                }
            };
            elements.push(newElm);
            renderElementDOM(newElm);
            selectElement(id);
        }

        function renderElementDOM(elmData) {
            const div = document.createElement('div');
            div.id = elmData.id;
            div.className = 'canvas-element';
            div.style.left = elmData.x + 'px';
            div.style.top = elmData.y + 'px';

            // Content based on type
            let content = '';
            if (['text', 'date', 'number', 'file', 'email', 'dropdown', 'textarea', 'paragraph', 'counter', 'image', 'logo', 'repeater'].includes(elmData.type)) {
                let inputHtml = "";
                if (elmData.type === 'dropdown') {
                    inputHtml = `<div class="preview-input" style="height:30px; background:#eee; display:flex; align-items:center; padding:0 10px; font-size:12px; font-weight:700;">Select Option <svg width="12" height="12" style="margin-left:auto"><polyline points="3 4 6 7 9 4" fill="none" stroke="black"/></svg></div>`;
                } else if (elmData.type === 'repeater') {
                    inputHtml = `<div class="preview-input" style="height:35px; border:1px dashed #2563eb; background:#eff6ff; display:flex; align-items:center; justify-content:center; color:#2563eb; font-weight:700; font-size:12px;">+ Add New Item</div>`;
                } else if (elmData.type === 'image' || elmData.type === 'logo') {
                    const url = elmData.props.imageUrl || 'https://via.placeholder.com/150?text=Upload+Image';
                    div.style.width = (elmData.props.width || 150) + 'px';
                    div.style.height = (elmData.props.height || 100) + 'px';
                    inputHtml = `<img src="${url}" style="width:100%; height:100%; object-fit:contain; border-radius:${elmData.props.borderRadius || 0}px; border:${elmData.props.strokeWidth || 0}px solid #ccc;">`;
                } else if (elmData.type === 'textarea' || elmData.type === 'paragraph') {
                    inputHtml = `<div class="preview-input" style="height:${elmData.type === 'paragraph' ? '60px' : '40px'}; background:#eee;"></div>`;
                } else {
                    inputHtml = `<div class="preview-input" style="height: 30px; background: #eee;"></div>`;
                }

                if (elmData.type === 'logo' || elmData.type === 'image') {
                    content = inputHtml;
                } else {
                    content = `
                        <label class="preview-label" style="font-weight:${elmData.props.isBold ? 'bold' : 'normal'}; font-size:${elmData.props.fontSize || 12}px">${elmData.props.label}${elmData.props.required ? '*' : ''}</label>
                        ${inputHtml}
                    `;
                }
            } else if (elmData.type === 'heading' || elmData.type === 'form_title') {
                div.style.width = (elmData.props.width || 300) + 'px';
                const tag = elmData.type === 'form_title' ? 'h1' : (elmData.props.headingLevel || 'h2');
                const border = elmData.type === 'form_title' ? 'none' : '2px solid #333';
                content = `<${tag} style="margin:0; border-bottom: ${border}; font-size:${elmData.props.fontSize || (elmData.type === 'form_title' ? 28 : 20)}px; font-weight:${elmData.props.isBold ? '700' : '400'};">${elmData.props.label || 'Section Heading'}</${tag}>`;
            } else if (elmData.type === 'rect') {
                div.style.width = elmData.props.width + 'px';
                div.style.height = elmData.props.height + 'px';
                div.style.border = `${elmData.props.strokeWidth || 2}px ${elmData.props.borderStyle || 'solid'} #000`;
                div.style.borderRadius = (elmData.props.borderRadius || 0) + 'px';
                div.style.background = 'transparent';
            } else if (elmData.type === 'line' || elmData.type === 'separator') {
                div.style.width = (elmData.props.width || 200) + 'px';
                div.style.height = (elmData.props.strokeWidth || 2) + 10 + 'px';
                div.style.borderTop = `${elmData.props.strokeWidth || 2}px ${elmData.props.borderStyle || 'solid'} #000`;
                div.style.background = 'transparent';
            } else if (elmData.type === 'label' || elmData.type === 'punchline') {
                const color = elmData.type === 'punchline' ? '#666' : 'inherit';
                const style = elmData.type === 'punchline' ? 'italic' : 'normal';
                content = `<span style="font-weight:${elmData.props.isBold ? 'bold' : 'normal'}; font-size:${elmData.props.fontSize || 14}px; color:${color}; font-style:${style}">${elmData.props.label || 'Label Text'}</span>`;
            }

            div.innerHTML = content;
            div.style.textAlign = elmData.props.align || 'left';

            // ADD RESIZE HANDLES for ALL elements (universal resizing)
            {
                const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
                handles.forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = `resize-handle handle-${pos}`;
                    handle.dataset.handleType = pos;
                    handle.dataset.elementId = elmData.id;
                    handle.onmousedown = (e) => {
                        e.stopPropagation();
                        handleResizeStart(e, elmData.id, pos);
                    };
                    div.appendChild(handle);
                });
            }

            // ATTACH INTERACTIONS
            div.onmousedown = (e) => {
                // If we're not already dragging, and it's a left click
                if (e.button === 0) {
                    // Selection logic is handled globally via window.mousedown, 
                    // but we need to ensure this element is recognized as .canvas-element
                }
            };

            canvas.appendChild(div);
        }

        // --- BRANDING WYSIWYG ---
        function updateCanvasBranding() {
            const hTitle = document.getElementById('propHeaderTitle').value;
            const lIcon = document.getElementById('propLogoIcon').value;
            const lUrl = document.getElementById('propLogoUrl').value;
            const punch = document.getElementById('propPunchline').value;
            const footer = document.getElementById('propFooterText').value;
            const desc = document.getElementById('propBrandingDescription').value;
            const isCard = document.getElementById('propDisplayMode').checked;

            const headerZone = document.getElementById('canvasBrandingHeader');
            const footerZone = document.getElementById('canvasBrandingFooter');
            const canvasArea = document.getElementById('canvasArea');

            // 1. Header Logic
            if (!hTitle && !lIcon && !lUrl && !punch) {
                headerZone.style.display = 'none';
            } else {
                headerZone.style.display = 'flex';

                const logoDiv = headerZone.querySelector('.canvas-branding-logo');
                if (lUrl) {
                    logoDiv.innerHTML = `<img src="${lUrl}" alt="Logo">`;
                } else {
                    logoDiv.innerText = lIcon;
                }

                headerZone.querySelector('.canvas-branding-title').innerText = hTitle;
                headerZone.querySelector('.canvas-branding-punchline').innerText = punch;
                headerZone.querySelector('.canvas-branding-desc').innerText = desc;
            }

            // 2. Footer Logic
            if (!footer) {
                footerZone.style.display = 'none';
            } else {
                footerZone.style.display = 'flex';
                footerZone.querySelector('.canvas-branding-footer-text').innerText = footer;
            }

            // 3. Card Mode Simulation
            if (isCard) {
                canvasArea.classList.add('card-mode');
            } else {
                canvasArea.classList.remove('card-mode');
            }
        }

        // Modified Selection Logic
        function selectElement(id, multiSelect = false) {
            const targetElm = elements.find(e => e.id === id);
            if (!targetElm) return;

            // 1. Group Logic: If target is part of a group, select the WHOLE group
            let idsToSelect = [id];
            if (targetElm.props.groupId) {
                idsToSelect = elements.filter(e => e.props.groupId === targetElm.props.groupId).map(e => e.id);
            }

            // 2. Multi-Select Logic (Shift)
            if (multiSelect) {
                idsToSelect.forEach(newId => {
                    if (!selectedIds.includes(newId)) selectedIds.push(newId);
                });
            } else {
                selectedIds = idsToSelect; // Replace selection
            }

            renderSelectionState();
            updatePropsPanel();
        }

        function renderSelectionState() {
            document.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));
            selectedIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('selected');
            });
        }

        // TAB SWITCHING LOGIC
        function switchTab(tabId) {
            // Update Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Update Content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            const targetContent = document.getElementById('tab-' + tabId);
            if (targetContent) {
                targetContent.style.display = 'block'; // Ensure block display
                targetContent.classList.add('active');
            }
        }

        function updatePropsPanel() {
            const elmProps = document.getElementById('elementProps');
            const designProps = document.getElementById('designProps');
            const emptyProps = document.getElementById('propEmptyState');
            const emptyDesign = document.getElementById('designEmptyState');

            if (selectedIds.length === 0) {
                showGlobalProps();
                return;
            }

            // Switch to Properties tab by default if we were in Settings
            // Or keep current if it's Properties or Design
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab || activeTab.id === 'tab-settings') {
                switchTab('properties');
            }

            // Show Content Containers
            elmProps.style.display = 'block';
            designProps.style.display = 'block';
            if (emptyProps) emptyProps.style.display = 'none';
            if (emptyDesign) emptyDesign.style.display = 'none';

            globalPropsPanel.classList.add('hidden'); // Ensure global is hidden safely

            if (selectedIds.length > 1) {
                // Multi-selection: Show Summary (Feature TODO: Multi-edit)
                // For now just show "Multi Selection"
                return;
            }

            // Single Selection
            const id = selectedIds[0];
            const elm = elements.find(e => e.id === id);
            if (!elm) return;

            // --- TAB: PROPERTIES (DATA) ---
            document.getElementById('propId').value = elm.id;
            document.getElementById('propType').value = elm.type;

            document.getElementById('propLabel').value = elm.props.label || '';
            document.getElementById('propLabelRegional').value = elm.props.labelRegional || '';
            document.getElementById('propName').value = elm.props.name || '';
            document.getElementById('propRequired').checked = elm.props.required;
            document.getElementById('propTranslatable').checked = elm.props.translatable;
            document.getElementById('propOptions').value = elm.props.options || '';
            document.getElementById('propPlaceholder').value = elm.props.placeholder || '';
            document.getElementById('propImageUrl').value = elm.props.imageUrl || '';
            document.getElementById('propSyncConfig').checked = elm.props.syncConfig || false;

            // Visibility Logic for Data Props
            const t = elm.type;
            const setDisplay = (id, show) => {
                const el = document.getElementById(id);
                if (el) el.style.display = show ? 'block' : 'none';
            };
            const setDisplayFlex = (id, show) => {
                const el = document.getElementById(id);
                if (el) el.style.display = show ? 'flex' : 'none';
            };

            // Purpose & Branding
            const purpose = elm.props.purpose || (['form_title', 'punchline', 'logo'].includes(t) ? 'branding' : 'form');
            const brandingStyle = elm.props.brandingStyle || 'default';
            document.getElementById('propPurpose').value = purpose;
            document.getElementById('propBrandingStyle').value = brandingStyle;

            setDisplay('grpBrandingStyle', purpose === 'branding');

            const isFormField = purpose === 'form';
            // Hide/Show functional groups
            document.getElementById('propRequired').parentElement.style.display = isFormField ? 'flex' : 'none';
            document.getElementById('propTranslatable').parentElement.style.display = isFormField ? 'flex' : 'none';
            document.getElementById('propName').parentElement.style.display = isFormField ? 'block' : 'none';
            document.getElementById('propLabel').parentElement.style.display = 'block'; // Always show label?

            setDisplay('grpOptions', t === 'dropdown');
            setDisplay('grpPlaceholder', isFormField && !['rect', 'line', 'separator', 'repeater', 'logo', 'image', 'form_title', 'punchline'].includes(t));
            setDisplay('grpImageUrl', t === 'image' || t === 'logo');
            setDisplay('grpSyncConfig', t === 'form_title' || t === 'punchline' || t === 'logo');

            // --- TAB: DESIGN (VISUALS) ---
            document.getElementById('propX').value = elm.x;
            document.getElementById('propY').value = elm.y;

            // Dimensions
            const hasSize = true;
            setDisplay('grpWidth', hasSize);
            document.getElementById('propWidth').value = elm.props.width || 100;

            setDisplay('grpHeight', hasSize && t !== 'line' && t !== 'separator');
            if (t !== 'line' && t !== 'separator') {
                document.getElementById('propHeight').value = elm.props.height || 100;
            }

            // Typography
            document.getElementById('propHeadingLevel').value = elm.props.headingLevel || 'h2';
            document.getElementById('propAlign').value = elm.props.align || 'left';
            document.getElementById('propFontSize').value = elm.props.fontSize || 14;
            document.getElementById('propBold').checked = elm.props.isBold || false;

            setDisplay('grpHeadingLevel', t === 'heading');
            setDisplay('grpAlign', ['heading', 'label', 'form_title', 'punchline', 'logo', 'image', 'paragraph'].includes(t));
            setDisplay('grpFontSize', ['label', 'form_title', 'punchline', 'paragraph', 'heading'].includes(t));
            setDisplayFlex('grpBold', ['label', 'form_title', 'punchline', 'paragraph', 'heading'].includes(t));

            // Shapes & Borders
            const isShape = t === 'rect' || t === 'line' || t === 'separator';
            document.getElementById('propStrokeWidth').value = elm.props.strokeWidth || 2;
            document.getElementById('propBorderStyle').value = elm.props.borderStyle || 'solid';
            document.getElementById('propBorderRadius').value = elm.props.borderRadius || 0;

            setDisplay('grpStrokeWidth', isShape || t === 'image' || t === 'logo' || t === 'rect');
            setDisplay('grpBorderStyle', isShape || t === 'rect');
            setDisplay('grpBorderRadius', t === 'rect' || t === 'image' || t === 'logo');

            // Colors (Always visible now)
            setDisplay('grpTextColor', true);
            setDisplay('grpBackgroundColor', true);
            setDisplay('grpBorderColor', true);

            // Advanced Effects (Always visible)
            setDisplay('grpOpacity', true);
            setDisplay('grpPadding', true);
            setDisplay('grpShadow', true);

            // Populate Color Inputs
            const updateColorInput = (id, val) => {
                const input = document.getElementById(id);
                const hexInput = document.getElementById(id + 'Hex');
                if (input) input.value = val || '#000000';
                if (hexInput) hexInput.value = val || '#000000';
            };

            updateColorInput('propTextColor', elm.props.textColor);
            updateColorInput('propBackgroundColor', elm.props.backgroundColor);
            updateColorInput('propBorderColor', elm.props.borderColor);

            document.getElementById('propOpacity').value = elm.props.opacity !== undefined ? elm.props.opacity : 100;
            if (document.getElementById('opacityValue')) document.getElementById('opacityValue').innerText = (elm.props.opacity !== undefined ? elm.props.opacity : 100) + '%';

            document.getElementById('propPadding').value = elm.props.padding || 8;
            document.getElementById('propShadow').checked = elm.props.shadow || false;
        }

        function triggerFileUpload() {
            document.getElementById('propFileUpload').click();
        }

        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('propImageUrl').value = e.target.result;
                updateSelectedElement();
            };
            reader.readAsDataURL(file);
        }

        function showGlobalProps() {
            selectedIds = [];
            renderSelectionState();

            // Switch to Settings Tab
            switchTab('settings');
            if (globalPropsPanel) globalPropsPanel.classList.remove('hidden');

            // Ensure Global Props is visible (though switchTab handles parent visibility)
            // We just need to populate data

            document.getElementById('propHeaderTitle').value = formConfig.headerTitle || '';
            document.getElementById('propLogoIcon').value = formConfig.logoIcon || ''; // Default empty now
            document.getElementById('propLogoUrl').value = formConfig.logoUrl || '';
            document.getElementById('propPunchline').value = formConfig.punchline || '';
            document.getElementById('propBrandingDescription').value = formConfig.brandingDescription || '';
            document.getElementById('propFooterText').value = formConfig.footerText || '';
            document.getElementById('propDisplayMode').checked = (formConfig.displayMode === 'card');

            updateCanvasBranding();
        }

        // SINGLE ELEMENT UPDATE (Only when 1 selected)
        function updateSelectedElement() {
            if (selectedIds.length !== 1) return;
            const selectedId = selectedIds[0];
            const elm = elements.find(e => e.id === selectedId);

            elm.props.label = document.getElementById('propLabel').value;
            elm.props.labelRegional = document.getElementById('propLabelRegional').value;
            elm.props.name = document.getElementById('propName').value;
            elm.props.required = document.getElementById('propRequired').checked;
            elm.props.translatable = document.getElementById('propTranslatable').checked;
            elm.props.options = document.getElementById('propOptions').value;
            elm.props.placeholder = document.getElementById('propPlaceholder').value;

            // Style Props
            elm.props.headingLevel = document.getElementById('propHeadingLevel').value;
            elm.props.align = document.getElementById('propAlign').value;
            elm.props.fontSize = parseInt(document.getElementById('propFontSize').value) || 14;
            elm.props.isBold = document.getElementById('propBold').checked;

            // Purpose and Branding Style
            const newPurpose = document.getElementById('propPurpose').value;
            const newBrandingStyle = document.getElementById('propBrandingStyle').value;
            const oldPurpose = elm.props.purpose;

            elm.props.purpose = newPurpose;
            elm.props.brandingStyle = newBrandingStyle;

            // Auto-apply styling based on branding style
            if (newPurpose === 'branding' && newBrandingStyle) {
                if (newBrandingStyle === 'title') {
                    elm.props.fontSize = 28;
                    elm.props.isBold = true;
                    elm.props.align = 'center';
                    document.getElementById('propFontSize').value = 28;
                    document.getElementById('propBold').checked = true;
                    document.getElementById('propAlign').value = 'center';
                } else if (newBrandingStyle === 'subtitle') {
                    elm.props.fontSize = 16;
                    elm.props.isBold = false;
                    elm.props.align = 'center';
                    document.getElementById('propFontSize').value = 16;
                    document.getElementById('propBold').checked = false;
                    document.getElementById('propAlign').value = 'center';
                } else if (newBrandingStyle === 'label') {
                    elm.props.fontSize = 14;
                    elm.props.isBold = false;
                    elm.props.align = 'left';
                    document.getElementById('propFontSize').value = 14;
                    document.getElementById('propBold').checked = false;
                    document.getElementById('propAlign').value = 'left';
                }
            }

            // If purpose changed, refresh properties panel visibility
            if (oldPurpose !== newPurpose) {
                updatePropsPanel();
            }

            // Shape & Branding Props
            elm.props.strokeWidth = parseInt(document.getElementById('propStrokeWidth').value) || 0;
            elm.props.borderStyle = document.getElementById('propBorderStyle').value;
            elm.props.borderRadius = parseInt(document.getElementById('propBorderRadius').value) || 0;
            elm.props.imageUrl = document.getElementById('propImageUrl').value;
            elm.props.syncConfig = document.getElementById('propSyncConfig').checked;

            // Universal Styling Props
            elm.props.textColor = document.getElementById('propTextColor').value;
            elm.props.backgroundColor = document.getElementById('propBackgroundColor').value;
            elm.props.borderColor = document.getElementById('propBorderColor').value;
            elm.props.opacity = parseInt(document.getElementById('propOpacity').value) || 100;
            elm.props.padding = parseInt(document.getElementById('propPadding').value) || 0;
            elm.props.shadow = document.getElementById('propShadow').checked;

            // Update Label for Opacity
            document.getElementById('opacityValue').innerText = elm.props.opacity + '%';

            // Sync Hex Inputs
            document.getElementById('propTextColorHex').value = elm.props.textColor;
            document.getElementById('propBackgroundColorHex').value = elm.props.backgroundColor;
            document.getElementById('propBorderColorHex').value = elm.props.borderColor;

            // Sync Logic
            if (elm.props.syncConfig) {
                if (elm.type === 'form_title') formConfig.formName = elm.props.label;
                if (elm.type === 'punchline') formConfig.punchline = elm.props.label;
                if (elm.type === 'logo') formConfig.logoUrl = elm.props.imageUrl;
                // Update Sidebar Branding Panel UI if open
                if (currentSidebarTab === 'branding') showGlobalProps();
            }

            // Re-render visual content
            const dom = document.getElementById(selectedId);
            if (dom) renderElementVisual(elm, dom);
        }

        function renderElementVisual(elm, dom) {
            if (!dom) return;
            const t = elm.type;
            const p = elm.props;

            const separator = (p.label && p.labelRegional) ? ' / ' : '';
            const regLabel = p.labelRegional ? separator + p.labelRegional : '';
            const fullLabel = (p.label || '') + regLabel;

            // Update Base Styles
            dom.style.textAlign = p.align || 'left';

            // Apply universal styling
            if (p.textColor) dom.style.color = p.textColor;
            if (p.backgroundColor && p.backgroundColor !== 'transparent') {
                dom.style.backgroundColor = p.backgroundColor;
            } else {
                dom.style.backgroundColor = ''; // Clear if transparent
            }
            if (p.borderColor) {
                dom.style.borderColor = p.borderColor;
            }
            if (p.opacity !== undefined && p.opacity < 100) {
                dom.style.opacity = p.opacity / 100;
            } else {
                dom.style.opacity = 1;
            }
            if (p.padding) dom.style.padding = p.padding + 'px';

            if (p.shadow) {
                dom.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            } else {
                dom.style.boxShadow = 'none';
            }

            // Re-render based on type
            if (['text', 'date', 'number', 'file', 'email', 'dropdown', 'textarea', 'paragraph', 'counter', 'image', 'logo', 'repeater'].includes(t)) {
                if (t === 'logo' || t === 'image') {
                    const img = dom.querySelector('img');
                    if (img) {
                        img.src = p.imageUrl || 'https://via.placeholder.com/150?text=Upload+Image';
                        img.style.borderRadius = (p.borderRadius || 0) + 'px';
                        img.style.border = `${p.strokeWidth || 0}px solid #ccc`;
                    }
                    dom.style.width = (p.width || (t === 'logo' ? 100 : 150)) + 'px';
                    dom.style.height = (p.height || (t === 'logo' ? 100 : 100)) + 'px';
                } else {
                    const labelEl = dom.querySelector('.preview-label');
                    if (labelEl) {
                        labelEl.innerHTML = fullLabel + (p.required ? '*' : '');
                        labelEl.style.fontWeight = p.isBold ? 'bold' : 'normal';
                        labelEl.style.fontSize = (p.fontSize || 12) + 'px';
                    }
                }
            } else if (t === 'heading' || t === 'form_title') {
                const tag = t === 'form_title' ? 'h1' : (p.headingLevel || 'h2');
                let head = dom.querySelector('h1, h2, h3, h4');

                // If tag changed, we might need to recreate it but for simplicity, just update content/style
                if (head) {
                    head.innerText = fullLabel || (t === 'form_title' ? 'Form Title' : 'Section Heading');
                    head.style.fontSize = (p.fontSize || (t === 'form_title' ? 28 : 20)) + 'px';
                    head.style.fontWeight = p.isBold ? '700' : '400';
                    head.style.borderBottom = t === 'form_title' ? 'none' : '2px solid #333';
                }
                dom.style.width = (p.width || 300) + 'px';
            } else if (t === 'rect') {
                dom.style.width = p.width + 'px';
                dom.style.height = p.height + 'px';
                dom.style.border = `${p.strokeWidth || 2}px ${p.borderStyle || 'solid'} #000`;
                dom.style.borderRadius = (p.borderRadius || 0) + 'px';
            } else if (t === 'line' || t === 'separator') {
                dom.style.width = (p.width || 200) + 'px';
                dom.style.height = (p.strokeWidth || 2) + 10 + 'px';
                dom.style.borderTop = `${p.strokeWidth || 2}px ${p.borderStyle || 'solid'} #000`;
            } else if (t === 'label' || t === 'punchline') {
                const span = dom.querySelector('span');
                if (span) {
                    span.innerText = fullLabel || (t === 'punchline' ? 'Your Tagline Here' : 'Label Text');
                    span.style.fontWeight = p.isBold ? 'bold' : 'normal';
                    span.style.fontSize = (p.fontSize || 14) + 'px';
                    if (t === 'punchline') {
                        span.style.color = '#666';
                        span.style.fontStyle = 'italic';
                    }
                }
            }
        }


        function duplicateSelected() {
            if (selectedIds.length === 0) return;

            const groupMap = {};
            const newIds = [];

            selectedIds.forEach(oldId => {
                const original = elements.find(e => e.id === oldId);
                if (!original) return;

                const newElm = JSON.parse(JSON.stringify(original));
                newElm.id = 'elm_' + Date.now() + '_' + Math.floor(Math.random() * 100);
                newElm.x += 20;
                newElm.y += 20;

                if (newElm.props.name) {
                    newElm.props.name = newElm.props.name.split('_copy')[0] + '_copy_' + Math.floor(Math.random() * 100);
                }

                // Group Remapping
                if (newElm.props.groupId) {
                    if (!groupMap[newElm.props.groupId]) {
                        groupMap[newElm.props.groupId] = 'grp_' + Date.now() + '_' + Math.random();
                    }
                    newElm.props.groupId = groupMap[newElm.props.groupId];
                }

                elements.push(newElm);
                renderElementDOM(newElm);
                newIds.push(newElm.id);
            });

            selectedIds = newIds;
            renderSelectionState();
            updatePropsPanel();
        }

        function deleteSelected() {
            if (selectedIds.length === 0) return;
            selectedIds.forEach(id => {
                const dom = document.getElementById(id);
                if (dom) dom.remove();
                elements = elements.filter(e => e.id !== id);
            });
            showGlobalProps();
        }

        // --- RESIZE LOGIC ---
        let activeResize = null;

        function handleResizeStart(e, elementId, handleType) {
            e.preventDefault();
            e.stopPropagation();

            const elm = elements.find(el => el.id === elementId);
            if (!elm) return;

            const dom = document.getElementById(elementId);
            if (!dom) return;

            const rect = dom.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();

            activeResize = {
                elementId: elementId,
                handleType: handleType,
                startX: e.clientX,
                startY: e.clientY,
                startWidth: elm.props.width || rect.width,
                startHeight: elm.props.height || rect.height,
                startPosX: elm.x,
                startPosY: elm.y,
                canvasX: canvasRect.left,
                canvasY: canvasRect.top
            };

            // Set cursor on body to maintain during drag
            document.body.style.cursor = dom.querySelector(`.handle-${handleType}`).style.cursor;
        }

        // --- ELEMENT DRAGGING LOGIC ---
        let activeDrag = null;

        // Global Mouse Controllers
        window.addEventListener('mousedown', (e) => {
            // HANDLE CANVAS ELEMENT CLICK (SELECT & PREPARE DRAG)
            const target = e.target.closest('.canvas-element');
            if (target) {
                e.preventDefault(); // Prevent text selection
                const id = target.id;

                // Select Logic (Shift key?)
                selectElement(id, e.shiftKey);

                // Prepare Drag for ALL Selected Items
                // Calculate offsets for ALL items relative to mouse
                const canvasRect = canvas.getBoundingClientRect();

                const dragMap = {};
                selectedIds.forEach(selId => {
                    const el = elements.find(el => el.id === selId);
                    const elDOM = document.getElementById(selId);
                    if (el && elDOM) {
                        const rect = elDOM.getBoundingClientRect();
                        dragMap[selId] = {
                            offsetX: e.clientX - rect.left,
                            offsetY: e.clientY - rect.top
                        };
                        elDOM.style.cursor = 'grabbing';
                    }
                });

                activeDrag = {
                    canvasX: canvasRect.left,
                    canvasY: canvasRect.top,
                    dragMap: dragMap // ID -> {offsetX, offsetY}
                };
                return;
            }

            // HANDLE CLICK OUTSIDE (DESELECT)
            // If we clicked on Sidebar, Properties, or Header, do nothing
            if (e.target.closest('.sidebar') ||
                e.target.closest('.properties-panel') ||
                e.target.closest('header')) {
                return;
            }

            // Otherwise (e.g. empty canvas area), deselect
            showGlobalProps();
        });

        window.addEventListener('mousemove', (e) => {
            if (activeDrag) {
                // Move ALL selected items
                selectedIds.forEach(id => {
                    const offset = activeDrag.dragMap[id];
                    if (!offset) return;

                    const rawX = e.clientX - activeDrag.canvasX - offset.offsetX;
                    const rawY = e.clientY - activeDrag.canvasY - offset.offsetY;

                    // Snap to grid
                    const snappedX = Math.round(rawX / 10) * 10;
                    const snappedY = Math.round(rawY / 10) * 10;

                    // Update DOM
                    const dom = document.getElementById(id);
                    if (dom) {
                        dom.style.left = snappedX + 'px';
                        dom.style.top = snappedY + 'px';
                    }

                    // Update Model
                    const elm = elements.find(el => el.id === id);
                    if (elm) {
                        elm.x = snappedX;
                        elm.y = snappedY;
                    }
                });

                // Update Props Panel Live (only if single selection, else confusing)
                if (selectedIds.length === 1) {
                    const px = document.getElementById('propX');
                    const py = document.getElementById('propY');
                    const elm = elements.find(el => el.id === selectedIds[0]);
                    if (px && elm) px.value = elm.x;
                    if (py && elm) py.value = elm.y;
                }
            }

            // HANDLE RESIZE
            if (activeResize) {
                const elm = elements.find(el => el.id === activeResize.elementId);
                if (!elm) return;

                const dom = document.getElementById(activeResize.elementId);
                if (!dom) return;

                const deltaX = e.clientX - activeResize.startX;
                const deltaY = e.clientY - activeResize.startY;

                let newWidth = activeResize.startWidth;
                let newHeight = activeResize.startHeight;
                let newX = activeResize.startPosX;
                let newY = activeResize.startPosY;

                const h = activeResize.handleType;

                // Calculate new dimensions based on handle direction
                if (h.includes('e')) newWidth = activeResize.startWidth + deltaX;
                if (h.includes('w')) {
                    newWidth = activeResize.startWidth - deltaX;
                    newX = activeResize.startPosX + deltaX;
                }
                if (h.includes('s')) newHeight = activeResize.startHeight + deltaY;
                if (h.includes('n')) {
                    newHeight = activeResize.startHeight - deltaY;
                    newY = activeResize.startPosY + deltaY;
                }

                // Enforce minimum size
                newWidth = Math.max(20, newWidth);
                newHeight = Math.max(20, newHeight);

                // Update model
                elm.props.width = Math.round(newWidth);
                elm.props.height = Math.round(newHeight);
                elm.x = Math.round(newX);
                elm.y = Math.round(newY);

                // Update DOM
                dom.style.width = elm.props.width + 'px';
                dom.style.height = elm.props.height + 'px';
                dom.style.left = elm.x + 'px';
                dom.style.top = elm.y + 'px';

                // Update properties panel
                if (selectedIds.includes(activeResize.elementId)) {
                    const wInput = document.getElementById('propWidth');
                    const hInput = document.getElementById('propHeight');
                    const xInput = document.getElementById('propX');
                    const yInput = document.getElementById('propY');
                    if (wInput) wInput.value = elm.props.width;
                    if (hInput) hInput.value = elm.props.height;
                    if (xInput) xInput.value = elm.x;
                    if (yInput) yInput.value = elm.y;
                }

                // Re-render visual
                renderElementVisual(elm, dom);
            }
        });

        window.addEventListener('mouseup', () => {
            if (activeDrag) {
                selectedIds.forEach(selId => {
                    const elDOM = document.getElementById(selId);
                    if (elDOM) elDOM.style.cursor = ''; // Revert
                });
                activeDrag = null;
            }
            if (activeResize) {
                document.body.style.cursor = '';
                activeResize = null;
            }
        });

        // Manual Position Update from Inputs
        function updatePosFromInputs() {
            if (selectedIds.length !== 1) return;
            const id = selectedIds[0];
            const x = parseInt(document.getElementById('propX').value) || 0;
            const y = parseInt(document.getElementById('propY').value) || 0;

            const elm = elements.find(e => e.id === id);
            if (elm) {
                elm.x = x;
                elm.y = y;

                const dom = document.getElementById(id);
                if (dom) {
                    dom.style.left = x + 'px';
                    dom.style.top = y + 'px';
                }
            }
        }


        // Manual Dimension Update from Inputs
        function updateDimensionsFromInputs() {
            if (selectedIds.length !== 1) return;
            const id = selectedIds[0];
            const elm = elements.find(e => e.id === id);
            if (!elm) return;

            const width = parseInt(document.getElementById('propWidth').value) || 100;
            const height = parseInt(document.getElementById('propHeight').value) || 100;

            elm.props.width = width;
            elm.props.height = height;

            const dom = document.getElementById(id);
            if (dom) {
                dom.style.width = width + 'px';
                if (elm.type !== 'line' && elm.type !== 'separator') {
                    dom.style.height = height + 'px';
                }
                // Re-render visual to update image size
                renderElementVisual(elm, dom);
            }
        }


        // --- API HELPER ---

        async function testApiConnection() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = '...';

            // Test 1: Simple GET Ping
            const res = await callApi('ping', {});

            btn.innerText = originalText;
            if (res.status === 'success') {
                alert("Success! " + (res.message || "API Connected"));
            } else {
                alert("Failed: " + (res.message || "Unknown Error") + "\n\n1. Ensure Web App is deployed as 'Anyone'.\n2. Ensure URL is correct.");
            }
        }

        // Helper to safely get value from potentially missing element
        function safeGetValue(id, fallback = '') {
            const el = document.getElementById(id);
            return el ? el.value : fallback;
        }

        async function saveForm(silent = false) {
            const btn = document.querySelector('button[onclick="saveForm()"]') || document.querySelector('.header-actions .btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            // Sync model with current UI values - ROBUSTLY
            formConfig.formName = safeGetValue('propFormName', formConfig.formName);
            formConfig.id = safeGetValue('propFormId', formConfig.id);
            formConfig.description = safeGetValue('propDescription', formConfig.description);
            formConfig.sheetUrl = safeGetValue('propSheetUrl', formConfig.sheetUrl);
            formConfig.sheetName = safeGetValue('propSheetName', formConfig.sheetName);
            formConfig.languagePrimary = safeGetValue('propLanguagePrimary', formConfig.languagePrimary);
            formConfig.languageSecondary = safeGetValue('propLanguageSecondary', formConfig.languageSecondary);

            // Sync Branding Fields
            formConfig.headerTitle = safeGetValue('propHeaderTitle', formConfig.headerTitle);
            formConfig.logoIcon = safeGetValue('propLogoIcon', formConfig.logoIcon);
            formConfig.logoUrl = safeGetValue('propLogoUrl', formConfig.logoUrl);
            formConfig.punchline = safeGetValue('propPunchline', formConfig.punchline);
            formConfig.brandingDescription = safeGetValue('propBrandingDescription', formConfig.brandingDescription);
            formConfig.footerText = safeGetValue('propFooterText', formConfig.footerText);

            const displayModeEl = document.getElementById('propDisplayMode');
            if (displayModeEl) formConfig.displayMode = displayModeEl.checked ? 'card' : 'full';

            // Sync API and Branding
            formConfig.storageEngine = safeGetValue('propStorageEngine', formConfig.storageEngine);
            formConfig.gasApiUrl = safeGetValue('propApiUrl', formConfig.gasApiUrl);
            formConfig.customDomain = safeGetValue('propCustomDomain', formConfig.customDomain);

            const schema = elements;
            const config = formConfig;
            const metadata = {
                allowedDomains: safeGetValue('propAllowedDomains', ''),
                formName: formConfig.formName,
                workspaceId: formConfig.workspaceId
            };

            // Local Fallback for Preview (Instant)
            const localData = { schema, config, metadata };
            localStorage.setItem('form_' + formConfig.id, JSON.stringify(localData));

            // Persist settings
            localStorage.setItem('storageEngine', formConfig.storageEngine);
            localStorage.setItem('gasApiUrl', formConfig.gasApiUrl);
            localStorage.setItem('customDomain', formConfig.customDomain);

            try {
                // Diagnostic Step 1
                console.log("Step 1: Calling API");
                const res = await callApi('saveForm', { formId: formConfig.id, schema, config, metadata });
                console.log("Step 2: API Finished", res);

                if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                    if (!silent) alert('Form Saved! (Check Drive/Sheet to confirm if external)');
                } else {
                    alert('Error: ' + res.message);
                }
            } catch (err) {
                console.error("Save Form Error:", err);
                alert("Save Failed (Exception): " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function openPreview() {
            // Auto-save before previewing
            const btn = document.querySelector('button[onclick="saveForm()"]');
            const originalText = btn ? btn.innerHTML : 'Save';
            if (btn) btn.innerHTML = '<span class="spinner-sm"></span> Saving...';

            try {
                await saveForm(true); // Call saveForm with a silent flag if possible
            } catch (e) {
                console.error("Auto-save failed:", e);
                // Continue anyway if user wants to see what's there
            } finally {
                if (btn) btn.innerHTML = originalText;
            }

            const apiUrl = formConfig.gasApiUrl;
            const backend = document.getElementById('propStorageEngine') ? document.getElementById('propStorageEngine').value : (formConfig.storageEngine || 'firebase');
            let previewUrl = `viewer.html?view=form&id=${formConfig.id}&backend=${backend}`;
            if (apiUrl) {
                previewUrl += `&api=${encodeURIComponent(apiUrl)}`;
            }
            window.open(previewUrl, '_blank');
        }

        function openPortalPreview() {
            openPortalWithApi(); // Reuse the same logic which is already host-safe
        }

        // --- KEYBOARD SHORTCUTS ---
        let clipboard = null;
        window.addEventListener('keydown', handleShortcuts);

        function handleShortcuts(e) {
            const tag = e.target.tagName.toLowerCase();
            const isInput = tag === 'input' || tag === 'textarea' || tag === 'select';
            if (isInput) return;

            // GROUPING (Ctrl + G)
            if ((e.ctrlKey || e.metaKey) && e.key === 'g' && !e.shiftKey) {
                e.preventDefault();
                if (selectedIds.length > 1) {
                    const newGroupId = 'grp_' + Date.now();
                    selectedIds.forEach(id => {
                        const el = elements.find(item => item.id === id);
                        if (el) el.props.groupId = newGroupId;
                    });
                }
                return;
            }

            // UNGROUP (Ctrl + Shift + G)
            if ((e.ctrlKey || e.metaKey) && e.key === 'G') {
                e.preventDefault();
                if (selectedIds.length > 0) {
                    selectedIds.forEach(id => {
                        const el = elements.find(item => item.id === id);
                        if (el && el.props.groupId) {
                            el.props.groupId = null;
                        }
                    });
                }
                return;
            }

            // DELETE
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelected();
                return;
            }

            // COPY (Ctrl + C)
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                if (selectedIds.length > 0) {
                    clipboard = selectedIds.map(id => elements.find(item => item.id === id)).filter(Boolean);
                    clipboard = JSON.parse(JSON.stringify(clipboard));
                }
                return;
            }

            // PASTE (Ctrl + V)
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                if (clipboard && Array.isArray(clipboard)) {
                    const newIds = [];
                    const groupMap = {};
                    clipboard.forEach(original => {
                        const newElm = JSON.parse(JSON.stringify(original));
                        newElm.id = 'elm_' + Date.now() + '_' + Math.floor(Math.random() * 100);
                        newElm.x += 20;
                        newElm.y += 20;
                        if (newElm.props.name) {
                            newElm.props.name = newElm.props.name.split('_copy')[0] + '_copy_' + Math.floor(Math.random() * 100);
                        }
                        if (newElm.props.groupId) {
                            if (!groupMap[newElm.props.groupId]) {
                                groupMap[newElm.props.groupId] = 'grp_' + Date.now() + '_' + Math.random();
                            }
                            newElm.props.groupId = groupMap[newElm.props.groupId];
                        }
                        elements.push(newElm);
                        renderElementDOM(newElm);
                        newIds.push(newElm.id);
                    });
                    selectedIds = newIds;
                    renderSelectionState();
                    updatePropsPanel();
                }
                return;
            }

            // DUPLICATE (Ctrl + D)
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                duplicateSelected();
                return;
            }

            // BOLD (Ctrl + B)
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                selectedIds.forEach(id => {
                    const elm = elements.find(item => item.id === id);
                    if (elm && elm.type === 'label') {
                        elm.props.isBold = !elm.props.isBold;
                        const dom = document.getElementById(id);
                        if (dom) {
                            dom.querySelector('span').style.fontWeight = elm.props.isBold ? 'bold' : 'normal';
                        }
                    }
                });
                if (selectedIds.length === 1) {
                    const chk = document.getElementById('propBold');
                    const elm = elements.find(item => item.id === selectedIds[0]);
                    if (chk && elm) chk.checked = !!elm.props.isBold;
                }
                return;
            }

            // ARROW KEYS (Nudge)
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                if (selectedIds.length > 0) {
                    e.preventDefault();
                    const shift = e.shiftKey ? 10 : 1;
                    selectedIds.forEach(id => {
                        const elm = elements.find(item => item.id === id);
                        if (!elm) return;
                        if (e.key === 'ArrowUp') elm.y -= shift;
                        if (e.key === 'ArrowDown') elm.y += shift;
                        if (e.key === 'ArrowLeft') elm.x -= shift;
                        if (e.key === 'ArrowRight') elm.x += shift;
                        const dom = document.getElementById(id);
                        if (dom) {
                            dom.style.left = elm.x + 'px';
                            dom.style.top = elm.y + 'px';
                        }
                    });
                    if (selectedIds.length === 1) {
                        const px = document.getElementById('propX');
                        const py = document.getElementById('propY');
                        const elm = elements.find(item => item.id === selectedIds[0]);
                        if (px && elm) px.value = elm.x;
                        if (py && elm) py.value = elm.y;
                    }
                }
            }
        }

        // --- LOAD MODAL LOGIC ---
        function showLoadModal() {
            document.getElementById('loadModal').style.display = 'flex';
            fetchTemplates();
        }

        function closeLoadModal() {
            document.getElementById('loadModal').style.display = 'none';
        }

        async function fetchTemplates() {
            const listEl = document.getElementById('templateList');
            const loadingEl = document.getElementById('modalLoading');
            listEl.innerHTML = '';
            loadingEl.classList.remove('hidden');
            try {
                const res = await callApi('listTemplates', {});
                loadingEl.classList.add('hidden');

                // Standardize: Handle both flat array and {status, templates} formats
                let data = Array.isArray(res) ? res : (res.templates || []);

                console.log("ðŸ“Š UI Data Package:", data);

                if (data.length > 0) {
                    renderTemplates(data);
                } else if (res.status === 'error') {
                    alert("âŒ Firebase Error: " + res.message);
                    listEl.innerHTML = `<li>Error: ${res.message}</li>`;
                } else {
                    renderTemplates([]);
                }
            } catch (err) {
                loadingEl.classList.add('hidden');
                listEl.innerHTML = `<li>Connection error.</li>`;
            }
        }

        function renderTemplates(templates) {
            const listEl = document.getElementById('templateList');
            if (!templates || templates.length === 0) {
                listEl.innerHTML = '<li style="padding: 1rem; color: #999;">No saved forms found.</li>';
                return;
            }
            listEl.innerHTML = templates.map(t => `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: default;">
                    <div onclick="loadForm('${t.id}')" style="flex: 1; cursor: pointer;">
                        <div style="font-weight: bold;">${t.name}</div>
                        ${t.description ? `<div style="font-size: 0.8rem; color: #666; margin: 2px 0;">${t.description}</div>` : ''}
                        <div style="font-size: 0.7rem; color: #999;">ID: ${t.id}</div>
                        <div style="font-size: 0.7rem; color: #999;">Updated: ${new Date(t.lastUpdated).toLocaleString()}</div>
                    </div>
                    <button onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                            style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 10px;"
                            onmouseover="this.style.background='#b91c1c'" 
                            onmouseout="this.style.background='#dc2626'">
                        ðŸ—‘ï¸ Delete
                    </button>
                </li>
            `).join('');
        }

        async function loadForm(id) {
            closeLoadModal();
            const loader = document.getElementById('loader');
            if (loader) loader.classList.remove('hidden');
            try {
                const res = await callApi('getForm', { formId: id });
                if (res.status === 'success') {
                    applyLoadedForm(id, res.schema, res.config, res.metadata);
                } else {
                    const data = localStorage.getItem('form_' + id);
                    if (data) {
                        const parsed = JSON.parse(data);
                        applyLoadedForm(id, parsed.schema, parsed.config, parsed.metadata);
                    } else {
                        alert('Error: ' + res.message);
                    }
                }
            } catch (err) {
                alert('Could not load form.');
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        function applyLoadedForm(id, schema, config, metadata) {
            metadata = metadata || {};
            formConfig.id = id;
            formConfig.formName = config.formName || id;
            formConfig.description = metadata.description || "";
            formConfig.allowedDomains = metadata.allowedDomains || "";
            formConfig.sheetUrl = config.targetSheetUrl || "";
            formConfig.sheetName = config.targetSheetName || "Form Responses";
            formConfig.language = config.language || "mr";
            formConfig.languagePrimary = config.languagePrimary || "en";
            formConfig.languageSecondary = config.languageSecondary || config.language || 'mr';
            formConfig.storageEngine = config.storageEngine || 'gas';
            formConfig.firebaseConfig = metadata.firebaseConfig || "";
            formConfig.slug = config.slug || "";
            formConfig.customDomain = config.customDomain || "";

            document.getElementById('propFormId').value = formConfig.id;
            document.getElementById('propFormName').value = formConfig.formName;
            document.getElementById('headerFormNameInput').value = formConfig.formName;
            document.getElementById('propDescription').value = formConfig.description;
            document.getElementById('propAllowedDomains').value = formConfig.allowedDomains;
            document.getElementById('propSheetUrl').value = formConfig.sheetUrl;
            document.getElementById('propSheetName').value = formConfig.sheetName;
            document.getElementById('propLanguagePrimary').value = formConfig.languagePrimary;
            document.getElementById('propLanguageSecondary').value = formConfig.languageSecondary;
            document.getElementById('propStorageEngine').value = formConfig.storageEngine;
            document.getElementById('propFirebaseConfig').value = formConfig.firebaseConfig;
            document.getElementById('fieldFormSlug').value = formConfig.slug;
            document.getElementById('propCustomDomain').value = formConfig.customDomain || "";

            // Branding Fields Population
            document.getElementById('propHeaderTitle').value = formConfig.headerTitle || '';
            document.getElementById('propLogoIcon').value = formConfig.logoIcon || 'ðŸ“';
            document.getElementById('propLogoUrl').value = formConfig.logoUrl || '';
            document.getElementById('propPunchline').value = formConfig.punchline || '';
            document.getElementById('propBrandingDescription').value = formConfig.brandingDescription || '';
            document.getElementById('propFooterText').value = formConfig.footerText || '';
            document.getElementById('propDisplayMode').checked = (formConfig.displayMode === 'card');

            updateCanvasBranding(); // Ensure canvas is updated
            if (document.getElementById('sidebarCustomDomain')) document.getElementById('sidebarCustomDomain').value = formConfig.customDomain || "";
            document.getElementById('portalSlug').value = portalConfig.slug || "";
            if (document.getElementById('sidebarPortalSlug')) document.getElementById('sidebarPortalSlug').value = portalConfig.slug || "";
            document.getElementById('headerFormId').innerText = formConfig.id;

            toggleBackendConfig();

            elements = [];
            canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());
            (schema || []).forEach(elmData => {
                elements.push(elmData);
                renderElementDOM(elmData);
            });
            selectedIds = [];
            renderSelectionState();
            updatePropsPanel();
            updateFormLanguage();
        }

        async function deleteTemplate(formId, formName) {
            if (!confirm(`Are you sure you want to DELETE this form?\n\nForm: ${formName}\nID: ${formId}\n\nThis action cannot be undone!`)) {
                return;
            }

            const loader = document.getElementById('loader');
            if (loader) loader.classList.remove('hidden');

            try {
                const res = await callApi('deleteForm', { formId: formId });

                if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                    alert(`âœ… Form "${formName}" deleted successfully!`);
                    // Refresh the template list
                    fetchTemplates();
                } else {
                    alert('âŒ Error deleting form: ' + res.message);
                }
            } catch (err) {
                alert('âŒ Failed to delete form: ' + err.message);
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        // --- EMBED MODAL LOGIC ---
        // --- PORTAL MODAL LOGIC ---
        let allTemplates = [];
        let portalConfig = { forms: [] };

        async function showPortalModal() {
            document.getElementById('portalModal').style.display = 'flex';
            document.getElementById('portalLoading').classList.remove('hidden');
            const listEl = document.getElementById('portalTemplateList');
            listEl.innerHTML = '';

            try {
                // Fetch both all templates AND current portal config
                const [res, configRes] = await Promise.all([
                    callApi('listTemplates', {}),
                    callApi('getPortalConfig', {})
                ]);

                // Standardize template response
                allTemplates = Array.isArray(res) ? res : (res.templates || []);
                portalConfig = (configRes && configRes.config) ? configRes.config : { forms: [] };

                document.getElementById('portalLoading').classList.add('hidden');
                renderPortalItems();
            } catch (err) {
                alert("Failed to load portal data.");
                closePortalModal();
            }
        }

        function closePortalModal() {
            document.getElementById('portalModal').style.display = 'none';
        }

        function renderPortalItems() {
            const listEl = document.getElementById('portalTemplateList');
            if (!allTemplates || allTemplates.length === 0) {
                listEl.innerHTML = '<li style="padding:1rem; color:#999;">No saved forms found to include.</li>';
                return;
            }

            listEl.innerHTML = allTemplates.map(t => {
                const portalItem = portalConfig.forms.find(pf => pf.id === t.id);
                const isSelected = !!portalItem;
                const order = portalItem ? portalItem.order : 0;

                return `
                    <li style="display:flex; align-items:center; gap:1rem; cursor:default; hover:none;">
                        <input type="checkbox" class="portal-check" data-id="${t.id}" data-name="${t.name}" ${isSelected ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer;">
                        <div style="flex:1;">
                            <div style="font-weight:600;">${t.name}</div>
                            <div style="font-size:0.75rem; color:var(--text-light); text-transform:uppercase;">ID: ${t.id}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:0.8rem; color:var(--text-light);">Sort Order:</span>
                            <input type="number" class="portal-order" data-id="${t.id}" value="${order}" style="width:60px; padding:4px; border:1px solid var(--border); border-radius:4px; text-align:center;">
                        </div>
                    </li>
                `;
            }).join('');
        }

        async function refreshPortalList() {
            const listEl = document.getElementById('sidebarPortalList');
            if (!listEl) return;

            listEl.innerHTML = '<div style="color:var(--text-light); font-size:0.8rem; text-align:center; padding:2rem;">Loading forms...</div>';

            try {
                // Fetch both all templates AND current portal config
                const [templates, config] = await Promise.all([
                    callApi('listTemplates', {}),
                    callApi('getPortalConfig', {})
                ]);

                // Standardize: Handle both flat array and {status, templates} formats
                allTemplates = Array.isArray(templates) ? templates : (templates.templates || []);

                // CRITICAL FIX: Extract config correctly from either raw object (GAS) or wrapped object (Firebase)
                portalConfig = (config && config.config) ? config.config : (config || { forms: [] });

                const slugInput = document.getElementById('portalSlug');
                if (slugInput) slugInput.value = portalConfig.slug || "";
                if (document.getElementById('sidebarPortalSlug')) document.getElementById('sidebarPortalSlug').value = portalConfig.slug || "";

                const domainInput = document.getElementById('propCustomDomain');
                if (domainInput) domainInput.value = portalConfig.customDomain || formConfig.customDomain || "";
                if (document.getElementById('sidebarCustomDomain')) document.getElementById('sidebarCustomDomain').value = portalConfig.customDomain || formConfig.customDomain || "";

                console.log("ðŸ“Š Portal Source Data:", { allTemplates, portalConfig });

                if (allTemplates.length === 0) {
                    if (templates.status === 'error') {
                        alert("âŒ Portal Load Error: " + templates.message);
                    }
                    listEl.innerHTML = '<div style="color:var(--text-light); font-size:0.8rem; text-align:center; padding:2rem;">No saved forms found. Create and save forms first.</div>';
                    return;
                }

                // Render the list with checkboxes
                listEl.innerHTML = allTemplates.map(t => {
                    const portalItem = portalConfig.forms.find(pf => pf.id === t.id);
                    const isSelected = !!portalItem;
                    const order = portalItem ? portalItem.order : 0;

                    return `
                        <div class="portal-item-row" style="display:flex; align-items:center; gap:12px; background:var(--surface); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:8px; transition:all 0.2s; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                            <input type="checkbox" class="portal-check" data-id="${t.id}" data-name="${t.name}" ${isSelected ? 'checked' : ''} style="width:20px; height:20px; cursor:pointer; accent-color:var(--primary);">
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:700; font-size:0.85rem; color:var(--text-main);">${t.name}</div>
                                <div style="font-size:0.7rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.025em; margin-top:2px;">ID: ${t.id}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:6px;">
                                <span style="font-size:0.75rem; color:var(--text-light); font-weight:600;">Order:</span>
                                <input type="number" class="portal-order" data-id="${t.id}" value="${order}" style="width:48px; height:32px; padding:4px; border:2px solid var(--surface-alt); background:var(--surface-alt); border-radius:8px; text-align:center; font-size:0.9rem; font-weight:700; outline:none; transition:all 0.2s; color:var(--primary);" onfocus="this.style.borderColor='var(--primary)'; this.style.background='white';">
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error("Failed to load portal data:", err);
                listEl.innerHTML = '<div style="color:#dc2626; font-size:0.8rem; text-align:center; padding:2rem;">âŒ Failed to load forms. Check your API connection.</div>';
            }
        }

        async function savePortalSettings() {
            const checks = document.querySelectorAll('.portal-check');
            const selectedForms = [];

            checks.forEach((chk) => {
                if (chk.checked) {
                    const id = chk.dataset.id;
                    const name = chk.dataset.name;
                    const orderInput = document.querySelector(`.portal-order[data-id="${id}"]`);
                    selectedForms.push({
                        id: id,
                        name: name,
                        order: parseInt(orderInput.value) || 0
                    });
                }
            });

            selectedForms.sort((a, b) => a.order - b.order);

            const btn = document.getElementById('btnSavePortal');
            if (btn) {
                btn.disabled = true;
                btn.innerText = 'Saving...';
            }

            const slug = document.getElementById('portalSlug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
            const res = await callApi('savePortalConfig', {
                config: {
                    forms: selectedForms,
                    layout: 'sidebar',
                    slug: slug,
                    customDomain: document.getElementById('propCustomDomain').value.trim(),
                    gasApiUrl: document.getElementById('propApiUrl').value || formConfig.gasApiUrl,
                    storageEngine: document.getElementById('propStorageEngine').value || formConfig.storageEngine
                }
            });

            if (btn) {
                btn.disabled = false;
                btn.innerText = 'Save Portal Collection';
            }

            if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                localStorage.setItem('gasApiUrl', document.getElementById('propApiUrl').value || formConfig.gasApiUrl);
                localStorage.setItem('storageEngine', document.getElementById('propStorageEngine').value || formConfig.storageEngine);
                alert("Portal Collection Updated Successfully!");
            } else {
                alert("Error: " + res.message);
            }
        }



        function getBrandedBase() {
            const customBase = (formConfig.customDomain || "").trim();
            const currentHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '').replace(/\/$/, '');
            if (!customBase) return currentHost;
            return customBase.replace(/\/$/, '');
        }

        function checkDomainWarning(val) {
            const warning = document.getElementById('domainWarning');
            if (val.includes('://') || val.includes('.com') || val.includes('.in')) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        function syncPortalSlug(val, targetId = 'portalSlug') {
            const target = document.getElementById(targetId);
            if (target) target.value = val;
            portalConfig.slug = val;
        }

        function syncCustomDomain(val, targetId = 'propCustomDomain') {
            const target = document.getElementById(targetId);
            if (target) target.value = val;
            formConfig.customDomain = val;
            portalConfig.customDomain = val;
        }

        async function showEmbedModal() {
            const modal = document.getElementById('embedModal');
            const area = document.getElementById('embedCodeArea');
            const directArea = document.getElementById('directLinkArea');
            if (!modal || !area || !directArea) return;

            // Populate Configuration Fields located in this modal
            if (document.getElementById('propSheetUrl')) document.getElementById('propSheetUrl').value = formConfig.sheetUrl || "";
            if (document.getElementById('propSheetName')) document.getElementById('propSheetName').value = formConfig.sheetName || "Form Responses";
            if (document.getElementById('propCustomDomain')) document.getElementById('propCustomDomain').value = formConfig.customDomain || "";

            const apiInput = document.getElementById('propApiUrl');
            const currentApiSUrl = (apiInput ? apiInput.value.trim() : "") || formConfig.gasApiUrl;
            const currentEngine = document.getElementById('propStorageEngine') ? document.getElementById('propStorageEngine').value : (formConfig.storageEngine || 'firebase');

            // Only enforce GAS URL if we are actually using GAS engine
            if (currentEngine === 'gas' && (!currentApiSUrl || currentApiSUrl.length < 20)) {
                // Warning only - do not block
                console.warn("âš ï¸ GAS API URL missing but engine is set to GAS.");
            }

            const currentHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '').replace(/\/$/, '');
            const brandedBase = getBrandedBase();

            const portalSlug = document.getElementById('portalSlug').value.trim();
            const engine = document.getElementById('propStorageEngine').value || formConfig.storageEngine || 'gas';
            const backendParam = `&backend=${engine}`;

            let workingLink = `${currentHost}/portal.html?p=${portalSlug || 'none'}&api=${encodeURIComponent(currentApiSUrl)}${backendParam}`;
            let professionalLink = `${brandedBase}/portal.html?p=${portalSlug || 'none'}`;

            directArea.value = professionalLink;
            area.value = `<!-- MULTI-FORM PORTAL EMBED -->\n<iframe src="${workingLink}" width="100%" height="800" frameborder="0"></iframe>`;

            modal.style.display = 'flex';
        }

        function closeEmbedModal() {
            const modal = document.getElementById('embedModal');
            if (modal) modal.style.display = 'none';
        }

        function copyEmbedCode() {
            const area = document.getElementById('embedCodeArea');
            if (area) {
                area.select();
                document.execCommand('copy');
                alert('âœ… Embed code copied to clipboard!');
            }
        }

        function copyDirectLink() {
            const area = document.getElementById('directLinkArea');
            if (area) {
                area.select();
                document.execCommand('copy');
                alert('âœ… Share Link copied to clipboard!');
            }
        }

        // --- RULER LOGIC ---
        function initRulers() {
            const rulerTop = document.getElementById('rulerTop');
            const rulerLeft = document.getElementById('rulerLeft');
            if (!rulerTop || !rulerLeft) return;

            rulerTop.innerHTML = '';
            rulerLeft.innerHTML = '';

            for (let i = 0; i <= 800; i += 10) {
                const tick = document.createElement('div');
                tick.className = 'tick tick-h ' + (i % 100 === 0 ? 'major' : 'minor');
                tick.style.left = i + 'px';
                if (i % 100 === 0) tick.innerHTML = `<span>${i}</span>`;
                rulerTop.appendChild(tick);
            }
            for (let i = 0; i <= 1123; i += 10) {
                const tick = document.createElement('div');
                tick.className = 'tick tick-v ' + (i % 100 === 0 ? 'major' : 'minor');
                tick.style.top = i + 'px';
                if (i % 100 === 0) tick.innerHTML = `<span>${i}</span>`;
                rulerLeft.appendChild(tick);
            }
        }

        // --- UTILS ---
        function swapAllLabels() {
            if (!confirm("Are you sure you want to swap ALL labels? This will move existing 'Secondary' text into 'Primary' slots for all elements.")) return;

            elements.forEach(elm => {
                const temp = elm.props.label || '';
                elm.props.label = elm.props.labelRegional || '';
                elm.props.labelRegional = temp;

                const dom = document.getElementById(elm.id);
                if (dom) renderElementVisual(elm, dom);
            });

            // Swap dropdown values too
            const L1 = document.getElementById('propLanguagePrimary').value;
            const L2 = document.getElementById('propLanguageSecondary').value;
            document.getElementById('propLanguagePrimary').value = L2;
            document.getElementById('propLanguageSecondary').value = L1;

            updateFormLanguage();
            alert("Labels swapped successfully!");
        }

        function createNewForm() {
            if (elements.length > 0) {
                if (!confirm("Start a new form? Any unsaved changes on the current canvas will be lost.")) return;
            }

            // Reset Config
            formConfig = {
                id: 'Form_' + Date.now(),
                formName: 'New Form',
                description: '',
                allowedDomains: '',
                sheetUrl: '',
                sheetName: 'Form Responses',
                language: 'mr',
                languagePrimary: 'en',
                languageSecondary: 'mr',
                languageSecondary: 'mr',
                gasApiUrl: document.getElementById('propApiUrl').value || formConfig.gasApiUrl,
                workspaceId: formConfig.workspaceId, // Preserve Workspace Context
                storageEngine: 'firebase' // Default to Firebase for Templates (System DB)
            };
        };

        // Reset Elements
        elements = [];
        canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());

        // Reset UI
        document.getElementById('propFormId').value = formConfig.id;
        document.getElementById('propFormName').value = formConfig.formName;
        document.getElementById('headerFormNameInput').value = formConfig.formName;
        document.getElementById('propDescription').value = '';
        document.getElementById('propAllowedDomains').value = '';
        document.getElementById('propSheetUrl').value = '';
        document.getElementById('propSheetName').value = 'Form Responses';
        document.getElementById('headerFormId').innerText = formConfig.id;

        renderSelectionState();
        showGlobalProps();
        updateFormLanguage();

        alert("New Form Created! You can start adding elements.");
        }



        function openPortalWithApi() {
            const apiInput = document.getElementById('propApiUrl');
            const currentApiUrl = (apiInput ? apiInput.value.trim() : "") || formConfig.gasApiUrl;

            if (!currentApiUrl || currentApiUrl.length < 20) {
                alert("âš ï¸ Please enter your Google Script API URL in Settings first!");
                showGlobalProps();
                return;
            }

            localStorage.setItem('gasApiUrl', currentApiUrl);
            formConfig.gasApiUrl = currentApiUrl;

            // PREVIEW MODE: Always use current host (github.io)
            const currentHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '').replace(/\/$/, '');
            const backend = document.getElementById('propStorageEngine') ? document.getElementById('propStorageEngine').value : (formConfig.storageEngine || 'firebase');
            const portalUrl = currentHost + '/portal.html?api=' + encodeURIComponent(currentApiUrl) + '&backend=' + backend;

            console.log("ðŸš€ Previewing Portal:", portalUrl);
            window.open(portalUrl, '_blank');
        }

        function copyPortalLink() {
            const currentApiUrl = document.getElementById('propApiUrl').value.trim() || formConfig.gasApiUrl;
            if (!currentApiUrl) return;

            const currentHost = window.location.href.split('?')[0].split('#')[0].replace('index.html', '').replace(/\/$/, '');
            const portalUrl = currentHost + '/portal.html?api=' + encodeURIComponent(currentApiUrl);

            navigator.clipboard.writeText(portalUrl).then(() => {
                alert("âœ… Preview Link copied! Use this for testing.");
            });
        }



        function goToWorkspace() {
            if (formConfig.workspaceId) {
                window.location.href = `workspace.html?id=${formConfig.workspaceId}`;
            } else {
                window.location.href = `dashboard.html`;
            }
        }

        initRulers();
    </script>
</body>

</html>