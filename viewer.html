<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Viewer</title>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            margin: 0;
            background: #ffffff;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            width: 100%;
            background: #2563eb;
            /* Contextual Blue */
            color: white;
            padding: 0 32px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 50;
            flex-shrink: 0;
        }

        .brand {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* FORM LAYOUTS */
        #form-container {
            width: 100%;
            max-width: 900px;
            min-height: calc(100vh - 60px);
            background: white;
            position: relative;
            transform-origin: top center;
            padding: 40px;
            box-sizing: border-box;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
        }

        /* CARD MODE */
        body.mode-card {
            background-color: #f3f4f6;
            /* Light gray background */
            padding: 40px 20px;
        }

        body.mode-card #form-container {
            max-width: 700px;
            min-height: auto;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 40px;
        }

        /* BRANDING HEADER */
        .branding-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f3f4f6;
            text-align: center;
        }

        .branding-logo {
            font-size: 3rem;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .branding-logo img {
            max-width: 180px;
            max-height: 80px;
            object-fit: contain;
        }

        .branding-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #111827;
            margin: 0 0 8px 0;
            line-height: 1.2;
        }

        .branding-desc {
            font-size: 0.95rem;
            color: #4b5563;
            margin: 0;
            line-height: 1.5;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }


        /* Hide shadow and extra padding if in iframe */
        @media (min-width: 800px) {
            body.is-embedded {
                padding: 0;
                background: #ffffff;
                /* Force white even in iframe */
            }

            body.is-embedded #form-container {
                box-shadow: none;
                border: none;
            }
        }

        .canvas-element {
            position: absolute;
        }

        .field-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
        }

        .field-input {
            width: 200px;
            /* Default, overridden by schema if needed */
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .field-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        /* Transliteration Hint */
        .trans-hint {
            font-size: 10px;
            color: #2563eb;
            margin-top: 2px;
        }

        .lang-mr {
            font-weight: 400;
            color: #555;
            font-size: 0.9em;
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        /* Actions */
        .action-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 50;
        }

        .btn {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: #1d4ed8;
        }

        @media screen and (max-width: 768px) {
            header {
                padding: 0 16px;
                height: 56px;
            }

            #form-container {
                width: 100%;
                max-width: 100%;
                min-height: auto;
                padding: 24px 16px;
                border: none;
                transform: none !important;
                margin-top: 0 !important;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .canvas-element {
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                max-width: 400px;
                margin-bottom: 24px !important;
            }

            .submit-container {
                position: relative !important;
                top: 0 !important;
                left: 0 !important;
                margin-top: 20px;
                width: 100%;
                padding-bottom: 40px;
            }

            .btn-submit {
                width: 100%;
                justify-content: center;
            }
        }

        /* --- PORTAL STYLES --- */
        .portal-wrapper {
            display: none;
            /* Shown via JS */
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #f3f4f6;
        }

        .portal-sidebar {
            width: 260px;
            height: 100%;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .portal-sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 700;
            color: #2563eb;
            font-size: 1.1rem;
        }

        .portal-nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .portal-nav-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            color: #4b5563;
            font-weight: 500;
        }

        .portal-nav-item:hover {
            background: #eff6ff;
            color: #2563eb;
        }

        .portal-nav-item.active {
            background: #eff6ff;
            color: #2563eb;
            border-left: 4px solid #2563eb;
        }

        .portal-main {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .portal-wrapper {
                flex-direction: column;
            }

            .portal-sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .portal-nav-list {
                display: flex;
                overflow-x: auto;
            }

            .portal-nav-item {
                white-space: nowrap;
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>

<body>
    <header id="mainHeader">
        <div class="brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span id="headerFormName">Form Viewer</span>
        </div>
        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase;">
            SECURE FORM
        </div>
    </header>

    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top: 15px; color: #666; font-size: 0.9em;">Loading Form Engine...</p>
    </div>

    <!-- PORTAL WRAPPER (Split Screen) -->
    <div id="portal-wrapper" class="portal-wrapper">
        <aside class="portal-sidebar">
            <div class="portal-sidebar-header">Forms Collection</div>
            <ul id="portal-nav-list" class="portal-nav-list">
                <!-- Portal Menu Items -->
            </ul>
        </aside>
        <main id="portal-main" class="portal-main">
            <!-- Form container will be moved here in portal mode -->
        </main>
    </div>

    <!-- SINGLE FORM CONTAINER -->
    <div id="form-container"></div>

    <div class="action-bar">
        <button class="btn" onclick="submitData()">Submit Form</button>
    </div>

    <script>
        // GLOBAL ERROR HANDLER
        window.onerror = function (msg, url, line, col, error) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = "position:fixed; top:0; left:0; width:100%; padding:20px; background:white; color:red; border-bottom:2px solid red; z-index:99999; font-family:monospace;";
            errDiv.innerText = "JS ERROR: " + msg + "\nLine: " + line;
            document.body.appendChild(errDiv);
            return false;
        };

        // CLIENT LOGIC
        let formSchema = [];
        let formConfig = {};

        // 1. Get Params
        const urlParams = new URLSearchParams(window.location.search);
        let formId = "<?= typeof formId !== 'undefined' ? formId : '' ?>";
        if (formId.includes('?')) formId = '';
        if (!formId) formId = urlParams.get('id');

        // GAS API URL detection (can be passed via URL or stored)
        let gasApiUrl = urlParams.get('api') || localStorage.getItem('gasApiUrl') || '';
        const backend = urlParams.get('backend') || localStorage.getItem('storageEngine') || 'firebase'; // Default to firebase now

        // FIREBASE INITIALIZATION
        const firebaseConfig = {
            apiKey: "AIzaSyCVnpnzTntQbfkCe_P09wSswjCKB8XnUcM",
            authDomain: "buildform-e7d3b.firebaseapp.com",
            projectId: "buildform-e7d3b",
            storageBucket: "buildform-e7d3b.firebasestorage.app",
            messagingSenderId: "1010258612784",
            appId: "1:1010258612784:web:4c076c1df63e98e19b93f5",
            measurementId: "G-L217Q3WM0G"
        };

        if (backend === 'firebase') {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                console.log("üî• Firebase Initialized");
            } catch (err) {
                console.error("‚ùå Firebase Init Error:", err);
            }
        }

        // 2. API Helper
        async function callApi(action, payload) {
            if (backend === 'firebase') {
                try {
                    const db = firebase.firestore();
                    if (action === 'getForm') {
                        const doc = await db.collection('forms').doc(payload.formId).get();
                        if (!doc.exists) throw new Error('Form not found in Firestore');
                        return { status: 'success', ...doc.data() };
                    } else if (action === 'getPortalConfig') {
                        const doc = await db.collection('config').doc('portal').get();
                        if (!doc.exists) throw new Error('Portal config not found');
                        return { status: 'success', config: doc.data() };
                    }
                    // For submitForm, we still use GAS as primary for Sheets integration, 
                    // or we could add Firestore storage later.
                } catch (err) {
                    console.error("üî• Firestore Fetch Error:", err);
                    // Fallback to GAS if Firestore fails? 
                    // No, let's keep it clean.
                    return { status: 'error', message: 'Firestore Error: ' + err.message };
                }
            }

            if (typeof google !== 'undefined' && google.script) {
                return new Promise((resolve, reject) => {
                    const run = google.script.run;
                    if (action === 'getForm') run.withSuccessHandler(resolve).withFailureHandler(reject).getForm(payload.formId);
                    else if (action === 'getPortalConfig') run.withSuccessHandler(resolve).withFailureHandler(reject).getPortalConfig();
                    else if (action === 'submitForm') run.withSuccessHandler(resolve).withFailureHandler(reject).submitForm(payload.formId, payload.formData);
                    else if (action === 'translateText') run.withSuccessHandler(resolve).withFailureHandler(reject).translateText(payload.text, payload.targetLang);
                });
            }

            if (!gasApiUrl) {
                return { status: 'error', message: 'GAS API URL not found. Use ?api=[URL] if external.' };
            }

            try {
                // Ensure URL is clean and specifically remove any accidental whitespace
                let url = gasApiUrl.trim().replace(/\/$/, "");
                const sep = url.includes('?') ? '&' : '?';

                if (action === 'getForm') {
                    const res = await fetch(`${url}${sep}action=getForm&id=${payload.formId}`, { redirect: 'follow' });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } else if (action === 'getPortalConfig') {
                    const res = await fetch(`${url}${sep}action=getPortalConfig`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } else if (action === 'translateText') {
                    const fetchUrl = `${url}${sep}action=translateText&text=${encodeURIComponent(payload.text)}&targetLang=${payload.targetLang}&sourceLang=${payload.sourceLang}`;
                    const res = await fetch(fetchUrl, { redirect: 'follow' });
                    if (!res.ok) throw new Error(`Network Error: ${res.status}`);
                    const json = await res.json();
                    if (json.status === 'error') throw new Error(json.message);
                    return json;
                } else {
                    // POST actions (submitForm)
                    const res = await fetch(url, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...payload }),
                        redirect: 'follow'
                    });
                    return { status: 'success', message: 'Payload sent successfully.' };
                }
            } catch (err) {
                console.error("API Call failed:", err);
                let msg = err.message || err.toString();
                if (msg.includes("Failed to fetch")) {
                    msg = "Network Error: Could not connect to Google Script. (Are you logged into multiple Google accounts?)";
                }
                return { status: 'error', message: msg };
            }
        }

        // 3. Security (Referrer Check)
        function checkReferrer(allowedDomains) {
            // If field is empty, security is DISABLED (for testing)
            if (!allowedDomains || allowedDomains.trim() === '') return true;

            const domainList = allowedDomains.split(',').map(d => d.trim().toLowerCase()).filter(d => d !== '');
            if (domainList.length === 0) return true;

            const referrer = document.referrer;
            if (!referrer) {
                // If direct access (like builder preview), we allow during testing
                return true;
            }

            try {
                const refHost = new URL(referrer).hostname.toLowerCase();
                // Check if referrer domain is in our allowed list
                return domainList.some(d => refHost.includes(d));
            } catch (e) {
                return false;
            }
        }

        // 4. Fetch Schema
        // 4. Loader Control
        function setLoader(show, text) {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            if (loaderText && text) loaderText.innerText = text;
            loader.classList.toggle('hidden', !show);
        }

        // 5. Portal Logic
        async function initPortal() {
            try {
                console.log('üöÄ Initializing Portal Mode...');
                setLoader(true, "Loading Portal...");

                const portalWrapper = document.getElementById('portal-wrapper');
                const mainArea = document.getElementById('portal-main');
                const formArea = document.getElementById('form-container');

                if (!portalWrapper || !mainArea || !formArea) {
                    console.error('‚ùå Portal elements not found in DOM');
                    alert('Portal Error: Required elements not found');
                    return;
                }

                portalWrapper.style.display = 'flex';
                mainArea.appendChild(formArea); // Move form into portal

                // OPTIMIZED: Fetch config + first form in ONE request
                console.log('üì° Fetching portal configuration...');
                const response = await callApi('loadPortal', { formId: formId }); // formId might be null, that's optional

                if (response.status !== 'success') {
                    throw new Error(response.message || "Failed to load portal data");
                }

                // Set Config & Title
                formConfig = response.config || {};
                const name = formConfig.formName || response.metadata?.formName || "Dynamic Form";
                document.getElementById('headerFormName').innerText = name;
                document.title = name + " | Portal";

                const config = response.config;
                console.log('‚úÖ Portal config received:', config);

                const navList = document.getElementById('portal-nav-list');

                if (!config || !config.forms || config.forms.length === 0) {
                    console.warn('‚ö†Ô∏è No forms configured in portal');
                    navList.innerHTML = '<li class="portal-nav-item" style="padding:2rem; text-align:center; color:#999;">No forms available. Please configure forms in the Portal Designer.</li>';
                    setLoader(false);
                    return;
                }

                console.log(`üìã Rendering ${config.forms.length} forms in sidebar`);
                navList.innerHTML = config.forms.map(f => `
                    <li class="portal-nav-item" data-id="${f.id}" onclick="loadPortalForm('${f.id}')">
                        ${f.name}
                    </li>
                `).join('');

                // Render the initial form if provided in the batch response
                if (response.initialForm && response.initialForm.status === 'success') {
                    console.log('üìÑ Rendering initial form from batch response');
                    renderForm(response.initialForm);

                    // Highlight sidebar item
                    const activeId = response.initialForm.formId || response.initialForm.id; // Fallback
                    document.querySelectorAll('.portal-nav-item').forEach(li => {
                        li.classList.toggle('active', li.dataset.id === activeId);
                    });
                } else if (config.forms.length > 0) {
                    // Fallback to manual load if batch failed for some reason
                    loadPortalForm(config.forms[0].id);
                } else {
                    setLoader(false);
                }

            } catch (error) {
                console.error('‚ùå Portal initialization failed:', error);
                setLoader(false);
                document.getElementById('form-container').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #64748b;">
                        <p>Unable to load portal. Please try again later.</p>
                    </div>
                `;
            }
        }

        async function loadPortalForm(id) {
            // Update UI
            document.querySelectorAll('.portal-nav-item').forEach(li => {
                li.classList.toggle('active', li.dataset.id === id);
            });

            formId = id;
            setLoader(true, "Loading Form...");

            const res = await callApi('getForm', { formId: id });
            setLoader(false);

            if (res.status === 'success') {
                const metadata = res.metadata || {};
                if (!checkReferrer(metadata.allowedDomains)) {
                    document.getElementById('form-container').innerHTML = `
                        <div style="padding: 50px; text-align: center; font-family: sans-serif; background: #fff;">
                            <h3 style="color: #dc3545;">Domain Not Authorized</h3>
                            <p>This form collection is restricted.</p>
                        </div>
                    `;
                    return;
                }
                renderForm(res);
            } else {
                console.error('‚ùå Form load failed:', res.message);
                document.getElementById('form-container').innerHTML = `
                    <div style="padding: 50px; text-align: center; font-family: sans-serif; background: #fff;">
                        <h3 style="color: #64748b;">‚ö†Ô∏è Service Unavailable</h3>
                        <p style="color: #666;">This resource is currently not available.</p>
                    </div>
                `;
            }
        }

        // 6. Init Sequence
        window.onload = async function () {
            const isPortal = urlParams.get('view') === 'portal';

            if (isPortal) {
                initPortal();
                return;
            } else {
                // CLEAN UP: Remove portal structures in single form mode
                const portalWrapper = document.getElementById('portal-wrapper');
                if (portalWrapper) portalWrapper.remove();

                // OPTIONAL: Hide header for a truly independent view
                if (urlParams.get('view') === 'form') {
                    const header = document.getElementById('mainHeader');
                    if (header) header.style.display = 'none';
                    // Optional: show a small close button or return button?
                }
            }

            if (!formId || formId.trim() === "") {
                document.getElementById('form-container').innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No Form ID provided.</div>';
                setLoader(false);
                return;
            }
            formId = formId.trim();

            setLoader(true, "Loading Form...");
            const res = await callApi('getForm', { formId });
            setLoader(false);

            if (res.status === 'success') {
                const metadata = res.metadata || {};
                if (!checkReferrer(metadata.allowedDomains)) {
                    document.body.innerHTML = `
                        <div style="padding: 50px; text-align: center; font-family: sans-serif; background: #fff; height: 100vh;">
                            <h2 style="color: #dc3545;">Domain Not Authorized</h2>
                            <p>This form is restricted.</p>
                        </div>
                    `;
                    return;
                }
                renderForm(res);
            } else {
                // Local fallback
                const saved = localStorage.getItem('form_' + formId);
                if (saved) {
                    renderForm({ status: 'success', ...JSON.parse(saved) });
                } else {
                    document.getElementById('form-container').innerHTML = `<div style="padding:40px; text-align:center; color:#dc3545;">${res.message}</div>`;
                }
            }
        };

        function renderForm(response) {
            const loader = document.getElementById('loader');

            if (response.status !== 'success') {
                loader.innerHTML = `<p style="color:red">Error: ${response.message}</p>`;
                return;
            }

            formSchema = response.schema;
            formConfig = response.config;
            const container = document.getElementById('form-container');

            // Apply Layout Mode
            if (formConfig.displayMode === 'card') {
                document.body.classList.add('mode-card');
            } else {
                document.body.classList.remove('mode-card');
            }

            container.innerHTML = '';

            // Render Branding Header
            if (formConfig.headerTitle || formConfig.logoIcon || formConfig.logoUrl || formConfig.brandingDescription) {
                const bHeader = document.createElement('div');
                bHeader.className = 'branding-header';

                let logoHtml = '';
                if (formConfig.logoUrl) {
                    logoHtml = `<div class="branding-logo"><img src="${formConfig.logoUrl}" alt="Logo"></div>`;
                } else if (formConfig.logoIcon) {
                    logoHtml = `<div class="branding-logo">${formConfig.logoIcon}</div>`;
                }

                bHeader.innerHTML = `
                    ${logoHtml}
                    ${formConfig.headerTitle ? `<h1 class="branding-title">${formConfig.headerTitle}</h1>` : ''}
                    ${formConfig.punchline ? `<p class="branding-punchline" style="font-size: 1.1rem; color: #6b7280; margin: -5px 0 10px 0; font-style: italic;">${formConfig.punchline}</p>` : ''}
                    ${formConfig.brandingDescription ? `<p class="branding-desc">${formConfig.brandingDescription.replace(/\n/g, '<br>')}</p>` : ''}
                `;
                container.appendChild(bHeader);
            }


            const langCodeSecondary = formConfig.languageSecondary || formConfig.language || 'mr';
            const langCodePrimary = formConfig.languagePrimary || 'en';

            formSchema.forEach(elm => {
                const div = document.createElement('div');
                div.className = 'canvas-element';
                div.style.left = elm.x + 'px';
                div.style.top = elm.y + 'px';

                // Helper to get regional label
                const regLabelHtml = elm.props.labelRegional
                    ? ` <span class="lang-${langCodeSecondary}" style="font-weight:400; color:#555">/ ${elm.props.labelRegional}</span>`
                    : '';

                // --- APPLY UNIVERSAL STYLING ---
                if (elm.props.textColor) div.style.color = elm.props.textColor;
                if (elm.props.backgroundColor && elm.props.backgroundColor !== 'transparent') {
                    div.style.backgroundColor = elm.props.backgroundColor;
                }
                if (elm.props.borderColor) {
                    div.style.borderColor = elm.props.borderColor;
                }
                if (elm.props.opacity !== undefined && elm.props.opacity < 100) {
                    div.style.opacity = elm.props.opacity / 100;
                }
                if (elm.props.padding) div.style.padding = elm.props.padding + 'px';
                if (elm.props.shadow) {
                    div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                }

                // Render Input
                // Render Input
                if (['text', 'number', 'date', 'file', 'email', 'textarea', 'paragraph', 'dropdown', 'counter', 'image', 'repeater'].includes(elm.type)) {
                    let inputHtml = "";
                    const req = elm.props.required ? 'required' : '';
                    const placeholder = elm.props.placeholder || "";
                    const name = elm.props.name;

                    if (elm.type === 'dropdown') {
                        const options = (elm.props.options || "").split(',').map(o => o.trim()).filter(o => o);
                        inputHtml = `
                            <select class="field-input" name="${name}" ${req}>
                                <option value="">${placeholder || 'Select...'}</option>
                                ${options.map(o => `<option value="${o}">${o}</option>`).join('')}
                            </select>
                        `;
                    } else if (elm.type === 'textarea' || elm.type === 'paragraph') {
                        inputHtml = `
                            <textarea class="field-input" name="${name}" ${req} placeholder="${placeholder}" 
                                      style="height:${elm.type === 'paragraph' ? '120px' : '60px'}; resize:vertical;"></textarea>
                        `;
                    } else if (elm.type === 'counter') {
                        inputHtml = `
                            <div style="display:flex; align-items:center; gap:5px;">
                                <button type="button" class="btn" style="padding:5px 15px; background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1;" onclick="this.nextElementSibling.stepDown()">-</button>
                                <input type="number" class="field-input" name="${name}" value="0" style="width:80px; text-align:center;">
                                <button type="button" class="btn" style="padding:5px 15px; background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1;" onclick="this.previousElementSibling.stepUp()">+</button>
                            </div>
                        `;
                    } else if (elm.type === 'image') {
                        inputHtml = `
                            <div class="image-upload-wrapper" style="border:1px solid #d1d5db; padding:10px; border-radius:4px;">
                                <input type="file" class="field-input" name="${name}" accept="image/*" ${req} 
                                       style="border:none; padding:0;" onchange="previewImg(this)">
                                <div class="img-preview" style="margin-top:10px; display:none;">
                                    <img src="" style="max-width:100%; max-height:150px; border-radius:4px;">
                                </div>
                            </div>
                        `;
                    } else if (elm.type === 'repeater') {
                        inputHtml = `
                            <div class="repeater-wrapper" id="rep-${elm.id}" data-name="${name}">
                                <div class="repeater-items">
                                    <div class="repeater-item" style="display:flex; gap:5px; margin-bottom:5px;">
                                        <input type="text" class="field-input repeater-input" placeholder="Item 1" style="flex:1;">
                                        <button type="button" class="btn" style="padding:0 10px; background:#fee2e2; color:#b91c1c;" onclick="removeRepItem(this)">√ó</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline" style="width:100%; font-size:12px; padding:5px; background:#eff6ff; color:#2563eb; border:1px dashed #2563eb;" 
                                        onclick="addRepItem('${elm.id}')">+ Add More Items</button>
                            </div>
                        `;
                    } else {
                        inputHtml = `
                            <input type="${elm.type}" 
                                   class="field-input" 
                                   name="${name}" 
                                   ${req}
                                   placeholder="${placeholder}"
                                   data-translatable="${elm.props.translatable || false}">
                        `;
                    }

                    div.innerHTML = `
                        <label class="field-label">${elm.props.label}${regLabelHtml}${elm.props.required ? ' *' : ''}</label>
                        ${inputHtml}
                        ${elm.props.translatable ? '<div class="trans-hint" id="hint-' + elm.id + '"></div>' : ''}
                    `;

                    // Add Translation Listener
                    if (elm.props.translatable) {
                        const input = div.querySelector('input');
                        input.addEventListener('blur', (e) => handleTranslation(e, elm.id));
                    }

                } else if (elm.type === 'heading') {
                    div.style.textAlign = elm.props.align || 'left';
                    const tag = elm.props.headingLevel || 'h2';
                    div.innerHTML = `<${tag} style="margin:0; width: 300px; border-bottom: 2px solid #333">${elm.props.label}${regLabelHtml}</${tag}>`;
                } else if (elm.type === 'rect') {
                    div.style.width = elm.props.width + 'px';
                    div.style.height = elm.props.height + 'px';
                    // Apply Visual Props
                    div.style.border = `${elm.props.strokeWidth || 2}px ${elm.props.borderStyle || 'solid'} #000`;
                    div.style.borderRadius = (elm.props.borderRadius || 0) + 'px';
                    div.style.pointerEvents = 'none'; // Prevent blocking inputs
                } else if (elm.type === 'line') {
                    div.style.width = '200px';
                    // Line Implementation: Height = Wrapper, Border = Visual
                    div.style.height = (elm.props.strokeWidth || 2) + 'px';
                    div.style.borderTop = `${elm.props.strokeWidth || 2}px ${elm.props.borderStyle || 'solid'} #000`;
                    div.style.pointerEvents = 'none'; // Prevent blocking inputs
                } else if (elm.type === 'label') {
                    div.style.textAlign = elm.props.align || 'left';
                    const weight = elm.props.isBold ? 'bold' : 'normal';
                    const size = elm.props.fontSize || 14;
                    div.innerHTML = `<span style="font-weight:${weight}; font-size:${size}px">${elm.props.label}${regLabelHtml}</span>`;
                }

                container.appendChild(div);
            });

            // Render Footer
            if (formConfig.footerText) {
                const bFooter = document.createElement('div');
                bFooter.className = 'branding-footer';
                bFooter.style.marginTop = '40px';
                bFooter.style.paddingTop = '20px';
                bFooter.style.borderTop = '1px solid #f3f4f6';
                bFooter.style.textAlign = 'center';
                bFooter.style.color = '#9ca3af';
                bFooter.style.fontSize = '0.85rem';
                bFooter.innerHTML = formConfig.footerText;
                container.appendChild(bFooter);
            }

            loader.style.display = 'none';
        }

        // 3. Helpers for New Fields
        function previewImg(input) {
            const preview = input.parentElement.querySelector('.img-preview');
            const img = preview.querySelector('img');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addRepItem(elmId) {
            const wrapper = document.querySelector(`#rep-${elmId} .repeater-items`);
            const div = document.createElement('div');
            div.className = 'repeater-item';
            div.style.cssText = 'display:flex; gap:5px; margin-bottom:5px;';
            div.innerHTML = `
                <input type="text" class="field-input repeater-input" style="flex:1;">
                <button type="button" class="btn" style="padding:0 10px; background:#fee2e2; color:#b91c1c;" onclick="removeRepItem(this)">√ó</button>
            `;
            wrapper.appendChild(div);
        }

        function removeRepItem(btn) {
            const items = btn.closest('.repeater-items');
            if (items.children.length > 1) {
                btn.closest('.repeater-item').remove();
            }
        }

        // 4. Translation Handler
        async function handleTranslation(e, elmId) {
            const text = e.target.value;
            if (!text) return;

            const hint = document.getElementById('hint-' + elmId);
            hint.innerText = 'Translating...';
            hint.style.color = '#888';

            const sourceLang = formConfig.languagePrimary || 'en';
            const targetLang = formConfig.languageSecondary || formConfig.language || 'mr';

            try {
                const res = await callApi('translateText', { text, sourceLang, targetLang });
                if (res.status === 'success' && res.translated) {
                    e.target.dataset.translated = res.translated;
                    hint.innerText = res.translated;
                    hint.style.color = '#2563eb'; // Blue for success
                } else {
                    // If we got an error object or missing status
                    throw new Error(res.message || 'Translation failed. Ensure GAS script is re-deployed as "New Version".');
                }
            } catch (err) {
                console.error("Translation Error:", err);
                // Extract useful message parts
                let msg = err.message || "Unknown error";
                if (msg.includes("Unexpected token") || msg.includes("is not valid JSON")) {
                    msg = "Invalid Server Response. Did you re-deploy GAS?";
                }
                hint.innerText = "Error: " + msg;
                hint.style.color = '#dc3545'; // Red for error
            }
        }

        // 4. Submit
        async function submitData() {
            const inputs = document.querySelectorAll('input, select, textarea');
            const formData = {};
            let valid = true;

            const targetLang = (formConfig.language || 'mr').toUpperCase();

            inputs.forEach(input => {
                if (input.required && !input.value) {
                    input.style.border = '1px solid red';
                    valid = false;
                } else {
                    input.style.border = '';
                }

                if (input.name) {
                    try {
                        const schema = formSchema || [];
                        const elm = schema.find(e => e.props && e.props.name === input.name);
                        const header = (elm && elm.props && elm.props.label) ? elm.props.label : input.name;

                        // HANDLE REPEATER (Multiple inputs with same parent/context)
                        const repeater = input.closest('.repeater-wrapper');
                        if (repeater) {
                            const name = repeater.dataset.name;
                            const items = Array.from(repeater.querySelectorAll('.repeater-input'))
                                .map(i => i.value.trim())
                                .filter(v => v);
                            formData[header] = items.join(' | '); // Joined for spreadsheet
                        } else if (input.type === 'file') {
                            formData[header] = input.files[0] ? input.files[0].name : '';
                        } else {
                            formData[header] = input.value;
                        }

                        if (input.dataset.translated) {
                            const regHeader = (elm && elm.props && elm.props.labelRegional)
                                ? elm.props.labelRegional
                                : `${header} (${targetLang})`;
                            formData[regHeader] = input.dataset.translated;
                        }
                    } catch (mapErr) {
                        console.error("Mapping error for input:", input.name, mapErr);
                        // Extreme fallback: always include the raw value
                        formData[input.name] = input.value;
                    }
                }
            });

            if (!valid) {
                alert("Please fill all required fields");
                return;
            }

            formData['Form_ID'] = formId;

            const btn = document.querySelector('.action-bar .btn');
            const orgText = btn.innerText;
            btn.innerText = 'Submitting...';
            btn.disabled = true;

            const res = await callApi('submitForm', { formId, formData });

            btn.innerText = orgText;
            btn.disabled = false;
            if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                alert('Submitted Successfully!');
            } else {
                alert('Error: ' + res.message);
            }
        }

    </script>
</body>

</html>