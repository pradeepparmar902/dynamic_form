<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Viewer</title>
    <style>
        body {
            margin: 0;
            background: #f3f4f6;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #form-container {
            width: 794px;
            min-height: 1123px;
            background: white;
            position: relative;
            transform-origin: top center;
            margin-bottom: 2rem;
        }

        /* Hide shadow and extra padding if in iframe */
        @media (min-width: 800px) {
            body.is-embedded {
                padding: 0;
                background: transparent;
            }

            body.is-embedded #form-container {
                box-shadow: none;
            }
        }

        .canvas-element {
            position: absolute;
        }

        .field-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
        }

        .field-input {
            width: 200px;
            /* Default, overridden by schema if needed */
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .field-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        /* Transliteration Hint */
        .trans-hint {
            font-size: 10px;
            color: #2563eb;
            margin-top: 2px;
        }

        .lang-mr {
            font-weight: 400;
            color: #555;
            font-size: 0.9em;
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        /* Actions */
        .action-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 50;
        }

        .btn {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: #1d4ed8;
        }

        @media screen and (max-width: 820px) {
            #form-container {
                transform: scale(0.9);
                margin-top: -100px;
                /* Counteract empty space from scale */
            }
        }

        @media screen and (max-width: 480px) {
            #form-container {
                transform: scale(0.45);
                margin-top: -300px;
            }
        }

        /* --- PORTAL STYLES --- */
        .portal-wrapper {
            display: none;
            /* Shown via JS */
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #f3f4f6;
        }

        .portal-sidebar {
            width: 260px;
            height: 100%;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .portal-sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 700;
            color: #2563eb;
            font-size: 1.1rem;
        }

        .portal-nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .portal-nav-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            color: #4b5563;
            font-weight: 500;
        }

        .portal-nav-item:hover {
            background: #eff6ff;
            color: #2563eb;
        }

        .portal-nav-item.active {
            background: #eff6ff;
            color: #2563eb;
            border-left: 4px solid #2563eb;
        }

        .portal-main {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .portal-wrapper {
                flex-direction: column;
            }

            .portal-sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .portal-nav-list {
                display: flex;
                overflow-x: auto;
            }

            .portal-nav-item {
                white-space: nowrap;
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top: 15px; color: #666; font-size: 0.9em;">Loading Form Engine...</p>
    </div>

    <!-- PORTAL WRAPPER (Split Screen) -->
    <div id="portal-wrapper" class="portal-wrapper">
        <aside class="portal-sidebar">
            <div class="portal-sidebar-header">Forms Collection</div>
            <ul id="portal-nav-list" class="portal-nav-list">
                <!-- Portal Menu Items -->
            </ul>
        </aside>
        <main id="portal-main" class="portal-main">
            <!-- Form container will be moved here in portal mode -->
        </main>
    </div>

    <!-- SINGLE FORM CONTAINER -->
    <div id="form-container"></div>

    <div class="action-bar">
        <button class="btn" onclick="submitData()">Submit Form</button>
    </div>

    <script>
        // GLOBAL ERROR HANDLER
        window.onerror = function (msg, url, line, col, error) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = "position:fixed; top:0; left:0; width:100%; padding:20px; background:white; color:red; border-bottom:2px solid red; z-index:99999; font-family:monospace;";
            errDiv.innerText = "JS ERROR: " + msg + "\nLine: " + line;
            document.body.appendChild(errDiv);
            return false;
        };

        // CLIENT LOGIC
        let formSchema = [];
        let formConfig = {};

        // 1. Get Params
        const urlParams = new URLSearchParams(window.location.search);
        let formId = "<?= typeof formId !== 'undefined' ? formId : '' ?>";
        if (formId.includes('?')) formId = '';
        if (!formId) formId = urlParams.get('id');

        // GAS API URL detection (can be passed via URL or stored)
        let gasApiUrl = urlParams.get('api') || localStorage.getItem('gasApiUrl') || '';

        // MOCK FOR LOCAL DEV
        if (!formId && window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
            formId = prompt("Local Dev Mode: Enter Form ID to load (Save one in Admin first)", "101");
        }

        // 2. API Helper
        async function callApi(action, payload) {
            if (typeof google !== 'undefined' && google.script) {
                return new Promise((resolve, reject) => {
                    const run = google.script.run;
                    if (action === 'getForm') run.withSuccessHandler(resolve).withFailureHandler(reject).getForm(payload.formId);
                    else if (action === 'getPortalConfig') run.withSuccessHandler(resolve).withFailureHandler(reject).getPortalConfig();
                    else if (action === 'submitForm') run.withSuccessHandler(resolve).withFailureHandler(reject).submitForm(payload.formId, payload.formData);
                    else if (action === 'translateText') run.withSuccessHandler(resolve).withFailureHandler(reject).translateText(payload.text, payload.targetLang);
                });
            }

            if (!gasApiUrl) {
                return { status: 'error', message: 'GAS API URL not found. Use ?api=[URL] if external.' };
            }

            try {
                // Ensure URL is clean and specifically remove any accidental whitespace
                let url = gasApiUrl.trim().replace(/\/$/, "");
                const sep = url.includes('?') ? '&' : '?';

                if (action === 'getForm') {
                    const res = await fetch(`${url}${sep}action=getForm&id=${payload.formId}`, { redirect: 'follow' });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } else if (action === 'getPortalConfig') {
                    const res = await fetch(`${url}${sep}action=getPortalConfig`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } else if (action === 'translateText') {
                    const fetchUrl = `${url}${sep}action=translateText&text=${encodeURIComponent(payload.text)}&targetLang=${payload.targetLang}&sourceLang=${payload.sourceLang}`;
                    const res = await fetch(fetchUrl, { redirect: 'follow' });
                    if (!res.ok) throw new Error(`Network Error: ${res.status}`);
                    const json = await res.json();
                    if (json.status === 'error') throw new Error(json.message);
                    return json;
                } else {
                    // POST actions (submitForm)
                    const res = await fetch(url, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action, ...payload }),
                        redirect: 'follow'
                    });
                    return { status: 'success', message: 'Payload sent successfully.' };
                }
            } catch (err) {
                console.error("API Call failed:", err);
                let msg = err.message || err.toString();
                if (msg.includes("Failed to fetch")) {
                    msg = "Network Error: Could not connect to Google Script. (Are you logged into multiple Google accounts?)";
                }
                return { status: 'error', message: msg };
            }
        }

        // 3. Security (Referrer Check)
        function checkReferrer(allowedDomains) {
            // If field is empty, security is DISABLED (for testing)
            if (!allowedDomains || allowedDomains.trim() === '') return true;

            const domainList = allowedDomains.split(',').map(d => d.trim().toLowerCase()).filter(d => d !== '');
            if (domainList.length === 0) return true;

            const referrer = document.referrer;
            if (!referrer) {
                // If direct access (like builder preview), we allow during testing
                return true;
            }

            try {
                const refHost = new URL(referrer).hostname.toLowerCase();
                // Check if referrer domain is in our allowed list
                return domainList.some(d => refHost.includes(d));
            } catch (e) {
                return false;
            }
        }

        // 4. Fetch Schema
        // 4. Loader Control
        function setLoader(show, text) {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            if (loaderText && text) loaderText.innerText = text;
            loader.classList.toggle('hidden', !show);
        }

        // 5. Portal Logic
        async function initPortal() {
            try {
                console.log('üöÄ Initializing Portal Mode...');
                setLoader(true, "Loading Portal...");

                const portalWrapper = document.getElementById('portal-wrapper');
                const mainArea = document.getElementById('portal-main');
                const formArea = document.getElementById('form-container');

                if (!portalWrapper || !mainArea || !formArea) {
                    console.error('‚ùå Portal elements not found in DOM');
                    alert('Portal Error: Required elements not found');
                    return;
                }

                portalWrapper.style.display = 'flex';
                mainArea.appendChild(formArea); // Move form into portal

                console.log('üì° Fetching portal configuration...');
                const config = await callApi('getPortalConfig', {});
                console.log('‚úÖ Portal config received:', config);

                const navList = document.getElementById('portal-nav-list');

                if (!config || !config.forms || config.forms.length === 0) {
                    console.warn('‚ö†Ô∏è No forms configured in portal');
                    navList.innerHTML = '<li class="portal-nav-item" style="padding:2rem; text-align:center; color:#999;">No forms available. Please configure forms in the Portal Designer.</li>';
                    setLoader(false);
                    return;
                }

                console.log(`üìã Rendering ${config.forms.length} forms in sidebar`);
                navList.innerHTML = config.forms.map(f => `
                    <li class="portal-nav-item" data-id="${f.id}" onclick="loadPortalForm('${f.id}')">
                        ${f.name}
                    </li>
                `).join('');

                // Load first form by default if none selected
                if (!formId && config.forms.length > 0) {
                    console.log('üìÑ Loading first form:', config.forms[0].name);
                    loadPortalForm(config.forms[0].id);
                } else if (formId) {
                    console.log('üìÑ Loading specified form:', formId);
                    loadPortalForm(formId);
                } else {
                    setLoader(false);
                }
            } catch (error) {
                console.error('‚ùå Portal initialization failed:', error);
                setLoader(false);
                alert('Portal Error: ' + error.message + '\n\nCheck browser console for details.');
            }
        }

        async function loadPortalForm(id) {
            // Update UI
            document.querySelectorAll('.portal-nav-item').forEach(li => {
                li.classList.toggle('active', li.dataset.id === id);
            });

            formId = id;
            setLoader(true, "Loading Form...");

            const res = await callApi('getForm', { formId: id });
            setLoader(false);

            if (res.status === 'success') {
                const metadata = res.metadata || {};
                if (!checkReferrer(metadata.allowedDomains)) {
                    document.getElementById('form-container').innerHTML = `
                        <div style="padding: 50px; text-align: center; font-family: sans-serif; background: #fff;">
                            <h3 style="color: #dc3545;">Domain Not Authorized</h3>
                            <p>This form collection is restricted.</p>
                        </div>
                    `;
                    return;
                }
                renderForm(res);
            } else {
                console.error('‚ùå Form load failed:', res.message);
                document.getElementById('form-container').innerHTML = `
                    <div style="padding: 50px; text-align: center; font-family: sans-serif; background: #fff;">
                        <h3 style="color: #dc3545;">‚ö†Ô∏è Form Not Found</h3>
                        <p style="margin: 20px 0;"><strong>Form ID:</strong> ${id}</p>
                        <p style="color: #666;">This form hasn't been saved to your Google backend yet.</p>
                        <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 500px; text-align: left;">
                            <h4 style="margin-top: 0; color: #9a3412;">üìã How to fix this:</h4>
                            <ol style="color: #666; line-height: 1.8;">
                                <li>Open your <strong>Form Builder</strong></li>
                                <li>Switch to the <strong>"ELEMENTS"</strong> tab</li>
                                <li>Click <strong>"Load Form"</strong> and select this form</li>
                                <li>Click <strong>"Save Form"</strong> to store it in Google</li>
                                <li>Return to the <strong>"Portal View"</strong> tab</li>
                                <li>Click <strong>"Refresh Forms List"</strong></li>
                                <li>Re-save your portal collection</li>
                            </ol>
                        </div>
                        <p style="font-size: 0.9em; color: #999;">Error: ${res.message}</p>
                    </div>
                `;
            }
        }

        // 6. Init Sequence
        window.onload = async function () {
            const isPortal = urlParams.get('view') === 'portal';

            if (isPortal) {
                initPortal();
                return;
            }

            if (!formId) {
                document.getElementById('form-container').innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No Form ID provided.</div>';
                setLoader(false);
                return;
            }

            setLoader(true, "Loading Form...");
            const res = await callApi('getForm', { formId });
            setLoader(false);

            if (res.status === 'success') {
                const metadata = res.metadata || {};
                if (!checkReferrer(metadata.allowedDomains)) {
                    document.body.innerHTML = `
                        <div style="padding: 50px; text-align: center; font-family: sans-serif; background: #fff; height: 100vh;">
                            <h2 style="color: #dc3545;">Domain Not Authorized</h2>
                            <p>This form is restricted.</p>
                        </div>
                    `;
                    return;
                }
                renderForm(res);
            } else {
                // Local fallback
                const saved = localStorage.getItem('form_' + formId);
                if (saved) {
                    renderForm({ status: 'success', ...JSON.parse(saved) });
                } else {
                    document.getElementById('form-container').innerHTML = `<div style="padding:40px; text-align:center; color:#dc3545;">${res.message}</div>`;
                }
            }
        };

        function renderForm(response) {
            const loader = document.getElementById('loader');

            if (response.status !== 'success') {
                loader.innerHTML = `<p style="color:red">Error: ${response.message}</p>`;
                return;
            }

            formSchema = response.schema;
            formConfig = response.config;
            const container = document.getElementById('form-container');
            container.innerHTML = '';

            const langCodeSecondary = formConfig.languageSecondary || formConfig.language || 'mr';
            const langCodePrimary = formConfig.languagePrimary || 'en';

            formSchema.forEach(elm => {
                const div = document.createElement('div');
                div.className = 'canvas-element';
                div.style.left = elm.x + 'px';
                div.style.top = elm.y + 'px';

                // Helper to get regional label
                const regLabelHtml = elm.props.labelRegional
                    ? ` <span class="lang-${langCodeSecondary}" style="font-weight:400; color:#555">/ ${elm.props.labelRegional}</span>`
                    : '';

                // Render Input
                if (elm.type === 'text' || elm.type === 'number' || elm.type === 'date' || elm.type === 'file') {
                    div.innerHTML = `
                        <label class="field-label">${elm.props.label}${regLabelHtml}${elm.props.required ? ' *' : ''}</label>
                        <input type="${elm.type}" 
                               class="field-input" 
                               name="${elm.props.name}" 
                               ${elm.props.required ? 'required' : ''}
                               data-translatable="${elm.props.translatable || false}">
                        ${elm.props.translatable ? '<div class="trans-hint" id="hint-' + elm.id + '"></div>' : ''}
                    `;

                    // Add Translation Listener
                    if (elm.props.translatable) {
                        const input = div.querySelector('input');
                        input.addEventListener('blur', (e) => handleTranslation(e, elm.id));
                    }

                } else if (elm.type === 'heading') {
                    div.style.textAlign = elm.props.align || 'left';
                    const tag = elm.props.headingLevel || 'h2';
                    div.innerHTML = `<${tag} style="margin:0; width: 300px; border-bottom: 2px solid #333">${elm.props.label}${regLabelHtml}</${tag}>`;
                } else if (elm.type === 'rect') {
                    div.style.width = elm.props.width + 'px';
                    div.style.height = elm.props.height + 'px';
                    // Apply Visual Props
                    div.style.border = `${elm.props.strokeWidth || 2}px ${elm.props.borderStyle || 'solid'} #000`;
                    div.style.borderRadius = (elm.props.borderRadius || 0) + 'px';
                    div.style.pointerEvents = 'none'; // Prevent blocking inputs
                } else if (elm.type === 'line') {
                    div.style.width = '200px';
                    // Line Implementation: Height = Wrapper, Border = Visual
                    div.style.height = (elm.props.strokeWidth || 2) + 'px';
                    div.style.borderTop = `${elm.props.strokeWidth || 2}px ${elm.props.borderStyle || 'solid'} #000`;
                    div.style.pointerEvents = 'none'; // Prevent blocking inputs
                } else if (elm.type === 'label') {
                    div.style.textAlign = elm.props.align || 'left';
                    const weight = elm.props.isBold ? 'bold' : 'normal';
                    const size = elm.props.fontSize || 14;
                    div.innerHTML = `<span style="font-weight:${weight}; font-size:${size}px">${elm.props.label}${regLabelHtml}</span>`;
                }

                container.appendChild(div);
            });

            loader.style.display = 'none';
        }

        // 3. Translation Handler
        async function handleTranslation(e, elmId) {
            const text = e.target.value;
            if (!text) return;

            const hint = document.getElementById('hint-' + elmId);
            hint.innerText = 'Translating...';
            hint.style.color = '#888';

            const sourceLang = formConfig.languagePrimary || 'en';
            const targetLang = formConfig.languageSecondary || formConfig.language || 'mr';

            try {
                const res = await callApi('translateText', { text, sourceLang, targetLang });
                if (res.status === 'success' && res.translated) {
                    e.target.dataset.translated = res.translated;
                    hint.innerText = res.translated;
                    hint.style.color = '#2563eb'; // Blue for success
                } else {
                    // If we got an error object or missing status
                    throw new Error(res.message || 'Translation failed. Ensure GAS script is re-deployed as "New Version".');
                }
            } catch (err) {
                console.error("Translation Error:", err);
                // Extract useful message parts
                let msg = err.message || "Unknown error";
                if (msg.includes("Unexpected token") || msg.includes("is not valid JSON")) {
                    msg = "Invalid Server Response. Did you re-deploy GAS?";
                }
                hint.innerText = "Error: " + msg;
                hint.style.color = '#dc3545'; // Red for error
            }
        }

        // 4. Submit
        async function submitData() {
            const inputs = document.querySelectorAll('input, select, textarea');
            const formData = {};
            let valid = true;

            const targetLang = (formConfig.language || 'mr').toUpperCase();

            inputs.forEach(input => {
                if (input.required && !input.value) {
                    input.style.border = '1px solid red';
                    valid = false;
                } else {
                    input.style.border = '';
                }

                if (input.name) {
                    try {
                        // Safe mapping with fallback
                        const schema = formSchema || [];
                        const elm = schema.find(e => e.props && e.props.name === input.name);

                        // Priority 1: Label, Priority 2: input.name
                        const header = (elm && elm.props && elm.props.label) ? elm.props.label : input.name;

                        formData[header] = input.value;

                        if (input.dataset.translated) {
                            const regHeader = (elm && elm.props && elm.props.labelRegional)
                                ? elm.props.labelRegional
                                : `${header} (${targetLang})`;
                            formData[regHeader] = input.dataset.translated;
                        }
                    } catch (mapErr) {
                        console.error("Mapping error for input:", input.name, mapErr);
                        // Extreme fallback: always include the raw value
                        formData[input.name] = input.value;
                    }
                }
            });

            if (!valid) {
                alert("Please fill all required fields");
                return;
            }

            formData['Form_ID'] = formId;

            const btn = document.querySelector('.action-bar .btn');
            const orgText = btn.innerText;
            btn.innerText = 'Submitting...';
            btn.disabled = true;

            const res = await callApi('submitForm', { formId, formData });

            btn.innerText = orgText;
            btn.disabled = false;
            if (res.status === 'success' || (res.message && res.message.includes('sent'))) {
                alert('Submitted Successfully!');
            } else {
                alert('Error: ' + res.message);
            }
        }

    </script>
</body>

</html>